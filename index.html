<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VELLORA Enterprise Market Survey</title>
    
    <!-- PWA Manifest Meta -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- REACT & REACT DOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE COMPAT (v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- PDF GENERATION LIBS (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- CUSTOM STYLES for Sliders & Scrollbars -->
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Custom Slider Styling */
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(0,0,0,0.1);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: currentColor; /* Uses text color of parent */
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
        }

        /* Animation Classes */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
        /*******************************************************
         * 0. CONFIG & CONSTANTS
         *******************************************************/
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
            authDomain: "vellora-3828d.firebaseapp.com",
            projectId: "vellora-3828d",
            storageBucket: "vellora-3828d.firebasestorage.app",
            messagingSenderId: "1045366360458",
            appId: "1:1045366360458:web:c9de51b7942bd743d9a073",
            measurementId: "G-WLKMJNBJTP"
        };

        const THEMES = {
            corporate: { name: 'Corporate Light', bg: 'bg-slate-50', card: 'bg-white', text: 'text-slate-800', accent: 'bg-blue-600', accentText: 'text-white', border: 'border-slate-200', input: 'bg-white text-slate-900' },
            midnight: { name: 'Midnight Dark', bg: 'bg-slate-900', card: 'bg-slate-800', text: 'text-slate-100', accent: 'bg-blue-500', accentText: 'text-white', border: 'border-slate-700', input: 'bg-slate-900 text-white' },
            forest: { name: 'Forest Rain', bg: 'bg-emerald-50', card: 'bg-white', text: 'text-emerald-900', accent: 'bg-emerald-600', accentText: 'text-white', border: 'border-emerald-200', input: 'bg-white text-emerald-900' },
            obsidian: { name: 'Obsidian (OLED)', bg: 'bg-black', card: 'bg-black', text: 'text-gray-100', accent: 'bg-white', accentText: 'text-black', border: 'border-gray-700', input: 'bg-gray-900 text-white placeholder-gray-400' },
            sunset: { name: 'Sunset', bg: 'bg-orange-50', card: 'bg-white', text: 'text-orange-900', accent: 'bg-orange-500', accentText: 'text-white', border: 'border-orange-200', input: 'bg-white text-orange-900' },
            royal: { name: 'Royal', bg: 'bg-purple-50', card: 'bg-white', text: 'text-purple-900', accent: 'bg-purple-600', accentText: 'text-white', border: 'border-purple-200', input: 'bg-white text-purple-900' },
            oceanic: { name: 'Oceanic', bg: 'bg-cyan-50', card: 'bg-white', text: 'text-cyan-900', accent: 'bg-cyan-600', accentText: 'text-white', border: 'border-cyan-200', input: 'bg-white text-cyan-900' },
            luxury: { name: 'Luxury', bg: 'bg-gray-900', card: 'bg-gray-800', text: 'text-amber-100', accent: 'bg-amber-500', accentText: 'text-gray-900', border: 'border-amber-500/30', input: 'bg-gray-900 text-amber-50' },
            berry: { name: 'Berry', bg: 'bg-pink-50', card: 'bg-white', text: 'text-pink-900', accent: 'bg-pink-600', accentText: 'text-white', border: 'border-pink-200', input: 'bg-white text-pink-900' },
            slate: { name: 'Slate', bg: 'bg-gray-100', card: 'bg-white', text: 'text-gray-800', accent: 'bg-gray-600', accentText: 'text-white', border: 'border-gray-300', input: 'bg-white text-gray-800' },
        };

        const INITIAL_MASTER_DATA = {
            businessTypes: ["Kirana / General Store", "Supermarket", "Restaurant / Hotel", "Corporate Office", "Gym / Fitness", "Hospital / Clinic", "Educational Inst."],
            brands: ["Bisleri", "Kinley", "Aquafina", "Bailley", "Local Brand"],
            bottleSizes: ["250ml", "500ml", "1L", "2L", "5L", "10L", "20L"],
            problems: ["Late Delivery", "Leaking Bottles", "Inconsistent Taste", "High Price", "Rude Behavior", "No Bill provided"],
            distributors: ["Direct Company", "Local Vendor", "Wholesaler"],
            whiteLabelPurposes: ["Brand Building", "Customer Loyalty", "Event / Function", "Resale Profit"],
            footfallRanges: ["0-50", "51-150", "151-300", "300+"],
            willingToPayAmounts: ["1", "2", "3", "5", "10"]
        };

        /*******************************************************
         * 1. HELPERS
         *******************************************************/
        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });

        const formatDate = (isoString) => {
            if (!isoString) return '';
            const d = new Date(isoString);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' });
        };

        // CSV Export Helper
        const convertToCSV = (data) => {
            if (!data || !data.length) return '';
            
            const flattenRow = (row) => {
                const { buyingPrice, sellingPrice, profitPerBottle, gps, ...rest } = row;
                const flat = { ...rest, lat: gps?.lat || '', lng: gps?.lng || '' };
                
                if (buyingPrice) {
                    Object.keys(buyingPrice).forEach(key => {
                        flat[`Buying_${key}`] = buyingPrice[key];
                    });
                }
                if (sellingPrice) {
                    Object.keys(sellingPrice).forEach(key => {
                        flat[`Selling_${key}`] = sellingPrice[key];
                    });
                }
                 if (profitPerBottle) {
                    Object.keys(profitPerBottle).forEach(key => {
                        flat[`Profit_${key}`] = profitPerBottle[key];
                    });
                }
                return flat;
            };

            const flatData = data.map(flattenRow);
            const headers = Array.from(new Set(flatData.flatMap(Object.keys)));
            
            const csvRows = [
                headers.join(','), 
                ...flatData.map(row => headers.map(fieldName => JSON.stringify(row[fieldName] || '', replacer = null, space = 0)).join(','))
            ];
            return csvRows.join('\n');
        };

        // PDF Generator Helper
        const generatePDF = (survey) => {
            if (!window.jspdf) {
                alert("PDF library not loaded. Please try again in a moment.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Branding & Header
            doc.setFontSize(22);
            doc.setTextColor(41, 128, 185); // Blue
            doc.text("VELLORA", 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Market Survey Report", 14, 26);
            
            // Business Details
            doc.setFontSize(16);
            doc.setTextColor(0);
            doc.text(survey.businessName || "Unnamed Business", 14, 40);
            
            doc.setFontSize(11);
            doc.setTextColor(80);
            doc.text(`Type: ${survey.businessType || '-'}`, 14, 48);
            doc.text(`Date: ${new Date(survey.timestamp).toLocaleString()}`, 14, 54);
            doc.text(`Contact: ${survey.contactName || '-'} (${survey.contactMobile || '-'})`, 14, 60);
            doc.text(`Location: ${survey.locationArea || '-'}`, 14, 66);
            
            if (survey.gps) {
                 doc.text(`GPS: ${survey.gps.lat}, ${survey.gps.lng}`, 14, 72);
                 doc.setTextColor(41, 128, 185);
                 // Changed from "dir" (direction) to "q" (query/pin) to ensure it points to the location
                 doc.textWithLink("Open in Google Maps", 14, 78, { url: `https://www.google.com/maps?q=${survey.gps.lat},${survey.gps.lng}` });
            }

            doc.setTextColor(0);

            // Pricing Data Table
            const rows = [];
            if (survey.brands) {
                survey.brands.forEach(b => {
                    if (survey.bottleSizes) {
                        survey.bottleSizes.forEach(s => {
                            const k = `${b}|${s}`;
                            if (survey.buyingPrice && survey.buyingPrice[k]) {
                                rows.push([
                                    b,
                                    s,
                                    survey.buyingPrice[k] || '-',
                                    survey.sellingPrice?.[k] || '-',
                                    survey.profitPerBottle?.[k] || '-'
                                ]);
                            }
                        });
                    }
                });
            }

            if (rows.length > 0) {
                doc.autoTable({
                    startY: 85,
                    head: [['Brand', 'Size', 'Buy (INR)', 'Sell (INR)', 'Profit']],
                    body: rows,
                    theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185] },
                    styles: { fontSize: 10 }
                });
            } else {
                 doc.text("No pricing data recorded.", 14, 90);
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Generated by Vellora Enterprise App', 14, doc.internal.pageSize.height - 10);
            }

            doc.save(`Survey_${survey.businessName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
        };

        /*******************************************************
         * 2. ICONS (Lucide Style SVGs)
         *******************************************************/
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            BarChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            WifiOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            Map: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
        };

        /*******************************************************
         * 3. DATA LAYER (CONTEXT & FIREBASE)
         *******************************************************/
        
        // Theme Context
        const ThemeContext = React.createContext();

        // Main App Context
        const AppContext = React.createContext();

        // Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-red-50 text-red-900">
                            <h2 className="text-2xl font-bold mb-4">Something went wrong.</h2>
                            <p className="mb-4 text-sm">{this.state.error && this.state.error.toString()}</p>
                            <button onClick={() => window.location.reload()} className="px-6 py-3 bg-red-600 text-white rounded-lg shadow">Reload App</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const AppProvider = ({ children }) => {
            const [user, setUser] = React.useState(null);
            const [syncCode, setSyncCode] = React.useState(localStorage.getItem('vellora_syncCode') || 'MAIN');
            const [surveys, setSurveys] = React.useState([]);
            const [masterData, setMasterData] = React.useState(INITIAL_MASTER_DATA);
            const [outbox, setOutbox] = React.useState([]);
            const [isOnline, setIsOnline] = React.useState(navigator.onLine);
            const [themeKey, setThemeKey] = React.useState(localStorage.getItem('vellora_theme') || 'corporate');
            const [hideSyncBox, setHideSyncBox] = React.useState(localStorage.getItem('vellora_hideSyncBox') === 'true');

            // --- Theme Effect ---
            React.useEffect(() => {
                localStorage.setItem('vellora_theme', themeKey);
            }, [themeKey]);

            const currentTheme = THEMES[themeKey] || THEMES.corporate;

            // --- Init Firebase ---
            React.useEffect(() => {
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                
                // Auth
                firebase.auth().onAuthStateChanged(u => {
                    if (u) setUser(u);
                    else firebase.auth().signInAnonymously();
                });

                // Online/Offline Listeners
                const handleOnline = () => { setIsOnline(true); flushOutbox(); };
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                // Load Local Data
                loadLocalData();

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // --- Data Sync Logic ---
            React.useEffect(() => {
                localStorage.setItem('vellora_syncCode', syncCode);
                localStorage.setItem('vellora_hideSyncBox', hideSyncBox);
                
                if (!user) return;
                
                // Firestore Listeners
                const db = firebase.firestore();
                
                // 1. Master Data Listener
                const unsubscribeMaster = db.collection('artifacts').doc(syncCode).collection('settings').doc('masterData')
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const remoteData = doc.data();
                            setMasterData(prev => {
                                const newData = { ...prev, ...remoteData };
                                localStorage.setItem(`vellora_${syncCode}_master`, JSON.stringify(newData));
                                return newData;
                            });
                        } else {
                            // Init master data if missing
                            doc.ref.set(INITIAL_MASTER_DATA);
                        }
                    });

                // 2. Surveys Listener
                const unsubscribeSurveys = db.collection('artifacts').doc(syncCode).collection('data')
                    .onSnapshot(snapshot => {
                        const remoteSurveys = [];
                        snapshot.forEach(doc => remoteSurveys.push(doc.data()));
                        
                        setSurveys(prev => {
                            // Merge strategy: Remote wins if conflict, but keep local optimistics not yet synced
                            const merged = [...remoteSurveys];
                            
                            // Check local outbox to see if we have pending surveys
                            // Simple strategy here: just replace local cache with remote source of truth for simplicity in this constraints
                            // Real app would merge strictly based on timestamp
                            
                            localStorage.setItem(`vellora_${syncCode}_surveys`, JSON.stringify(merged));
                            return merged;
                        });
                    });

                return () => {
                    unsubscribeMaster();
                    unsubscribeSurveys();
                };

            }, [user, syncCode]);

            const loadLocalData = () => {
                const localSurveys = localStorage.getItem(`vellora_${syncCode}_surveys`);
                if (localSurveys) {
                     try {
                        const parsed = JSON.parse(localSurveys);
                        if (Array.isArray(parsed)) setSurveys(parsed);
                     } catch(e) { console.error("Error parsing local surveys", e); }
                }

                const localMaster = localStorage.getItem(`vellora_${syncCode}_master`);
                if (localMaster) {
                    try {
                        const parsed = JSON.parse(localMaster);
                        if (parsed) setMasterData(parsed);
                    } catch(e) { console.error("Error parsing master", e); }
                }

                const localOutbox = localStorage.getItem(`vellora_${syncCode}_outbox`);
                if (localOutbox) {
                    try {
                        const parsed = JSON.parse(localOutbox);
                        if (Array.isArray(parsed)) setOutbox(parsed);
                    } catch(e) { console.error("Error parsing outbox", e); }
                }
            };

            const addToOutbox = (action, payload) => {
                const newItem = { id: generateUUID(), action, payload, timestamp: new Date().toISOString() };
                const newOutbox = [...outbox, newItem];
                setOutbox(newOutbox);
                localStorage.setItem(`vellora_${syncCode}_outbox`, JSON.stringify(newOutbox));
                
                // Optimistic UI Update
                if (action === 'ADD_SURVEY') {
                    const newSurveyList = [payload, ...surveys];
                    setSurveys(newSurveyList);
                    localStorage.setItem(`vellora_${syncCode}_surveys`, JSON.stringify(newSurveyList));
                } else if (action === 'DELETE_SURVEY') {
                     const newSurveyList = surveys.filter(s => s.id !== payload.id);
                     setSurveys(newSurveyList);
                     localStorage.setItem(`vellora_${syncCode}_surveys`, JSON.stringify(newSurveyList));
                } else if (action === 'UPDATE_MASTER') {
                    setMasterData(payload); // payload is full new master object
                    localStorage.setItem(`vellora_${syncCode}_master`, JSON.stringify(payload));
                }

                if (navigator.onLine) flushOutbox(newOutbox);
            };

            const flushOutbox = async (currentOutbox = outbox) => {
                if (!currentOutbox.length) return;
                const db = firebase.firestore();
                const remaining = [];

                for (const item of currentOutbox) {
                    try {
                        if (item.action === 'ADD_SURVEY') {
                            await db.collection('artifacts').doc(syncCode).collection('data').doc(item.payload.id).set(item.payload);
                        } else if (item.action === 'DELETE_SURVEY') {
                            await db.collection('artifacts').doc(syncCode).collection('data').doc(item.payload.id).delete();
                        } else if (item.action === 'UPDATE_MASTER') {
                             await db.collection('artifacts').doc(syncCode).collection('settings').doc('masterData').set(item.payload);
                        }
                    } catch (e) {
                        console.error("Sync fail", e);
                        remaining.push(item);
                    }
                }
                setOutbox(remaining);
                localStorage.setItem(`vellora_${syncCode}_outbox`, JSON.stringify(remaining));
            };

            const updateMasterData = (key, value) => {
                if (masterData[key] && masterData[key].includes(value)) return;
                const currentArr = masterData[key] || [];
                const newArr = [...currentArr, value];
                const newMaster = { ...masterData, [key]: newArr };
                addToOutbox('UPDATE_MASTER', newMaster);
            };

            return (
                <ThemeContext.Provider value={{ currentTheme, themeKey, setThemeKey }}>
                    <AppContext.Provider value={{ 
                        user, syncCode, setSyncCode, surveys, masterData, isOnline, outbox,
                        addToOutbox, updateMasterData, hideSyncBox, setHideSyncBox 
                    }}>
                        {children}
                    </AppContext.Provider>
                </ThemeContext.Provider>
            );
        };

        /*******************************************************
         * 4. REUSABLE UI COMPONENTS
         *******************************************************/
        const Modal = ({ isOpen, onClose, title, children }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className={`${currentTheme.card} ${currentTheme.text} w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-fade-in max-h-[90vh] overflow-y-auto`}>
                        <div className={`p-4 border-b ${currentTheme.border} flex justify-between items-center sticky top-0 ${currentTheme.card} z-10`}>
                            <h3 className="font-bold text-lg">{title}</h3>
                            <button onClick={onClose} className="p-2 opacity-70 hover:opacity-100 font-bold text-xl">&times;</button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ButtonGrid = ({ options, selected, onSelect, allowOther, onAddOther }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            const [isAdding, setIsAdding] = React.useState(false);
            const [otherVal, setOtherVal] = React.useState('');

            const handleAdd = () => {
                if(otherVal.trim()) {
                    onAddOther(otherVal.trim());
                    onSelect(otherVal.trim());
                    setOtherVal('');
                    setIsAdding(false);
                }
            };

            return (
                <div className="flex flex-wrap gap-2">
                    {options.map(opt => {
                        const isSelected = Array.isArray(selected) ? selected.includes(opt) : selected === opt;
                        return (
                            <button key={opt}
                                onClick={() => onSelect(opt)}
                                className={`px-4 py-3 rounded-lg text-sm font-medium transition-all shadow-sm active:scale-95
                                    ${isSelected 
                                        ? `${currentTheme.accent} ${currentTheme.accentText} ring-2 ring-offset-1 ring-offset-transparent ring-opacity-50` 
                                        : `${currentTheme.bg} ${currentTheme.text} border ${currentTheme.border}`
                                    }`}
                            >
                                {opt}
                            </button>
                        );
                    })}
                    {allowOther && (
                        !isAdding ? (
                            <button onClick={() => setIsAdding(true)} className={`px-4 py-3 border border-dashed ${currentTheme.border} rounded-lg text-sm opacity-70 hover:opacity-100`}>
                                + Other
                            </button>
                        ) : (
                            <div className="flex items-center gap-2">
                                <input 
                                    autoFocus
                                    value={otherVal}
                                    onChange={e => setOtherVal(e.target.value)}
                                    className={`px-3 py-2 rounded-lg border ${currentTheme.border} ${currentTheme.input} text-sm w-32`}
                                    placeholder="Type..."
                                />
                                <button onClick={handleAdd} className={`${currentTheme.accent} ${currentTheme.accentText} p-2 rounded-lg`}>
                                    <Icons.Check />
                                </button>
                            </div>
                        )
                    )}
                </div>
            );
        };

        // --- Step Components ---

        const StepA_Business = ({ data, update, next, master, addMaster }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            const [loadingLoc, setLoadingLoc] = React.useState(false);

            const handleGeo = () => {
                setLoadingLoc(true);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        const { latitude, longitude } = pos.coords;
                        update('gps', { lat: latitude, lng: longitude });
                        
                        try {
                            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            const json = await res.json();
                            // Try to find best address part
                            const area = json.address.suburb || json.address.neighbourhood || json.address.town || json.address.village || json.address.city || '';
                            if(area) update('locationArea', area);
                        } catch(e) {
                            console.error("Geo fail", e);
                        } finally {
                            setLoadingLoc(false);
                        }
                    }, (err) => {
                        alert("Could not get location. Ensure GPS is on.");
                        setLoadingLoc(false);
                    }, { enableHighAccuracy: true });
                } else {
                    alert("Geolocation not supported");
                    setLoadingLoc(false);
                }
            };

            return (
                <div className="space-y-6 animate-fade-in pb-24">
                    <h2 className="text-xl font-bold">Business Profile</h2>
                    
                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Business Name *</label>
                        <input 
                            value={data.businessName || ''}
                            onChange={e => update('businessName', e.target.value)}
                            className={`w-full p-4 rounded-xl border ${currentTheme.border} ${currentTheme.input} focus:ring-2 focus:ring-blue-500 outline-none transition-colors`}
                            placeholder="e.g. Balaji General Store"
                        />
                    </div>

                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Business Type</label>
                        <ButtonGrid 
                            options={master.businessTypes} 
                            selected={data.businessType} 
                            onSelect={v => update('businessType', v)}
                            allowOther={true}
                            onAddOther={v => addMaster('businessTypes', v)}
                        />
                    </div>

                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Daily Footfall</label>
                        <ButtonGrid 
                            options={master.footfallRanges} 
                            selected={data.dailyFootfall} 
                            onSelect={v => update('dailyFootfall', v)}
                            allowOther={true}
                            onAddOther={v => addMaster('footfallRanges', v)}
                        />
                    </div>

                    <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.bg} space-y-4`}>
                        <div className="flex justify-between items-center">
                            <label className="text-xs uppercase font-bold opacity-70">Location</label>
                            <button onClick={handleGeo} className={`flex items-center gap-2 text-xs font-bold px-3 py-1 rounded-full ${currentTheme.accent} ${currentTheme.accentText}`}>
                                {loadingLoc ? 'Locating...' : <><Icons.MapPin /> Detect</>}
                            </button>
                        </div>
                        <input 
                             value={data.locationArea || ''}
                             onChange={e => update('locationArea', e.target.value)}
                             className={`w-full p-3 rounded-lg border ${currentTheme.border} ${currentTheme.input}`}
                             placeholder="Area Name (e.g. Malviya Nagar)"
                        />
                        {data.gps && (
                             <div className="text-xs opacity-60 font-mono">
                                 Lat: {data.gps.lat.toFixed(5)}, Lng: {data.gps.lng.toFixed(5)}
                             </div>
                        )}
                    </div>
                </div>
            );
        };

        const StepB_Water = ({ data, update, master, addMaster }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            
            const toggleSelection = (field, value) => {
                const current = data[field] || [];
                const next = current.includes(value) ? current.filter(x => x !== value) : [...current, value];
                update(field, next);
            };

            const Slider = () => {
                const val = data.qtyMonthly || 0;
                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <span className="text-2xl font-bold">{val} <span className="text-sm opacity-60 font-normal">bottles/mo</span></span>
                            <input 
                                type="number" 
                                value={val} 
                                onChange={e => update('qtyMonthly', parseInt(e.target.value) || 0)} 
                                className={`w-24 p-2 text-center rounded border ${currentTheme.border} ${currentTheme.input}`}
                            />
                        </div>
                        <input 
                            type="range" 
                            min="0" max="1000" step="5" 
                            value={val}
                            onChange={e => update('qtyMonthly', parseInt(e.target.value))}
                            className={`range-slider ${currentTheme.text}`}
                        />
                    </div>
                );
            };

            return (
                <div className="space-y-8 animate-fade-in pb-24">
                    <h2 className="text-xl font-bold">Water Usage</h2>
                    
                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Brands Sold (Multi)</label>
                        <ButtonGrid 
                            options={master.brands} 
                            selected={data.brands || []} 
                            onSelect={v => toggleSelection('brands', v)}
                            allowOther={true}
                            onAddOther={v => addMaster('brands', v)}
                        />
                    </div>

                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Bottle Sizes (Multi)</label>
                        <ButtonGrid 
                            options={master.bottleSizes} 
                            selected={data.bottleSizes || []} 
                            onSelect={v => toggleSelection('bottleSizes', v)}
                            allowOther={true}
                            onAddOther={v => addMaster('bottleSizes', v)}
                        />
                    </div>

                    <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                         <label className="text-xs uppercase font-bold opacity-70 mb-4 block">Monthly Quantity</label>
                         <Slider />
                    </div>
                </div>
            );
        };

        const StepC_Pricing = ({ data, update }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            
            if(!data.brands?.length || !data.bottleSizes?.length) {
                return <div className="p-8 text-center opacity-70">Please select Brands and Sizes in the previous step first.</div>
            }

            const handlePriceChange = (type, key, val) => {
                const currentObj = data[type] || {};
                const newData = { ...currentObj, [key]: val };
                update(type, newData);
                
                // Calc Profit
                if(type === 'buyingPrice' || type === 'sellingPrice') {
                    const buy = type === 'buyingPrice' ? val : (data.buyingPrice?.[key] || 0);
                    const sell = type === 'sellingPrice' ? val : (data.sellingPrice?.[key] || 0);
                    const profit = (parseFloat(sell) || 0) - (parseFloat(buy) || 0);
                    
                    const curProfit = data.profitPerBottle || {};
                    update('profitPerBottle', { ...curProfit, [key]: profit });
                }
            };

            return (
                <div className="space-y-6 animate-fade-in pb-24">
                    <h2 className="text-xl font-bold">Smart Pricing Matrix</h2>
                    <div className="overflow-x-auto no-scrollbar pb-4">
                        <div className="flex flex-col gap-6">
                            {data.brands.map(brand => (
                                <div key={brand} className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                                    <h3 className={`font-bold text-lg mb-3 ${currentTheme.accentText === 'text-white' ? 'text-current' : 'text-blue-600'}`}>{brand}</h3>
                                    <div className="grid grid-cols-[1fr_80px_80px_60px] gap-2 items-end mb-2 text-xs font-bold opacity-60">
                                        <span>Size</span>
                                        <span>Buy (₹)</span>
                                        <span>Sell (₹)</span>
                                        <span>Profit</span>
                                    </div>
                                    <div className="space-y-3">
                                        {data.bottleSizes.map(size => {
                                            const key = `${brand}|${size}`;
                                            const profit = data.profitPerBottle?.[key] || 0;
                                            return (
                                                <div key={key} className="grid grid-cols-[1fr_80px_80px_60px] gap-2 items-center">
                                                    <span className="text-sm font-medium truncate">{size}</span>
                                                    <input 
                                                        type="number" 
                                                        placeholder="0"
                                                        value={data.buyingPrice?.[key] || ''}
                                                        onChange={e => handlePriceChange('buyingPrice', key, e.target.value)}
                                                        className={`w-full p-2 rounded border ${currentTheme.border} ${currentTheme.input} text-center`}
                                                    />
                                                    <input 
                                                        type="number"
                                                        placeholder="0" 
                                                        value={data.sellingPrice?.[key] || ''}
                                                        onChange={e => handlePriceChange('sellingPrice', key, e.target.value)}
                                                        className={`w-full p-2 rounded border ${currentTheme.border} ${currentTheme.input} text-center`}
                                                    />
                                                    <div className={`text-center font-bold text-sm py-2 rounded ${profit > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}`}>
                                                        {profit}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const StepE_Distributor = ({ data, update, master, addMaster }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            
            const toggleProblem = (val) => {
                const cur = data.mainProblems || [];
                update('mainProblems', cur.includes(val) ? cur.filter(x => x !== val) : [...cur, val]);
            };

            return (
                <div className="space-y-6 animate-fade-in pb-24">
                     <h2 className="text-xl font-bold">Distributor & Service</h2>

                     <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Distributor Type</label>
                        <ButtonGrid 
                            options={master.distributors} 
                            selected={data.distributorName} 
                            onSelect={v => update('distributorName', v)}
                            allowOther={true}
                            onAddOther={v => addMaster('distributors', v)}
                        />
                    </div>

                    {data.distributorName === 'Direct Company' && (
                        <div className="space-y-2 animate-fade-in">
                            <label className="text-xs uppercase font-bold opacity-70">Company Details (Optional)</label>
                            <input placeholder="Company Name / Reg No" className={`w-full p-3 rounded-lg border ${currentTheme.border} ${currentTheme.input}`} 
                                value={data.companyDetails || ''} onChange={e => update('companyDetails', e.target.value)} />
                        </div>
                    )}
                    
                    {data.distributorName === 'Local Vendor' && (
                        <div className="space-y-2 animate-fade-in">
                            <label className="text-xs uppercase font-bold opacity-70">Vendor Details (Optional)</label>
                             <input placeholder="Vendor Name" className={`w-full p-3 rounded-lg border ${currentTheme.border} ${currentTheme.input} mb-2`} 
                                value={data.localVendorName || ''} onChange={e => update('localVendorName', e.target.value)} />
                             <input placeholder="Mobile Number" type="tel" className={`w-full p-3 rounded-lg border ${currentTheme.border} ${currentTheme.input}`} 
                                value={data.localVendorMobile || ''} onChange={e => update('localVendorMobile', e.target.value)} />
                        </div>
                    )}

                    <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Happy with Service?</label>
                        <div className="flex gap-2">
                            {['Yes', 'No'].map(opt => (
                                <button key={opt} onClick={() => update('happyWithService', opt)}
                                    className={`flex-1 p-3 rounded-lg border font-bold ${data.happyWithService === opt ? `${currentTheme.accent} ${currentTheme.accentText}` : `${currentTheme.border} ${currentTheme.card}`}`}>
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </div>

                    {data.happyWithService === 'No' && (
                        <div className="space-y-2 animate-fade-in">
                             <label className="text-xs uppercase font-bold opacity-70 text-red-500">Main Problems</label>
                             <ButtonGrid 
                                options={master.problems} 
                                selected={data.mainProblems || []} 
                                onSelect={toggleProblem}
                                allowOther={true}
                                onAddOther={v => addMaster('problems', v)}
                            />
                        </div>
                    )}
                </div>
            );
        };

        const StepG_WhiteLabel = ({ data, update, master, addMaster }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            return (
                 <div className="space-y-6 animate-fade-in pb-24">
                     <h2 className="text-xl font-bold">White Label (Custom Branding)</h2>
                     <div className="space-y-2">
                        <label className="text-xs uppercase font-bold opacity-70">Interested in Custom Logo?</label>
                        <div className="flex gap-2">
                            {['Yes', 'No'].map(opt => (
                                <button key={opt} onClick={() => update('interestedInCustomLogo', opt)}
                                    className={`flex-1 p-3 rounded-lg border font-bold ${data.interestedInCustomLogo === opt ? `${currentTheme.accent} ${currentTheme.accentText}` : `${currentTheme.border} ${currentTheme.card}`}`}>
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </div>

                    {data.interestedInCustomLogo === 'Yes' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="space-y-2">
                                <label className="text-xs uppercase font-bold opacity-70">Purpose</label>
                                <ButtonGrid 
                                    options={master.whiteLabelPurposes} 
                                    selected={data.customPurpose} 
                                    onSelect={v => update('customPurpose', v)}
                                    allowOther={true}
                                    onAddOther={v => addMaster('whiteLabelPurposes', v)}
                                />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs uppercase font-bold opacity-70">Extra Willing To Pay (₹)</label>
                                 <ButtonGrid 
                                    options={master.willingToPayAmounts || ["1", "2", "3", "5", "10"]} 
                                    selected={data.extraWillingToPay} 
                                    onSelect={v => update('extraWillingToPay', v)}
                                    allowOther={true}
                                    onAddOther={v => addMaster('willingToPayAmounts', v)}
                                />
                            </div>
                        </div>
                    )}
                 </div>
            );
        };

        const StepI_Closing = ({ data, update, onSubmit }) => {
             const { currentTheme } = React.useContext(ThemeContext);
             return (
                <div className="space-y-6 animate-fade-in pb-24">
                    <h2 className="text-xl font-bold">Final Contact Details</h2>
                    <input 
                        placeholder="Contact Name" 
                        className={`w-full p-4 rounded-xl border ${currentTheme.border} ${currentTheme.input}`}
                        value={data.contactName || ''}
                        onChange={e => update('contactName', e.target.value)}
                    />
                     <input 
                        placeholder="Mobile Number *" 
                        type="tel"
                        className={`w-full p-4 rounded-xl border ${currentTheme.border} ${currentTheme.input}`}
                        value={data.contactMobile || ''}
                        onChange={e => update('contactMobile', e.target.value)}
                    />

                    <div className={`p-4 rounded-xl ${currentTheme.bg} border ${currentTheme.border} text-sm opacity-80`}>
                        <p><strong>Business:</strong> {data.businessName}</p>
                        <p><strong>Area:</strong> {data.locationArea}</p>
                        <p><strong>Brands:</strong> {data.brands?.join(', ')}</p>
                    </div>

                    <button onClick={onSubmit} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg ${currentTheme.accent} ${currentTheme.accentText}`}>
                        COMPLETE & SAVE SURVEY
                    </button>
                </div>
             );
        };

        // --- Main Wizard Controller ---
        const SurveyWizard = ({ onClose }) => {
            const { currentTheme } = React.useContext(ThemeContext);
            const { masterData, updateMasterData, addToOutbox, syncCode } = React.useContext(AppContext);
            const [step, setStep] = React.useState(0);
            const [data, setData] = React.useState({ id: generateUUID(), timestamp: new Date().toISOString(), syncCode });

            const update = (field, val) => setData(prev => ({ ...prev, [field]: val }));

            const steps = [
                { id: 'A', comp: StepA_Business },
                { id: 'B', comp: StepB_Water },
                { id: 'C', comp: StepC_Pricing },
                { id: 'E', comp: StepE_Distributor },
                { id: 'G', comp: StepG_WhiteLabel },
                { id: 'I', comp: StepI_Closing }
            ];

            const handleNext = () => {
                // Validation
                if(step === 0 && !data.businessName) { alert("Business Name is required"); return; }
                if(step < steps.length - 1) setStep(step + 1);
            };

            const handleSubmit = () => {
                if(!data.contactMobile) { alert("Mobile number is required"); return; }
                addToOutbox('ADD_SURVEY', data);
                onClose();
            };

            const CurrentComp = steps[step].comp;

            return (
                <div className={`fixed inset-0 z-40 ${currentTheme.bg} ${currentTheme.text} flex flex-col h-full`}>
                    {/* Header */}
                    <div className={`p-4 flex items-center justify-between border-b ${currentTheme.border}`}>
                         <button onClick={() => step > 0 ? setStep(step-1) : onClose()} className="p-2">
                             <Icons.ChevronLeft />
                         </button>
                         <span className="font-bold">Step {step + 1} of {steps.length}</span>
                         <button onClick={handleNext} className={`p-2 font-bold ${currentTheme.accentText === 'text-white' ? 'text-blue-600' : 'text-current'} ${step === steps.length - 1 ? 'invisible' : ''}`}>
                             Next
                         </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-4">
                        <CurrentComp 
                            data={data} 
                            update={update} 
                            master={masterData} 
                            addMaster={updateMasterData}
                            next={handleNext}
                            onSubmit={handleSubmit}
                        />
                    </div>
                </div>
            );
        };

        /*******************************************************
         * 5. DASHBOARD VIEWS
         *******************************************************/
        
        const SurveyList = ({ onOpenDetail }) => {
            const { surveys = [], currentTheme, syncCode, hideSyncBox, setSyncCode, isOnline, outbox = [] } = React.useContext(AppContext);
            const { currentTheme: theme } = React.useContext(ThemeContext);
            const [filter, setFilter] = React.useState('');
            const [showFilters, setShowFilters] = React.useState(false);
            
            // Filter logic
            const filtered = surveys.filter(s => {
                const search = filter.toLowerCase();
                return (s.businessName?.toLowerCase().includes(search) || 
                       s.locationArea?.toLowerCase().includes(search));
            }).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            const pendingCount = outbox.length;

            return (
                <div className="pb-24 pt-4 px-4 space-y-4">
                    {/* Status Bar */}
                    <div className="flex justify-between items-center text-xs font-bold opacity-60">
                        <span className={isOnline ? 'text-green-600' : 'text-red-500'}>
                            {isOnline ? '● ONLINE' : '● OFFLINE'}
                        </span>
                        <span>{surveys.length} Surveys</span>
                    </div>

                    {/* Sync Box */}
                    {(!hideSyncBox) && (
                        <div className={`p-4 rounded-xl border ${theme.border} ${theme.card} flex items-center gap-2`}>
                            <div className="flex-1">
                                <label className="text-xs uppercase font-bold opacity-50 block mb-1">Workspace Sync Code</label>
                                <input 
                                    className={`w-full bg-transparent font-mono font-bold outline-none uppercase ${theme.text}`}
                                    value={syncCode}
                                    onChange={e => setSyncCode(e.target.value.toUpperCase())}
                                />
                            </div>
                            <div className="text-xs max-w-[100px] opacity-60 leading-tight text-right">Devices with this code share data.</div>
                        </div>
                    )}

                    {/* Search & Export */}
                    <div className="flex gap-2">
                        <div className={`flex-1 flex items-center px-3 rounded-lg border ${theme.border} ${theme.card}`}>
                            <Icons.Search />
                            <input 
                                className={`w-full p-3 bg-transparent outline-none ${theme.input}`} 
                                placeholder="Search..." 
                                value={filter}
                                onChange={e => setFilter(e.target.value)}
                            />
                        </div>
                        <button onClick={() => setShowFilters(!showFilters)} className={`p-3 rounded-lg border ${theme.border} ${theme.card}`}>
                            <Icons.Filter />
                        </button>
                    </div>

                    {/* List */}
                    <div className="space-y-3">
                        {pendingCount > 0 && (
                            <div className="bg-yellow-100 text-yellow-800 p-3 rounded-lg text-sm font-bold flex justify-between">
                                <span>{pendingCount} unsynced items in queue</span>
                                <Icons.WifiOff />
                            </div>
                        )}

                        {filtered.map(s => (
                            <div key={s.id} onClick={() => onOpenDetail(s)} className={`p-4 rounded-xl border ${theme.border} ${theme.card} active:scale-[0.98] transition-transform`}>
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-bold text-lg">{s.businessName}</h3>
                                    <span className="text-xs opacity-50">{new Date(s.timestamp).toLocaleDateString()}</span>
                                </div>
                                <div className="flex flex-wrap gap-2 text-xs font-medium opacity-70 mb-2">
                                    <span className={`px-2 py-1 rounded-md border ${theme.border}`}>{s.businessType}</span>
                                    <span className={`px-2 py-1 rounded-md border ${theme.border}`}>{s.locationArea}</span>
                                </div>
                                {s.interestedInCustomLogo === 'Yes' && (
                                    <div className="inline-block bg-gradient-to-r from-amber-400 to-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded-full">
                                        WHITE LABEL LEAD
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DetailModal = ({ survey, onClose }) => {
            const { currentTheme: theme } = React.useContext(ThemeContext);
            const { addToOutbox } = React.useContext(AppContext);

            const handleDelete = () => {
                if(confirm('Are you sure you want to delete this survey?')) {
                    addToOutbox('DELETE_SURVEY', survey);
                    onClose();
                }
            };

            const handleExport = () => {
                generatePDF(survey);
            };

            if(!survey) return null;

            return (
                <Modal isOpen={!!survey} onClose={onClose} title={survey.businessName}>
                    <div className="space-y-6">
                        {/* 1. Business & Location Section */}
                        <div className={`p-4 rounded-xl border ${theme.border} ${theme.bg}`}>
                            <h4 className="font-bold text-xs uppercase opacity-50 mb-3 border-b pb-1">Business Profile</h4>
                            <div className="grid grid-cols-2 gap-y-2 gap-x-4 text-sm">
                                <div><span className="opacity-60 block text-xs">Type</span><span className="font-medium">{survey.businessType}</span></div>
                                <div><span className="opacity-60 block text-xs">Footfall</span><span className="font-medium">{survey.dailyFootfall || 'N/A'}</span></div>
                                <div><span className="opacity-60 block text-xs">Area</span><span className="font-medium">{survey.locationArea}</span></div>
                                <div><span className="opacity-60 block text-xs">Date</span><span className="font-medium">{new Date(survey.timestamp).toLocaleDateString()}</span></div>
                                {survey.gps && (
                                    <div className="col-span-2 mt-1">
                                        <span className="opacity-60 block text-xs">GPS Coordinates</span>
                                        <span className="font-mono text-xs opacity-80">{survey.gps.lat.toFixed(5)}, {survey.gps.lng.toFixed(5)}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 2. Contact Section */}
                        <div className={`p-4 rounded-xl border ${theme.border} ${theme.bg}`}>
                            <h4 className="font-bold text-xs uppercase opacity-50 mb-3 border-b pb-1">Contact</h4>
                            <div className="text-sm">
                                <div className="font-bold text-lg">{survey.contactName}</div>
                                <div className="font-mono opacity-80">{survey.contactMobile}</div>
                            </div>
                        </div>

                        {/* 3. Supply & Distributor Section */}
                        <div className={`p-4 rounded-xl border ${theme.border} ${theme.bg}`}>
                            <h4 className="font-bold text-xs uppercase opacity-50 mb-3 border-b pb-1">Supply Chain</h4>
                            <div className="space-y-3 text-sm">
                                <div className="flex justify-between items-center">
                                    <span className="opacity-70">Monthly Volume</span>
                                    <span className="font-bold text-lg">{survey.qtyMonthly} <span className="text-xs font-normal opacity-60">bottles</span></span>
                                </div>
                                <div className="grid grid-cols-2 gap-y-2 gap-x-4 pt-2 border-t border-dashed border-gray-200">
                                    <div><span className="opacity-60 block text-xs">Distributor</span><span className="font-medium">{survey.distributorName}</span></div>
                                    <div>
                                        <span className="opacity-60 block text-xs">Service Satisfaction</span>
                                        <span className={`font-bold ${survey.happyWithService === 'No' ? 'text-red-500' : 'text-green-600'}`}>
                                            {survey.happyWithService}
                                        </span>
                                    </div>
                                    
                                    {/* Conditional Distributor Details */}
                                    {survey.companyDetails && (
                                        <div className="col-span-2"><span className="opacity-60 block text-xs">Company Details</span><span className="font-medium">{survey.companyDetails}</span></div>
                                    )}
                                    {(survey.localVendorName || survey.localVendorMobile) && (
                                        <div className="col-span-2">
                                            <span className="opacity-60 block text-xs">Local Vendor</span>
                                            <span className="font-medium">{survey.localVendorName} ({survey.localVendorMobile})</span>
                                        </div>
                                    )}
                                </div>

                                {survey.mainProblems && survey.mainProblems.length > 0 && (
                                    <div className="pt-2">
                                        <span className="opacity-60 block text-xs mb-1">Reported Issues</span>
                                        <div className="flex flex-wrap gap-2">
                                            {survey.mainProblems.map(p => (
                                                <span key={p} className="px-2 py-1 bg-red-50 text-red-700 border border-red-100 text-[10px] rounded-md font-bold">{p}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 4. White Label Section (Conditional) */}
                        {survey.interestedInCustomLogo === 'Yes' && (
                            <div className="p-4 rounded-xl border border-amber-200 bg-amber-50 text-amber-900">
                                <h4 className="font-bold text-xs uppercase opacity-60 mb-3 border-b border-amber-200 pb-1">White Label Opportunity</h4>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div><span className="opacity-60 block text-xs">Purpose</span><span className="font-bold">{survey.customPurpose}</span></div>
                                    <div><span className="opacity-60 block text-xs">Extra Willing to Pay</span><span className="font-bold">₹{survey.extraWillingToPay}</span></div>
                                </div>
                            </div>
                        )}

                        {/* 5. Pricing Table (Existing) */}
                        <div className={`p-4 rounded-xl border ${theme.border} bg-opacity-50`}>
                            <h4 className="font-bold text-xs uppercase opacity-50 mb-3 border-b pb-1">Pricing Matrix</h4>
                            {survey.brands?.map(b => (
                                <div key={b} className="mb-3 last:mb-0">
                                    <div className="font-bold text-sm mb-1">{b}</div>
                                    <div className="grid grid-cols-4 gap-1 text-[10px] opacity-60 uppercase font-bold mb-1">
                                        <span>Size</span><span>Buy</span><span>Sell</span><span>Profit</span>
                                    </div>
                                    {survey.bottleSizes?.map(s => {
                                        const k = `${b}|${s}`;
                                        if(!survey.buyingPrice?.[k]) return null;
                                        return (
                                            <div key={k} className="grid grid-cols-4 gap-1 text-xs border-b border-dashed border-gray-300 py-1">
                                                <span>{s}</span>
                                                <span>{survey.buyingPrice[k]}</span>
                                                <span>{survey.sellingPrice[k]}</span>
                                                <span className="font-bold text-green-600">{survey.profitPerBottle?.[k]}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            ))}
                        </div>

                        {/* Actions */}
                        <div className="flex flex-wrap gap-2 pt-2 sticky bottom-0 bg-white/80 backdrop-blur-sm pb-2 border-t mt-4">
                            <a href={`tel:${survey.contactMobile}`} className={`flex-1 py-3 text-center rounded-lg font-bold bg-green-500 text-white flex items-center justify-center gap-2 shadow-sm`}>
                                Call
                            </a>
                            {survey.gps && (
                                <a href={`https://www.google.com/maps?q=${survey.gps.lat},${survey.gps.lng}`} target="_blank" className={`flex-1 py-3 text-center rounded-lg font-bold bg-blue-500 text-white flex items-center justify-center gap-2 shadow-sm`}>
                                    <Icons.Map /> Map
                                </a>
                            )}
                            <button onClick={handleExport} className={`px-4 py-3 rounded-lg font-bold ${theme.bg} border ${theme.border} text-blue-600 flex items-center justify-center shadow-sm`}><Icons.Download /></button>
                            <button onClick={handleDelete} className="px-4 py-3 rounded-lg font-bold bg-red-50 text-red-600 border border-red-100 flex items-center justify-center shadow-sm"><Icons.Trash /></button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const Analytics = () => {
             const { surveys, currentTheme: theme } = React.useContext(AppContext);
             const { currentTheme } = React.useContext(ThemeContext);

             // Stats
             const total = surveys.length;
             const today = surveys.filter(s => new Date(s.timestamp).setHours(0,0,0,0) === new Date().setHours(0,0,0,0)).length;
             const wlLeads = surveys.filter(s => s.interestedInCustomLogo === 'Yes').length;
             
             // Calc Avg Margin
             let totalProfit = 0;
             let count = 0;
             surveys.forEach(s => {
                 if(s.profitPerBottle) {
                     Object.values(s.profitPerBottle).forEach(v => {
                         totalProfit += (parseFloat(v) || 0);
                         count++;
                     });
                 }
             });
             const avgMargin = count ? (totalProfit / count).toFixed(1) : 0;

             // Charts Data
             const getCounts = (field) => {
                 const counts = {};
                 surveys.forEach(s => {
                     const val = s[field];
                     if(Array.isArray(val)) val.forEach(v => counts[v] = (counts[v]||0)+1);
                     else if(val) counts[val] = (counts[val]||0)+1;
                 });
                 return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
             };

             const typeData = getCounts('businessType');
             const brandData = getCounts('brands');

             // Simple SVG Donut Component
             const Donut = ({ data, colorBase }) => {
                 let cumPercent = 0;
                 const total = data.reduce((a,b)=>a+b[1],0);
                 if(total === 0) return null;
                 
                 const getCoords = (percent) => {
                     const x = Math.cos(2 * Math.PI * percent);
                     const y = Math.sin(2 * Math.PI * percent);
                     return [x, y];
                 }

                 return (
                     <div className="flex items-center gap-4">
                        <svg viewBox="-1 -1 2 2" className="w-24 h-24 rotate-[-90deg]">
                            {data.map((slice, i) => {
                                const [label, val] = slice;
                                const percent = val / total;
                                const start = getCoords(cumPercent);
                                cumPercent += percent;
                                const end = getCoords(cumPercent);
                                const largeArc = percent > 0.5 ? 1 : 0;
                                const path = `M ${start[0]} ${start[1]} A 1 1 0 ${largeArc} 1 ${end[0]} ${end[1]}`;
                                return <path key={i} d={path} fill="none" stroke={`hsl(${200 + (i*40)}, 70%, 50%)`} strokeWidth="0.5" />
                            })}
                        </svg>
                        <div className="text-xs space-y-1">
                            {data.map((slice, i) => (
                                <div key={i} className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full" style={{background: `hsl(${200 + (i*40)}, 70%, 50%)`}}></div>
                                    <span className="opacity-70">{slice[0]}</span>
                                    <span className="font-bold">{Math.round((slice[1]/total)*100)}%</span>
                                </div>
                            ))}
                        </div>
                     </div>
                 )
             };

             return (
                 <div className="pb-24 pt-4 px-4 space-y-4 animate-fade-in">
                     <h2 className="text-xl font-bold">Analytics Hub</h2>
                     
                     <div className="grid grid-cols-2 gap-3">
                         <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                             <div className="text-3xl font-bold">{total}</div>
                             <div className="text-xs opacity-60">Total Surveys</div>
                         </div>
                         <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                             <div className="text-3xl font-bold text-green-500">₹{avgMargin}</div>
                             <div className="text-xs opacity-60">Avg Margin</div>
                         </div>
                         <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                             <div className="text-3xl font-bold">{today}</div>
                             <div className="text-xs opacity-60">Today</div>
                         </div>
                         <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                             <div className="text-3xl font-bold text-orange-500">{wlLeads}</div>
                             <div className="text-xs opacity-60">WL Leads</div>
                         </div>
                     </div>

                     <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                         <h3 className="font-bold mb-4">Market Composition</h3>
                         <Donut data={typeData} />
                     </div>

                     <div className={`p-4 rounded-xl border ${currentTheme.border} ${currentTheme.card}`}>
                         <h3 className="font-bold mb-4">Top Brands</h3>
                         <div className="space-y-2">
                             {brandData.map(([label, val]) => (
                                 <div key={label}>
                                     <div className="flex justify-between text-xs mb-1"><span>{label}</span><span>{val}</span></div>
                                     <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                         <div className={`h-full ${currentTheme.accent}`} style={{width: `${(val/total)*100}%`}}></div>
                                     </div>
                                 </div>
                             ))}
                         </div>
                     </div>
                 </div>
             );
        };

        const Settings = () => {
             const { currentTheme, setThemeKey, themeKey } = React.useContext(ThemeContext);
             const { surveys, hideSyncBox, setHideSyncBox, addToOutbox } = React.useContext(AppContext);

             const handleExportAll = (format) => {
                 if(format === 'csv') {
                     const csv = convertToCSV(surveys);
                     const blob = new Blob([csv], { type: 'text/csv' });
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `vellora_export_${new Date().toISOString()}.csv`;
                     a.click();
                 } else if (format === 'json') {
                     const blob = new Blob([JSON.stringify(surveys, null, 2)], { type: 'application/json' });
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `vellora_export_${new Date().toISOString()}.json`;
                     a.click();
                 }
             };

             return (
                 <div className="pb-24 pt-4 px-4 space-y-6 animate-fade-in">
                     <h2 className="text-xl font-bold">App Settings</h2>

                     <div className="space-y-2">
                         <label className="text-xs uppercase font-bold opacity-70">Theme</label>
                         <div className="grid grid-cols-2 gap-2">
                             {Object.entries(THEMES).map(([key, t]) => (
                                 <button key={key} onClick={() => setThemeKey(key)}
                                     className={`p-3 text-xs font-bold rounded-lg border flex items-center gap-2 ${themeKey === key ? 'ring-2 ring-blue-500' : ''} ${t.bg} ${t.text} ${t.border}`}>
                                     <div className={`w-4 h-4 rounded-full ${t.accent}`}></div>
                                     {t.name}
                                 </button>
                             ))}
                         </div>
                     </div>

                     <div className="space-y-2">
                         <label className="text-xs uppercase font-bold opacity-70">Workspace</label>
                         <div className={`p-3 rounded-lg border ${currentTheme.border} ${currentTheme.card} flex justify-between items-center`}>
                             <span>Show Sync Box in List</span>
                             <button onClick={() => setHideSyncBox(!hideSyncBox)} className={`w-10 h-6 rounded-full transition-colors ${!hideSyncBox ? 'bg-green-500' : 'bg-gray-300'} relative`}>
                                 <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${!hideSyncBox ? 'left-5' : 'left-1'}`}></div>
                             </button>
                         </div>
                     </div>

                     <div className="space-y-2">
                         <label className="text-xs uppercase font-bold opacity-70">Data Management</label>
                         <div className="flex gap-2">
                             <button onClick={() => handleExportAll('csv')} className={`flex-1 py-3 rounded-lg border ${currentTheme.border} font-bold flex items-center justify-center gap-2 ${currentTheme.card}`}>
                                 <Icons.Download /> CSV
                             </button>
                             <button onClick={() => handleExportAll('json')} className={`flex-1 py-3 rounded-lg border ${currentTheme.border} font-bold flex items-center justify-center gap-2 ${currentTheme.card}`}>
                                 <Icons.Download /> JSON
                             </button>
                         </div>
                     </div>
                 </div>
             );
        };

        /*******************************************************
         * 6. MAIN APP LAYOUT
         *******************************************************/
        const App = () => {
            const { currentTheme } = React.useContext(ThemeContext);
            const [view, setView] = React.useState('list'); // list, analytics, settings
            const [isWizardOpen, setWizardOpen] = React.useState(false);
            const [selectedSurvey, setSelectedSurvey] = React.useState(null);

            const NavBtn = ({ v, icon: Icon, label }) => (
                <button onClick={() => setView(v)} className={`flex flex-col items-center justify-center space-y-1 w-full h-full ${view === v ? currentTheme.accentText === 'text-white' ? 'text-blue-600' : 'opacity-100 font-bold' : 'opacity-50'}`}>
                    <Icon />
                    <span className="text-[10px] font-bold">{label}</span>
                </button>
            );

            return (
                <div className={`min-h-screen transition-colors duration-300 ${currentTheme.bg} ${currentTheme.text}`}>
                    {/* Top Bar */}
                    <div className={`h-16 flex items-center justify-center border-b ${currentTheme.border} ${currentTheme.card} sticky top-0 z-30 shadow-sm`}>
                         <h1 className="font-bold text-lg tracking-wide">VELLORA</h1>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-2xl mx-auto min-h-[80vh]">
                        {view === 'list' && <SurveyList onOpenDetail={setSelectedSurvey} />}
                        {view === 'analytics' && <Analytics />}
                        {view === 'settings' && <Settings />}
                    </div>

                    {/* Bottom Nav */}
                    <div className={`fixed bottom-0 left-0 right-0 h-16 ${currentTheme.card} border-t ${currentTheme.border} flex justify-around items-center z-50 max-w-2xl mx-auto`}>
                        <NavBtn v="list" icon={Icons.Home} label="Surveys" />
                        <NavBtn v="analytics" icon={Icons.BarChart} label="Analytics" />
                        <NavBtn v="settings" icon={Icons.Settings} label="Settings" />
                    </div>

                    {/* FAB (Add Button) */}
                    {!isWizardOpen && view === 'list' && (
                        <button 
                            onClick={() => setWizardOpen(true)}
                            className={`fixed bottom-20 right-6 w-14 h-14 rounded-full shadow-xl flex items-center justify-center ${currentTheme.accent} ${currentTheme.accentText} z-40 transition-transform active:scale-90`}
                        >
                            <Icons.Plus />
                        </button>
                    )}

                    {/* Modals */}
                    {isWizardOpen && <SurveyWizard onClose={() => setWizardOpen(false)} />}
                    {selectedSurvey && <DetailModal survey={selectedSurvey} onClose={() => setSelectedSurvey(null)} />}
                </div>
            );
        };

        const Root = () => (
            <ErrorBoundary>
                <AppProvider>
                    <App />
                </AppProvider>
            </ErrorBoundary>
        );

        ReactDOM.render(<Root />, document.getElementById('root'));
    </script>
</body>
</html>


