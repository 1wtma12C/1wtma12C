<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Vellora - Professional Survey & Data Collection PWA">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vellora">
  <title>Vellora</title>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
  
  <!-- html2canvas & jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; width: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
    
    /* Theme CSS Variables */
    :root {
      --bg: #ffffff;
      --surface: #f8fafc;
      --primary-text: #1e293b;
      --secondary-text: #64748b;
      --input-bg: #ffffff;
      --primary-btn-bg: #3b82f6;
      --primary-btn-text: #ffffff;
      --accent: #3b82f6;
      --border: #e2e8f0;
      --placeholder: #94a3b8;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--secondary-text); }
    
    /* Transitions */
    .theme-transition { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    
    /* Touch-friendly elements */
    button, input, select, textarea { min-height: 44px; font-size: 16px; }
    
    /* FAB */
    .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; cursor: pointer; }
    
    /* Modal backdrop */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; }
    
    /* Chip styles */
    .chip { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 14px; gap: 6px; cursor: pointer; transition: all 0.2s; }
    .chip.selected { background: var(--accent); color: white; }
    .chip:not(.selected) { background: var(--surface); border: 1px solid var(--border); }
    
    /* Matrix table */
    .matrix-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .matrix-table { min-width: max-content; }
    .matrix-table th { position: sticky; top: 0; background: var(--surface); z-index: 10; }
    .matrix-table th:first-child { position: sticky; left: 0; z-index: 20; }
    .matrix-table td:first-child { position: sticky; left: 0; background: var(--surface); }
    
    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Bottom nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; display: flex; background: var(--surface); border-top: 1px solid var(--border); z-index: 90; }
    .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer; color: var(--secondary-text); transition: color 0.2s; }
    .bottom-nav-item.active { color: var(--accent); }
    
    /* Analytics drawer */
    .analytics-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 320px; max-width: 85vw; background: var(--surface); z-index: 150; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 4px 0 20px rgba(0,0,0,0.1); overflow-y: auto; }
    .analytics-drawer.open { transform: translateX(0); }
    
    /* Wizard footer */
    .wizard-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 20px; background: var(--surface); border-top: 1px solid var(--border); display: flex; gap: 12px; z-index: 100; }
    
    /* Progress bar */
    .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s ease; }
    
    /* Form inputs */
    .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--primary-text); outline: none; transition: border-color 0.2s; }
    .form-input:focus { border-color: var(--accent); }
    .form-input::placeholder { color: var(--placeholder); }
    
    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    
    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .badge.wl { background: #fef3c7; color: #92400e; }
    .badge.missing { background: #fee2e2; color: #991b1b; }
    .badge.offline { background: #e0e7ff; color: #3730a3; }
    
    /* Loading spinner */
    .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Error boundary */
    .error-boundary { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // ============================================================
    // FIREBASE CONFIGURATION
    // SECURITY NOTE: For production, configure secure Firestore rules:
    // - Restrict read/write to authenticated users only
    // - Validate data structure in rules
    // - Use syncCode-based document paths for multi-tenancy
    // ============================================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
      authDomain: "vellora-3828d.firebaseapp.com",
      projectId: "vellora-3828d",
      storageBucket: "vellora-3828d.firebasestorage.app",
      messagingSenderId: "1045366360458",
      appId: "1:1045366360458:web:c9de51b7942bd743d9a073",
      measurementId: "G-WLKMJNBJTP"
    };

    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Enable offline persistence
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
      console.warn('Firestore persistence error:', err);
    });

    // ============================================================
    // THEME DEFINITIONS - 10 PRESETS WITH FULL WCAG AA COMPLIANCE
    // ============================================================
    const THEMES = {
      'corporate-light': {
        name: 'Corporate Light',
        dark: false,
        bg: '#ffffff',
        surface: '#f8fafc',
        primaryText: '#1e293b',
        secondaryText: '#64748b',
        inputBg: '#ffffff',
        primaryBtnBg: '#2563eb',
        primaryBtnText: '#ffffff',
        accent: '#2563eb',
        border: '#e2e8f0',
        placeholder: '#94a3b8'
      },
      'sunset': {
        name: 'Sunset',
        dark: false,
        bg: '#fffbf5',
        surface: '#fff7ed',
        primaryText: '#7c2d12',
        secondaryText: '#c2410c',
        inputBg: '#ffffff',
        primaryBtnBg: '#ea580c',
        primaryBtnText: '#ffffff',
        accent: '#ea580c',
        border: '#fed7aa',
        placeholder: '#fb923c'
      },
      'forest-rain': {
        name: 'Forest Rain',
        dark: false,
        bg: '#f0fdf4',
        surface: '#dcfce7',
        primaryText: '#14532d',
        secondaryText: '#166534',
        inputBg: '#ffffff',
        primaryBtnBg: '#16a34a',
        primaryBtnText: '#ffffff',
        accent: '#16a34a',
        border: '#bbf7d0',
        placeholder: '#4ade80'
      },
      'berry': {
        name: 'Berry',
        dark: false,
        bg: '#fdf2f8',
        surface: '#fce7f3',
        primaryText: '#831843',
        secondaryText: '#be185d',
        inputBg: '#ffffff',
        primaryBtnBg: '#db2777',
        primaryBtnText: '#ffffff',
        accent: '#db2777',
        border: '#fbcfe8',
        placeholder: '#f472b6'
      },
      'slate': {
        name: 'Slate',
        dark: false,
        bg: '#f8fafc',
        surface: '#f1f5f9',
        primaryText: '#334155',
        secondaryText: '#64748b',
        inputBg: '#ffffff',
        primaryBtnBg: '#475569',
        primaryBtnText: '#ffffff',
        accent: '#475569',
        border: '#cbd5e1',
        placeholder: '#94a3b8'
      },
      'midnight-dark': {
        name: 'Midnight Dark',
        dark: true,
        bg: '#0f172a',
        surface: '#1e293b',
        primaryText: '#f1f5f9',
        secondaryText: '#94a3b8',
        inputBg: '#1e293b',
        primaryBtnBg: '#3b82f6',
        primaryBtnText: '#ffffff',
        accent: '#3b82f6',
        border: '#334155',
        placeholder: '#64748b'
      },
      'obsidian': {
        name: 'Obsidian',
        dark: true,
        // WCAG AA compliant - explicit contrast-safe colors for pure black theme
        bg: '#000000',
        surface: '#0a0a0a',
        primaryText: '#fafafa',
        secondaryText: '#a1a1aa',
        inputBg: '#18181b',
        primaryBtnBg: '#a855f7',
        primaryBtnText: '#ffffff',
        accent: '#a855f7',
        border: '#27272a',
        placeholder: '#71717a'
      },
      'oceanic': {
        name: 'Oceanic',
        dark: true,
        bg: '#0c4a6e',
        surface: '#075985',
        primaryText: '#f0f9ff',
        secondaryText: '#bae6fd',
        inputBg: '#0369a1',
        primaryBtnBg: '#38bdf8',
        primaryBtnText: '#0c4a6e',
        accent: '#38bdf8',
        border: '#0284c7',
        placeholder: '#7dd3fc'
      },
      'royal': {
        name: 'Royal',
        dark: true,
        bg: '#1e1b4b',
        surface: '#312e81',
        primaryText: '#eef2ff',
        secondaryText: '#c7d2fe',
        inputBg: '#3730a3',
        primaryBtnBg: '#818cf8',
        primaryBtnText: '#1e1b4b',
        accent: '#818cf8',
        border: '#4338ca',
        placeholder: '#a5b4fc'
      },
      'luxury': {
        name: 'Luxury',
        dark: true,
        bg: '#1c1917',
        surface: '#292524',
        primaryText: '#fafaf9',
        secondaryText: '#a8a29e',
        inputBg: '#292524',
        primaryBtnBg: '#d97706',
        primaryBtnText: '#ffffff',
        accent: '#d97706',
        border: '#44403c',
        placeholder: '#78716c'
      }
    };

    // ============================================================
    // MASTER DATA DEFAULTS (Self-learning lists)
    // ============================================================
    const DEFAULT_MASTER_DATA = {
      businessTypes: ['Restaurant', 'Cafe', 'Hotel', 'Gym', 'Office', 'Hospital', 'School', 'Retail Store', 'Salon', 'Other'],
      brands: ['Aquafina', 'Dasani', 'Evian', 'Fiji', 'Perrier', 'Poland Spring', 'Smartwater', 'Voss', 'Local Brand'],
      bottleSizes: ['250ml', '500ml', '1L', '1.5L', '5L', '20L'],
      problems: ['Late Delivery', 'Wrong Order', 'Poor Quality', 'High Prices', 'Damaged Products', 'Rude Staff', 'Inconsistent Supply'],
      distributors: ['Direct Company', 'Local Vendor', 'Wholesale Market', 'Online Supplier'],
      whiteLabelPurposes: ['Branding', 'Events', 'Gifts', 'Resale', 'Corporate Use', 'Other']
    };

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    };

    const getDeviceId = () => {
      let deviceId = localStorage.getItem('vellora_deviceId');
      if (!deviceId) {
        deviceId = generateUUID();
        localStorage.setItem('vellora_deviceId', deviceId);
      }
      return deviceId;
    };

    const getSyncCode = () => localStorage.getItem('vellora_syncCode') || 'MAIN';
    const setSyncCode = (code) => localStorage.setItem('vellora_syncCode', code);

    const getStorageKey = (key) => `vellora_${getSyncCode()}_${key}`;

    const saveToLocalStorage = (key, data) => {
      try {
        localStorage.setItem(getStorageKey(key), JSON.stringify(data));
      } catch (e) {
        console.error('LocalStorage save error:', e);
      }
    };

    const loadFromLocalStorage = (key) => {
      try {
        const data = localStorage.getItem(getStorageKey(key));
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('LocalStorage load error:', e);
        return null;
      }
    };

    // PIN hashing using PBKDF2-like approach with Web Crypto
    const hashPIN = async (pin, salt = null) => {
      const encoder = new TextEncoder();
      salt = salt || crypto.getRandomValues(new Uint8Array(16));
      const keyMaterial = await crypto.subtle.importKey(
        'raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']
      );
      const bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
        keyMaterial, 256
      );
      const hashArray = Array.from(new Uint8Array(bits));
      const saltArray = Array.from(salt);
      return {
        hash: hashArray.map(b => b.toString(16).padStart(2, '0')).join(''),
        salt: saltArray.map(b => b.toString(16).padStart(2, '0')).join('')
      };
    };

    const verifyPIN = async (pin, storedHash, storedSalt) => {
      const saltArray = new Uint8Array(storedSalt.match(/.{2}/g).map(b => parseInt(b, 16)));
      const result = await hashPIN(pin, saltArray);
      return result.hash === storedHash;
    };

    const validatePhone = (phone) => {
      const cleaned = phone.replace(/\D/g, '');
      return cleaned.length >= 10 && cleaned.length <= 15;
    };

    const formatDate = (isoString) => {
      const date = new Date(isoString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    // ============================================================
    // REACT COMPONENTS
    // ============================================================
    const { useState, useEffect, useCallback, useRef, createContext, useContext } = React;

    // Theme Context
    const ThemeContext = createContext();

    const useTheme = () => useContext(ThemeContext);

    // Toast Context
    const ToastContext = createContext();

    const useToast = () => useContext(ToastContext);

    // App State Context
    const AppContext = createContext();

    const useApp = () => useContext(AppContext);

    // ============================================================
    // ERROR BOUNDARY
    // ============================================================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('Error Boundary caught:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return React.createElement('div', { className: 'error-boundary', style: { background: 'var(--bg)', color: 'var(--primary-text)' } },
            React.createElement('svg', { width: 64, height: 64, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--error)', strokeWidth: 2 },
              React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
              React.createElement('line', { x1: 12, y1: 8, x2: 12, y2: 12 }),
              React.createElement('line', { x1: 12, y1: 16, x2: 12.01, y2: 16 })
            ),
            React.createElement('h2', { style: { margin: '20px 0 10px', fontSize: '24px' } }, 'Something went wrong'),
            React.createElement('p', { style: { color: 'var(--secondary-text)', marginBottom: '20px' } }, 
              this.state.error?.message || 'An unexpected error occurred'),
            React.createElement('button', {
              onClick: () => this.setState({ hasError: false, error: null }),
              style: {
                padding: '12px 24px',
                background: 'var(--accent)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontSize: '16px'
              }
            }, 'Try Again')
          );
        }
        return this.props.children;
      }
    }

    // ============================================================
    // TOAST COMPONENT
    // ============================================================
    const ToastContainer = ({ toasts, removeToast }) => {
      return React.createElement('div', { className: 'toast-container' },
        toasts.map(toast => 
          React.createElement('div', {
            key: toast.id,
            className: 'toast',
            style: {
              background: toast.type === 'error' ? 'var(--error)' : 
                         toast.type === 'success' ? 'var(--success)' : 
                         toast.type === 'warning' ? 'var(--warning)' : 'var(--surface)',
              color: toast.type !== 'info' ? 'white' : 'var(--primary-text)'
            },
            onClick: () => removeToast(toast.id)
          }, toast.message)
        )
      );
    };

    // ============================================================
    // ICONS
    // ============================================================
    const Icons = {
      home: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
        React.createElement('polyline', { points: '9 22 9 12 15 12 15 22' })
      ),
      list: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 8, y1: 6, x2: 21, y2: 6 }),
        React.createElement('line', { x1: 8, y1: 12, x2: 21, y2: 12 }),
        React.createElement('line', { x1: 8, y1: 18, x2: 21, y2: 18 }),
        React.createElement('circle', { cx: 3, cy: 6, r: 1, fill: 'currentColor' }),
        React.createElement('circle', { cx: 3, cy: 12, r: 1, fill: 'currentColor' }),
        React.createElement('circle', { cx: 3, cy: 18, r: 1, fill: 'currentColor' })
      ),
      chart: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 18, y1: 20, x2: 18, y2: 10 }),
        React.createElement('line', { x1: 12, y1: 20, x2: 12, y2: 4 }),
        React.createElement('line', { x1: 6, y1: 20, x2: 6, y2: 14 })
      ),
      settings: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('circle', { cx: 12, cy: 12, r: 3 }),
        React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' })
      ),
      plus: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 12, y1: 5, x2: 12, y2: 19 }),
        React.createElement('line', { x1: 5, y1: 12, x2: 19, y2: 12 })
      ),
      close: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 18, y1: 6, x2: 6, y2: 18 }),
        React.createElement('line', { x1: 6, y1: 6, x2: 18, y2: 18 })
      ),
      back: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polyline', { points: '15 18 9 12 15 6' })
      ),
      location: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z' }),
        React.createElement('circle', { cx: 12, cy: 10, r: 3 })
      ),
      phone: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' })
      ),
      map: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polygon', { points: '1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6' }),
        React.createElement('line', { x1: 8, y1: 2, x2: 8, y2: 18 }),
        React.createElement('line', { x1: 16, y1: 6, x2: 16, y2: 22 })
      ),
      trash: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polyline', { points: '3 6 5 6 21 6' }),
        React.createElement('path', { d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2' })
      ),
      download: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
        React.createElement('polyline', { points: '7 10 12 15 17 10' }),
        React.createElement('line', { x1: 12, y1: 15, x2: 12, y2: 3 })
      ),
      upload: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
        React.createElement('polyline', { points: '17 8 12 3 7 8' }),
        React.createElement('line', { x1: 12, y1: 3, x2: 12, y2: 15 })
      ),
      sync: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polyline', { points: '23 4 23 10 17 10' }),
        React.createElement('polyline', { points: '1 20 1 14 7 14' }),
        React.createElement('path', { d: 'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15' })
      ),
      wifi: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M5 12.55a11 11 0 0 1 14.08 0' }),
        React.createElement('path', { d: 'M1.42 9a16 16 0 0 1 21.16 0' }),
        React.createElement('path', { d: 'M8.53 16.11a6 6 0 0 1 6.95 0' }),
        React.createElement('line', { x1: 12, y1: 20, x2: 12.01, y2: 20 })
      ),
      wifiOff: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 1, y1: 1, x2: 23, y2: 23 }),
        React.createElement('path', { d: 'M16.72 11.06A10.94 10.94 0 0 1 19 12.55' }),
        React.createElement('path', { d: 'M5 12.55a10.94 10.94 0 0 1 5.17-2.39' }),
        React.createElement('path', { d: 'M10.71 5.05A16 16 0 0 1 22.58 9' }),
        React.createElement('path', { d: 'M1.42 9a15.91 15.91 0 0 1 4.7-2.88' }),
        React.createElement('path', { d: 'M8.53 16.11a6 6 0 0 1 6.95 0' }),
        React.createElement('line', { x1: 12, y1: 20, x2: 12.01, y2: 20 })
      ),
      check: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polyline', { points: '20 6 9 17 4 12' })
      ),
      filter: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polygon', { points: '22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3' })
      ),
      search: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('circle', { cx: 11, cy: 11, r: 8 }),
        React.createElement('line', { x1: 21, y1: 21, x2: 16.65, y2: 16.65 })
      ),
      edit: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { d: 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7' }),
        React.createElement('path', { d: 'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z' })
      ),
      menu: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('line', { x1: 3, y1: 12, x2: 21, y2: 12 }),
        React.createElement('line', { x1: 3, y1: 6, x2: 21, y2: 6 }),
        React.createElement('line', { x1: 3, y1: 18, x2: 21, y2: 18 })
      ),
      lock: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('rect', { x: 3, y: 11, width: 18, height: 11, rx: 2, ry: 2 }),
        React.createElement('path', { d: 'M7 11V7a5 5 0 0 1 10 0v4' })
      ),
      image: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('rect', { x: 3, y: 3, width: 18, height: 18, rx: 2, ry: 2 }),
        React.createElement('circle', { cx: 8.5, cy: 8.5, r: 1.5 }),
        React.createElement('polyline', { points: '21 15 16 10 5 21' })
      ),
      refresh: React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('polyline', { points: '1 4 1 10 7 10' }),
        React.createElement('path', { d: 'M3.51 15a9 9 0 1 0 2.13-9.36L1 10' })
      )
    };

    // ============================================================
    // CHIP SELECT COMPONENT
    // ============================================================
    const ChipSelect = ({ options, selected, onSelect, multiple = false, allowAdd = false, onAdd, placeholder = 'Type to add...' }) => {
      const [inputValue, setInputValue] = useState('');
      const [showInput, setShowInput] = useState(false);
      
      const handleSelect = (option) => {
        if (multiple) {
          const isSelected = selected.includes(option);
          onSelect(isSelected ? selected.filter(s => s !== option) : [...selected, option]);
        } else {
          onSelect(option === selected ? '' : option);
        }
      };

      const handleAdd = () => {
        if (inputValue.trim()) {
          if (onAdd) onAdd(inputValue.trim());
          handleSelect(inputValue.trim());
          setInputValue('');
          setShowInput(false);
        }
      };

      return React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px' } },
        options.map(option => 
          React.createElement('div', {
            key: option,
            className: `chip ${multiple ? (selected.includes(option) ? 'selected' : '') : (selected === option ? 'selected' : '')}`,
            onClick: () => handleSelect(option),
            role: 'button',
            'aria-pressed': multiple ? selected.includes(option) : selected === option
          }, 
          option,
          (multiple ? selected.includes(option) : selected === option) && 
            React.createElement('span', { style: { marginLeft: '4px' } }, '✓')
          )
        ),
        allowAdd && (
          showInput ? 
            React.createElement('div', { style: { display: 'flex', gap: '4px', alignItems: 'center' } },
              React.createElement('input', {
                className: 'form-input',
                style: { width: '120px', minHeight: '36px', padding: '6px 12px' },
                value: inputValue,
                onChange: (e) => setInputValue(e.target.value),
                onKeyDown: (e) => e.key === 'Enter' && handleAdd(),
                placeholder: placeholder,
                autoFocus: true
              }),
              React.createElement('button', {
                onClick: handleAdd,
                style: { background: 'var(--accent)', color: 'white', border: 'none', borderRadius: '50%', width: '32px', height: '32px', cursor: 'pointer' }
              }, '+'),
              React.createElement('button', {
                onClick: () => { setShowInput(false); setInputValue(''); },
                style: { background: 'var(--border)', color: 'var(--primary-text)', border: 'none', borderRadius: '50%', width: '32px', height: '32px', cursor: 'pointer' }
              }, '×')
            )
          :
            React.createElement('div', {
              className: 'chip',
              onClick: () => setShowInput(true),
              style: { borderStyle: 'dashed' }
            }, '+ Add Other')
        )
      );
    };

    // ============================================================
    // SLIDER INPUT COMPONENT
    // ============================================================
    const SliderInput = ({ value, onChange, min = 0, max = 1000, step = 5 }) => {
      const [localValue, setLocalValue] = useState(value);
      
      useEffect(() => {
        setLocalValue(value);
      }, [value]);

      const handleSliderChange = (e) => {
        const newValue = parseInt(e.target.value);
        setLocalValue(newValue);
        onChange(newValue);
      };

      const handleInputChange = (e) => {
        const newValue = parseInt(e.target.value) || 0;
        setLocalValue(newValue);
      };

      const handleInputBlur = () => {
        onChange(localValue);
      };

      return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
        React.createElement('input', {
          type: 'range',
          min,
          max,
          step,
          value: localValue,
          onChange: handleSliderChange,
          style: { width: '100%', accentColor: 'var(--accent)' }
        }),
        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
          React.createElement('input', {
            type: 'number',
            className: 'form-input',
            style: { width: '100px', textAlign: 'center' },
            value: localValue,
            onChange: handleInputChange,
            onBlur: handleInputBlur,
            min,
            max
          }),
          React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'bottles/month')
        )
      );
    };

    // ============================================================
    // BOTTOM NAVIGATION
    // ============================================================
    const BottomNav = ({ activeTab, onTabChange }) => {
      const tabs = [
        { id: 'home', label: 'Home', icon: Icons.home },
        { id: 'list', label: 'Surveys', icon: Icons.list },
        { id: 'analytics', label: 'Analytics', icon: Icons.chart },
        { id: 'settings', label: 'Settings', icon: Icons.settings }
      ];

      return React.createElement('nav', { className: 'bottom-nav theme-transition', 'aria-label': 'Main navigation' },
        tabs.map(tab => 
          React.createElement('button', {
            key: tab.id,
            className: `bottom-nav-item ${activeTab === tab.id ? 'active' : ''}`,
            onClick: () => onTabChange(tab.id),
            'aria-current': activeTab === tab.id ? 'page' : undefined
          },
          React.cloneElement(tab.icon, { width: 20, height: 20 }),
          React.createElement('span', { style: { fontSize: '11px' } }, tab.label)
          )
        )
      );
    };

    // ============================================================
    // HOME VIEW
    // ============================================================
    const HomeView = ({ surveys, onStartSurvey }) => {
      const { theme } = useTheme();
      const { isOnline, logo } = useApp();
      
      const todayCount = surveys.filter(s => {
        const today = new Date().toDateString();
        return new Date(s.timestamp).toDateString() === today;
      }).length;

      const wlLeads = surveys.filter(s => s.interestedInCustomLogo === 'Yes').length;

      return React.createElement('div', { 
        style: { 
          padding: '20px', 
          paddingBottom: '80px',
          minHeight: '100%',
          background: 'var(--bg)'
        } 
      },
        // Header
        React.createElement('div', { 
          style: { 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'space-between',
            marginBottom: '24px'
          } 
        },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
            logo && React.createElement('img', { 
              src: logo, 
              alt: 'Logo', 
              style: { width: '40px', height: '40px', borderRadius: '8px', objectFit: 'contain' }
            }),
            React.createElement('h1', { 
              style: { 
                fontSize: '28px', 
                fontWeight: '700', 
                color: 'var(--primary-text)' 
              } 
            }, 'Vellora')
          ),
          React.createElement('div', { 
            style: { 
              display: 'flex', 
              alignItems: 'center', 
              gap: '4px', 
              padding: '6px 12px', 
              background: isOnline ? 'var(--success)' : 'var(--warning)', 
              color: 'white', 
              borderRadius: '20px',
              fontSize: '12px'
            } 
          },
            React.cloneElement(isOnline ? Icons.wifi : Icons.wifiOff, { width: 14, height: 14 }),
            isOnline ? 'Online' : 'Offline'
          )
        ),

        // Stats Grid
        React.createElement('div', { 
          style: { 
            display: 'grid', 
            gridTemplateColumns: 'repeat(2, 1fr)', 
            gap: '12px',
            marginBottom: '24px'
          } 
        },
          [
            { label: 'Total Surveys', value: surveys.length, color: 'var(--accent)' },
            { label: "Today's Count", value: todayCount, color: 'var(--success)' },
            { label: 'WL Leads', value: wlLeads, color: 'var(--warning)' },
            { label: 'Avg Margin', value: '--', color: 'var(--secondary-text)' }
          ].map((stat, i) => 
            React.createElement('div', { 
              key: i,
              className: 'card theme-transition',
              style: { textAlign: 'center', padding: '20px' }
            },
              React.createElement('div', { 
                style: { fontSize: '32px', fontWeight: '700', color: stat.color } 
              }, stat.value),
              React.createElement('div', { 
                style: { fontSize: '12px', color: 'var(--secondary-text)', marginTop: '4px' } 
              }, stat.label)
            )
          )
        ),

        // Quick Actions
        React.createElement('h2', { 
          style: { 
            fontSize: '18px', 
            fontWeight: '600', 
            color: 'var(--primary-text)',
            marginBottom: '12px'
          } 
        }, 'Quick Actions'),
        React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
          React.createElement('button', {
            onClick: onStartSurvey,
            style: {
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              padding: '16px',
              background: 'var(--accent)',
              color: 'white',
              border: 'none',
              borderRadius: '12px',
              cursor: 'pointer',
              fontSize: '16px',
              fontWeight: '500'
            }
          },
            React.cloneElement(Icons.plus, { width: 20, height: 20 }),
            'Start New Survey'
          )
        )
      );
    };

    // ============================================================
    // SURVEY LIST VIEW
    // ============================================================
    const SurveyListView = ({ surveys, onViewDetail }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [showFilters, setShowFilters] = useState(false);
      const [filters, setFilters] = useState({});

      const filteredSurveys = surveys.filter(survey => {
        if (searchTerm) {
          const search = searchTerm.toLowerCase();
          if (!survey.businessName?.toLowerCase().includes(search) &&
              !survey.locationArea?.toLowerCase().includes(search)) {
            return false;
          }
        }
        return true;
      });

      return React.createElement('div', { 
        style: { 
          display: 'flex', 
          flexDirection: 'column', 
          height: '100%',
          background: 'var(--bg)'
        } 
      },
        // Search Header
        React.createElement('div', { 
          style: { 
            padding: '16px', 
            borderBottom: '1px solid var(--border)',
            background: 'var(--surface)'
          } 
        },
          React.createElement('div', { style: { display: 'flex', gap: '8px' } },
            React.createElement('div', { 
              style: { 
                flex: 1, 
                position: 'relative' 
              } 
            },
              React.createElement('input', {
                className: 'form-input',
                placeholder: 'Search surveys...',
                value: searchTerm,
                onChange: (e) => setSearchTerm(e.target.value),
                style: { paddingLeft: '40px' }
              }),
              React.createElement('span', { 
                style: { 
                  position: 'absolute', 
                  left: '12px', 
                  top: '50%', 
                  transform: 'translateY(-50%)',
                  color: 'var(--placeholder)'
                } 
              }, React.cloneElement(Icons.search, { width: 18, height: 18 }))
            ),
            React.createElement('button', {
              onClick: () => setShowFilters(!showFilters),
              style: {
                padding: '12px',
                background: showFilters ? 'var(--accent)' : 'var(--surface)',
                color: showFilters ? 'white' : 'var(--primary-text)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                cursor: 'pointer'
              }
            }, Icons.filter)
          )
        ),

        // Survey List
        React.createElement('div', { 
          style: { 
            flex: 1, 
            overflow: 'auto', 
            padding: '16px',
            paddingBottom: '80px'
          } 
        },
          filteredSurveys.length === 0 ? 
            React.createElement('div', { 
              style: { 
                textAlign: 'center', 
                padding: '40px', 
                color: 'var(--secondary-text)' 
              } 
            }, 'No surveys found')
          :
            React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
              filteredSurveys.map(survey => 
                React.createElement('div', {
                  key: survey.id,
                  className: 'card theme-transition',
                  onClick: () => onViewDetail(survey),
                  style: { cursor: 'pointer' }
                },
                  React.createElement('div', { 
                    style: { 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'flex-start',
                      marginBottom: '8px'
                    } 
                  },
                    React.createElement('h3', { 
                      style: { 
                        fontSize: '16px', 
                        fontWeight: '600', 
                        color: 'var(--primary-text)' 
                      } 
                    }, survey.businessName || 'Unnamed Business'),
                    React.createElement('span', { 
                      style: { 
                        fontSize: '12px', 
                        color: 'var(--secondary-text)' 
                      } 
                    }, formatDate(survey.timestamp))
                  ),
                  React.createElement('div', { 
                    style: { 
                      fontSize: '14px', 
                      color: 'var(--secondary-text)',
                      marginBottom: '8px'
                    } 
                  }, survey.locationArea || 'Unknown Location'),
                  React.createElement('div', { style: { display: 'flex', gap: '6px', flexWrap: 'wrap' } },
                    survey.interestedInCustomLogo === 'Yes' && 
                      React.createElement('span', { className: 'badge wl' }, 'WL Lead'),
                    !survey.contactMobile && 
                      React.createElement('span', { className: 'badge missing' }, 'Missing Contact'),
                    survey.metadata?.offline && 
                      React.createElement('span', { className: 'badge offline' }, 'Offline')
                  )
                )
              )
            )
        )
      );
    };

    // ============================================================
    // SURVEY DETAIL MODAL
    // ============================================================
    const SurveyDetailModal = ({ survey, onClose, onDelete, onExport }) => {
      const { toast } = useToast();

      const handleCall = () => {
        if (survey.contactMobile) {
          window.open(`tel:${survey.contactMobile}`, '_self');
        } else {
          toast('No contact number available', 'warning');
        }
      };

      const handleDirections = () => {
        if (survey.gps?.lat && survey.gps?.lng) {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const url = isIOS 
            ? `http://maps.apple.com/?daddr=${survey.gps.lat},${survey.gps.lng}&dirflg=d`
            : `https://www.google.com/maps/dir/?api=1&destination=${survey.gps.lat},${survey.gps.lng}&travelmode=driving`;
          window.open(url, '_blank', 'noopener');
        } else {
          toast('No GPS coordinates available', 'warning');
        }
      };

      return React.createElement('div', { 
        className: 'modal-backdrop',
        onClick: (e) => e.target === e.currentTarget && onClose()
      },
        React.createElement('div', { 
          style: { 
            background: 'var(--bg)', 
            borderRadius: '16px', 
            width: '90%', 
            maxWidth: '500px',
            maxHeight: '85vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column'
          } 
        },
          // Header
          React.createElement('div', { 
            style: { 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between',
              padding: '16px',
              borderBottom: '1px solid var(--border)'
            } 
          },
            React.createElement('h2', { 
              style: { 
                fontSize: '18px', 
                fontWeight: '600', 
                color: 'var(--primary-text)' 
              } 
            }, survey.businessName || 'Survey Details'),
            React.createElement('button', {
              onClick: onClose,
              style: { background: 'none', border: 'none', cursor: 'pointer', color: 'var(--secondary-text)' }
            }, Icons.close)
          ),

          // Content
          React.createElement('div', { 
            id: 'survey-detail-content',
            style: { 
              flex: 1, 
              overflow: 'auto', 
              padding: '16px' 
            } 
          },
            // Business Info
            React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--secondary-text)',
                  marginBottom: '8px'
                } 
              }, 'Business Information'),
              React.createElement('div', { className: 'card' },
                [
                  { label: 'Business Type', value: survey.businessType },
                  { label: 'Location', value: survey.locationArea },
                  { label: 'GPS', value: survey.gps?.lat ? `${survey.gps.lat.toFixed(4)}, ${survey.gps.lng.toFixed(4)}` : '--' },
                  { label: 'Contact', value: survey.contactName },
                  { label: 'Mobile', value: survey.contactMobile }
                ].map((item, i) => 
                  React.createElement('div', { 
                    key: i,
                    style: { 
                      display: 'flex', 
                      justifyContent: 'space-between',
                      padding: '8px 0',
                      borderBottom: i < 4 ? '1px solid var(--border)' : 'none'
                    } 
                  },
                    React.createElement('span', { style: { color: 'var(--secondary-text)' } }, item.label),
                    React.createElement('span', { style: { color: 'var(--primary-text)', fontWeight: '500' } }, item.value || '--')
                  )
                )
              )
            ),

            // Brands & Sizes
            survey.brands?.length > 0 && React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--secondary-text)',
                  marginBottom: '8px'
                } 
              }, 'Products'),
              React.createElement('div', { className: 'card' },
                React.createElement('div', { style: { marginBottom: '12px' } },
                  React.createElement('div', { style: { fontSize: '12px', color: 'var(--secondary-text)', marginBottom: '4px' } }, 'Brands'),
                  React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '4px' } },
                    survey.brands.map((brand, i) => 
                      React.createElement('span', { 
                        key: i,
                        style: { 
                          padding: '4px 8px', 
                          background: 'var(--accent)', 
                          color: 'white',
                          borderRadius: '4px',
                          fontSize: '12px'
                        }
                      }, brand)
                    )
                  )
                ),
                survey.bottleSizes?.length > 0 && React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '12px', color: 'var(--secondary-text)', marginBottom: '4px' } }, 'Sizes'),
                  React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '4px' } },
                    survey.bottleSizes.map((size, i) => 
                      React.createElement('span', { 
                        key: i,
                        style: { 
                          padding: '4px 8px', 
                          background: 'var(--surface)', 
                          border: '1px solid var(--border)',
                          borderRadius: '4px',
                          fontSize: '12px',
                          color: 'var(--primary-text)'
                        }
                      }, size)
                    )
                  )
                ),
                React.createElement('div', { 
                  style: { 
                    marginTop: '12px',
                    padding: '8px 0',
                    borderTop: '1px solid var(--border)',
                    display: 'flex',
                    justifyContent: 'space-between'
                  } 
                },
                  React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'Monthly Quantity'),
                  React.createElement('span', { style: { color: 'var(--primary-text)', fontWeight: '500' } }, `${survey.qtyMonthly || 0} bottles`)
                )
              )
            ),

            // Pricing Matrix
            Object.keys(survey.buyingPrice || {}).length > 0 && React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--secondary-text)',
                  marginBottom: '8px'
                } 
              }, 'Pricing Matrix'),
              React.createElement('div', { className: 'matrix-container card', style: { padding: '8px' } },
                React.createElement('table', { 
                  className: 'matrix-table',
                  style: { width: '100%', borderCollapse: 'collapse', fontSize: '12px' }
                },
                  React.createElement('thead', null,
                    React.createElement('tr', null,
                      React.createElement('th', { style: { padding: '8px', textAlign: 'left', color: 'var(--secondary-text)' } }, 'Brand/Size'),
                      ...(survey.bottleSizes || []).map((size, i) => 
                        React.createElement('th', { 
                          key: i,
                          style: { padding: '8px', textAlign: 'center', color: 'var(--secondary-text)' }
                        }, size)
                      )
                    )
                  ),
                  React.createElement('tbody', null,
                    (survey.brands || []).map((brand, i) => 
                      React.createElement('tr', { key: i },
                        React.createElement('td', { 
                          style: { 
                            padding: '8px', 
                            fontWeight: '500',
                            color: 'var(--primary-text)'
                          } 
                        }, brand),
                        ...(survey.bottleSizes || []).map((size, j) => {
                          const key = `${brand}|${size}`;
                          const buy = survey.buyingPrice?.[key] || '--';
                          const sell = survey.sellingPrice?.[key] || '--';
                          const profit = survey.profitPerBottle?.[key] || '--';
                          return React.createElement('td', { 
                            key: j,
                            style: { padding: '8px', textAlign: 'center' }
                          },
                            React.createElement('div', { style: { fontSize: '11px', color: 'var(--secondary-text)' } }, `B: ${buy}`),
                            React.createElement('div', { style: { fontSize: '11px', color: 'var(--secondary-text)' } }, `S: ${sell}`),
                            React.createElement('div', { style: { fontSize: '11px', color: 'var(--success)', fontWeight: '500' } }, `P: ${profit}`)
                          );
                        })
                      )
                    )
                  )
                )
              )
            ),

            // Distributor Info
            survey.distributorName && React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--secondary-text)',
                  marginBottom: '8px'
                } 
              }, 'Distributor'),
              React.createElement('div', { className: 'card' },
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '8px' } },
                  React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'Name'),
                  React.createElement('span', { style: { color: 'var(--primary-text)' } }, survey.distributorName)
                ),
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '8px' } },
                  React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'Happy with Service'),
                  React.createElement('span', { 
                    style: { 
                      color: survey.happyWithService === 'Yes' ? 'var(--success)' : 'var(--error)' 
                    } 
                  }, survey.happyWithService || '--')
                ),
                survey.mainProblems?.length > 0 && React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '12px', color: 'var(--secondary-text)', marginBottom: '4px' } }, 'Problems'),
                  React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '4px' } },
                    survey.mainProblems.map((problem, i) => 
                      React.createElement('span', { 
                        key: i,
                        style: { 
                          padding: '4px 8px', 
                          background: 'var(--error)', 
                          color: 'white',
                          borderRadius: '4px',
                          fontSize: '12px'
                        }
                      }, problem)
                    )
                  )
                )
              )
            ),

            // White Label
            survey.interestedInCustomLogo === 'Yes' && React.createElement('div', { style: { marginBottom: '20px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--secondary-text)',
                  marginBottom: '8px'
                } 
              }, 'White Label Interest'),
              React.createElement('div', { className: 'card' },
                React.createElement('span', { className: 'badge wl', style: { marginBottom: '12px' } }, 'Interested in Custom Logo'),
                survey.extraWillingToPay && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '8px' } },
                  React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'Extra Willing to Pay'),
                  React.createElement('span', { style: { color: 'var(--primary-text)' } }, survey.extraWillingToPay)
                ),
                survey.customPurpose && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between' } },
                  React.createElement('span', { style: { color: 'var(--secondary-text)' } }, 'Purpose'),
                  React.createElement('span', { style: { color: 'var(--primary-text)' } }, survey.customPurpose)
                )
              )
            )
          ),

          // Actions Footer
          React.createElement('div', { 
            style: { 
              padding: '16px',
              borderTop: '1px solid var(--border)',
              display: 'flex',
              gap: '8px',
              flexWrap: 'wrap'
            } 
          },
            React.createElement('button', {
              onClick: handleCall,
              style: {
                flex: 1,
                padding: '12px',
                background: 'var(--success)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '6px'
              }
            }, Icons.phone, 'Call'),
            React.createElement('button', {
              onClick: handleDirections,
              style: {
                flex: 1,
                padding: '12px',
                background: 'var(--accent)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '6px'
              }
            }, Icons.map, 'Directions'),
            React.createElement('button', {
              onClick: () => onExport(survey, 'pdf'),
              style: {
                flex: 1,
                padding: '12px',
                background: 'var(--surface)',
                color: 'var(--primary-text)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '6px'
              }
            }, Icons.download, 'Export'),
            React.createElement('button', {
              onClick: () => onDelete(survey),
              style: {
                padding: '12px',
                background: 'var(--error)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer'
              }
            }, Icons.trash)
          )
        )
      );
    };

    // ============================================================
    // SURVEY WIZARD
    // ============================================================
    const SurveyWizard = ({ masterData, onSave, onCancel, onUpdateMaster }) => {
      const { toast } = useToast();
      const [step, setStep] = useState(0);
      const [formData, setFormData] = useState({
        id: generateUUID(),
        businessName: '',
        businessType: '',
        footfall: '',
        locationArea: '',
        gps: { lat: 0, lng: 0 },
        brands: [],
        bottleSizes: [],
        qtyMonthly: 100,
        buyingPrice: {},
        sellingPrice: {},
        profitPerBottle: {},
        distributorName: '',
        distributorType: '',
        happyWithService: '',
        mainProblems: [],
        vendorName: '',
        vendorMobile: '',
        companyDetails: '',
        interestedInCustomLogo: '',
        extraWillingToPay: '',
        customPurpose: '',
        contactName: '',
        contactMobile: ''
      });
      const [gettingLocation, setGettingLocation] = useState(false);

      const steps = [
        { id: 'business', title: 'Business Profile' },
        { id: 'water', title: 'Water Usage' },
        { id: 'pricing', title: 'Pricing Matrix' },
        { id: 'distributor', title: 'Distributor' },
        { id: 'whitelabel', title: 'White Label' },
        { id: 'closing', title: 'Closing' }
      ];

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      const getLocation = async () => {
        setGettingLocation(true);
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            });
          });
          
          const { latitude, longitude } = position.coords;
          updateField('gps', { lat: latitude, lng: longitude });
          
          // Try reverse geocoding
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
            );
            const data = await response.json();
            if (data.display_name) {
              updateField('locationArea', data.display_name.split(',').slice(0, 3).join(', '));
            }
          } catch (e) {
            console.warn('Reverse geocoding failed:', e);
          }
          
          toast('Location captured successfully', 'success');
        } catch (error) {
          toast('Could not get location. Please enter manually.', 'warning');
        }
        setGettingLocation(false);
      };

      const addToMaster = (key, value) => {
        const current = masterData[key] || [];
        if (!current.some(item => item.toLowerCase() === value.toLowerCase())) {
          onUpdateMaster(key, [...current, value]);
        }
      };

      const updatePricing = (brand, size, type, value) => {
        const key = `${brand}|${size}`;
        const numValue = parseFloat(value) || 0;
        
        setFormData(prev => {
          const updated = { ...prev };
          updated[type] = { ...updated[type], [key]: numValue };
          
          // Calculate profit
          if (type === 'buyingPrice' || type === 'sellingPrice') {
            const buy = type === 'buyingPrice' ? numValue : (updated.buyingPrice[key] || 0);
            const sell = type === 'sellingPrice' ? numValue : (updated.sellingPrice[key] || 0);
            updated.profitPerBottle = { ...updated.profitPerBottle, [key]: sell - buy };
          }
          
          return updated;
        });
      };

      const validateStep = () => {
        switch (step) {
          case 0:
            return formData.businessName.trim().length > 0;
          case 5:
            return formData.contactMobile && validatePhone(formData.contactMobile);
          default:
            return true;
        }
      };

      const handleNext = () => {
        if (!validateStep()) {
          if (step === 0) toast('Business name is required', 'error');
          if (step === 5) toast('Valid contact mobile is required', 'error');
          return;
        }
        if (step < steps.length - 1) {
          setStep(step + 1);
        } else {
          handleSave();
        }
      };

      const handleSave = () => {
        const survey = {
          ...formData,
          timestamp: new Date().toISOString(),
          formVersion: '1.0',
          syncCode: getSyncCode(),
          metadata: {
            createdBy: 'user',
            deviceId: getDeviceId(),
            offline: !navigator.onLine
          }
        };
        onSave(survey);
      };

      const footfallOptions = ['0-50', '50-100', '100-200', '200-500', '500+', 'Other'];
      const extraPayOptions = ['5%', '10%', '15%', '20%', 'Other'];

      const renderStep = () => {
        switch (step) {
          case 0: // Business Profile
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '20px' } },
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Business Name *'),
                React.createElement('input', {
                  className: 'form-input',
                  placeholder: 'Enter business name',
                  value: formData.businessName,
                  onChange: (e) => updateField('businessName', e.target.value)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Business Type'),
                React.createElement(ChipSelect, {
                  options: masterData.businessTypes || [],
                  selected: formData.businessType,
                  onSelect: (val) => updateField('businessType', val),
                  allowAdd: true,
                  onAdd: (val) => addToMaster('businessTypes', val)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Estimated Daily Footfall'),
                React.createElement(ChipSelect, {
                  options: footfallOptions,
                  selected: formData.footfall,
                  onSelect: (val) => updateField('footfall', val)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Location'),
                React.createElement('input', {
                  className: 'form-input',
                  placeholder: 'Enter location area',
                  value: formData.locationArea,
                  onChange: (e) => updateField('locationArea', e.target.value),
                  style: { marginBottom: '12px' }
                }),
                React.createElement('button', {
                  onClick: getLocation,
                  disabled: gettingLocation,
                  style: {
                    width: '100%',
                    padding: '12px',
                    background: 'var(--surface)',
                    color: 'var(--primary-text)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    cursor: gettingLocation ? 'wait' : 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }
                },
                  gettingLocation ? 
                    React.createElement('span', { className: 'spinner' }) :
                    Icons.location,
                  gettingLocation ? 'Getting Location...' : 'Get GPS Location'
                ),
                formData.gps.lat !== 0 && React.createElement('div', { 
                  style: { 
                    marginTop: '8px', 
                    fontSize: '12px', 
                    color: 'var(--secondary-text)' 
                  } 
                }, `GPS: ${formData.gps.lat.toFixed(4)}, ${formData.gps.lng.toFixed(4)}`)
              )
            );

          case 1: // Water Usage
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '20px' } },
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Water Brands Used'),
                React.createElement(ChipSelect, {
                  options: masterData.brands || [],
                  selected: formData.brands,
                  onSelect: (val) => updateField('brands', val),
                  multiple: true,
                  allowAdd: true,
                  onAdd: (val) => addToMaster('brands', val)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Bottle Sizes'),
                React.createElement(ChipSelect, {
                  options: masterData.bottleSizes || [],
                  selected: formData.bottleSizes,
                  onSelect: (val) => updateField('bottleSizes', val),
                  multiple: true,
                  allowAdd: true,
                  onAdd: (val) => addToMaster('bottleSizes', val)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Monthly Quantity'),
                React.createElement(SliderInput, {
                  value: formData.qtyMonthly,
                  onChange: (val) => updateField('qtyMonthly', val),
                  min: 0,
                  max: 1000,
                  step: 5
                })
              )
            );

          case 2: // Pricing Matrix
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '16px' } },
              formData.brands.length === 0 || formData.bottleSizes.length === 0 ?
                React.createElement('div', { 
                  style: { 
                    textAlign: 'center', 
                    padding: '40px', 
                    color: 'var(--secondary-text)' 
                  } 
                }, 'Please select brands and sizes in the previous step')
              :
                React.createElement('div', { className: 'matrix-container' },
                  React.createElement('table', { 
                    className: 'matrix-table',
                    style: { width: '100%', borderCollapse: 'collapse' }
                  },
                    React.createElement('thead', null,
                      React.createElement('tr', null,
                        React.createElement('th', { 
                          style: { 
                            padding: '12px', 
                            textAlign: 'left', 
                            background: 'var(--surface)',
                            color: 'var(--secondary-text)',
                            fontSize: '12px'
                          } 
                        }, 'Brand'),
                        ...formData.bottleSizes.map((size, i) => 
                          React.createElement('th', { 
                            key: i,
                            style: { 
                              padding: '12px', 
                              textAlign: 'center', 
                              background: 'var(--surface)',
                              color: 'var(--secondary-text)',
                              fontSize: '12px',
                              minWidth: '100px'
                            }
                          }, size)
                        )
                      )
                    ),
                    React.createElement('tbody', null,
                      formData.brands.map((brand, i) => 
                        React.createElement('tr', { key: i },
                          React.createElement('td', { 
                            style: { 
                              padding: '12px', 
                              fontWeight: '500',
                              background: 'var(--surface)',
                              color: 'var(--primary-text)',
                              fontSize: '14px'
                            } 
                          }, brand),
                          ...formData.bottleSizes.map((size, j) => {
                            const key = `${brand}|${size}`;
                            return React.createElement('td', { 
                              key: j,
                              style: { padding: '8px', verticalAlign: 'top' }
                            },
                              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                                React.createElement('input', {
                                  type: 'number',
                                  className: 'form-input',
                                  placeholder: 'Buy',
                                  value: formData.buyingPrice[key] || '',
                                  onChange: (e) => updatePricing(brand, size, 'buyingPrice', e.target.value),
                                  style: { padding: '8px', fontSize: '12px', minHeight: '36px' }
                                }),
                                React.createElement('input', {
                                  type: 'number',
                                  className: 'form-input',
                                  placeholder: 'Sell',
                                  value: formData.sellingPrice[key] || '',
                                  onChange: (e) => updatePricing(brand, size, 'sellingPrice', e.target.value),
                                  style: { padding: '8px', fontSize: '12px', minHeight: '36px' }
                                }),
                                formData.profitPerBottle[key] !== undefined && React.createElement('div', {
                                  style: {
                                    fontSize: '11px',
                                    color: formData.profitPerBottle[key] >= 0 ? 'var(--success)' : 'var(--error)',
                                    textAlign: 'center'
                                  }
                                }, `Profit: ${formData.profitPerBottle[key]}`)
                              )
                            );
                          })
                        )
                      )
                    )
                  )
                )
            );

          case 3: // Distributor
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '20px' } },
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Distributor Type'),
                React.createElement(ChipSelect, {
                  options: masterData.distributors || [],
                  selected: formData.distributorName,
                  onSelect: (val) => {
                    updateField('distributorName', val);
                    updateField('distributorType', val);
                  },
                  allowAdd: true,
                  onAdd: (val) => addToMaster('distributors', val)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Happy with Service?'),
                React.createElement('div', { style: { display: 'flex', gap: '12px' } },
                  ['Yes', 'No'].map(option => 
                    React.createElement('button', {
                      key: option,
                      onClick: () => updateField('happyWithService', option),
                      style: {
                        flex: 1,
                        padding: '12px',
                        background: formData.happyWithService === option ? 
                          (option === 'Yes' ? 'var(--success)' : 'var(--error)') : 
                          'var(--surface)',
                        color: formData.happyWithService === option ? 'white' : 'var(--primary-text)',
                        border: '1px solid var(--border)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '500'
                      }
                    }, option)
                  )
                )
              ),
              formData.happyWithService === 'No' && React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Main Problems'),
                React.createElement(ChipSelect, {
                  options: masterData.problems || [],
                  selected: formData.mainProblems,
                  onSelect: (val) => updateField('mainProblems', val),
                  multiple: true,
                  allowAdd: true,
                  onAdd: (val) => addToMaster('problems', val)
                })
              ),
              formData.distributorType === 'Local Vendor' && React.createElement(React.Fragment, null,
                React.createElement('div', null,
                  React.createElement('label', { 
                    style: { 
                      display: 'block', 
                      marginBottom: '8px', 
                      fontWeight: '500',
                      color: 'var(--primary-text)'
                    } 
                  }, 'Vendor Name'),
                  React.createElement('input', {
                    className: 'form-input',
                    placeholder: 'Enter vendor name',
                    value: formData.vendorName,
                    onChange: (e) => updateField('vendorName', e.target.value)
                  })
                ),
                React.createElement('div', null,
                  React.createElement('label', { 
                    style: { 
                      display: 'block', 
                      marginBottom: '8px', 
                      fontWeight: '500',
                      color: 'var(--primary-text)'
                    } 
                  }, 'Vendor Mobile'),
                  React.createElement('input', {
                    className: 'form-input',
                    type: 'tel',
                    placeholder: 'Enter vendor mobile',
                    value: formData.vendorMobile,
                    onChange: (e) => updateField('vendorMobile', e.target.value)
                  })
                )
              ),
              formData.distributorType === 'Direct Company' && React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Company Details'),
                React.createElement('textarea', {
                  className: 'form-input',
                  placeholder: 'Enter company details',
                  value: formData.companyDetails,
                  onChange: (e) => updateField('companyDetails', e.target.value),
                  style: { minHeight: '80px', resize: 'vertical' }
                })
              )
            );

          case 4: // White Label
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '20px' } },
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Interested in Custom Logo Water?'),
                React.createElement('div', { style: { display: 'flex', gap: '12px' } },
                  ['Yes', 'No'].map(option => 
                    React.createElement('button', {
                      key: option,
                      onClick: () => updateField('interestedInCustomLogo', option),
                      style: {
                        flex: 1,
                        padding: '12px',
                        background: formData.interestedInCustomLogo === option ? 'var(--accent)' : 'var(--surface)',
                        color: formData.interestedInCustomLogo === option ? 'white' : 'var(--primary-text)',
                        border: '1px solid var(--border)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '500'
                      }
                    }, option)
                  )
                )
              ),
              formData.interestedInCustomLogo === 'Yes' && React.createElement(React.Fragment, null,
                React.createElement('div', null,
                  React.createElement('label', { 
                    style: { 
                      display: 'block', 
                      marginBottom: '8px', 
                      fontWeight: '500',
                      color: 'var(--primary-text)'
                    } 
                  }, 'Extra Willing to Pay'),
                  React.createElement(ChipSelect, {
                    options: extraPayOptions,
                    selected: formData.extraWillingToPay,
                    onSelect: (val) => updateField('extraWillingToPay', val)
                  })
                ),
                React.createElement('div', null,
                  React.createElement('label', { 
                    style: { 
                      display: 'block', 
                      marginBottom: '8px', 
                      fontWeight: '500',
                      color: 'var(--primary-text)'
                    } 
                  }, 'Purpose'),
                  React.createElement(ChipSelect, {
                    options: masterData.whiteLabelPurposes || [],
                    selected: formData.customPurpose,
                    onSelect: (val) => updateField('customPurpose', val),
                    allowAdd: true,
                    onAdd: (val) => addToMaster('whiteLabelPurposes', val)
                  })
                )
              )
            );

          case 5: // Closing
            return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '20px' } },
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Contact Name'),
                React.createElement('input', {
                  className: 'form-input',
                  placeholder: 'Enter contact name',
                  value: formData.contactName,
                  onChange: (e) => updateField('contactName', e.target.value)
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { 
                  style: { 
                    display: 'block', 
                    marginBottom: '8px', 
                    fontWeight: '500',
                    color: 'var(--primary-text)'
                  } 
                }, 'Contact Mobile *'),
                React.createElement('input', {
                  className: 'form-input',
                  type: 'tel',
                  placeholder: 'Enter contact mobile',
                  value: formData.contactMobile,
                  onChange: (e) => updateField('contactMobile', e.target.value)
                }),
                formData.contactMobile && !validatePhone(formData.contactMobile) && 
                  React.createElement('div', { 
                    style: { 
                      color: 'var(--error)', 
                      fontSize: '12px', 
                      marginTop: '4px' 
                    } 
                  }, 'Please enter a valid phone number')
              ),
              React.createElement('div', { 
                className: 'card',
                style: { marginTop: '12px' }
              },
                React.createElement('h4', { 
                  style: { 
                    fontSize: '14px', 
                    fontWeight: '600', 
                    color: 'var(--secondary-text)',
                    marginBottom: '12px'
                  } 
                }, 'Summary'),
                [
                  { label: 'Business', value: formData.businessName },
                  { label: 'Location', value: formData.locationArea },
                  { label: 'GPS', value: formData.gps.lat ? `${formData.gps.lat.toFixed(4)}, ${formData.gps.lng.toFixed(4)}` : 'Not captured' }
                ].map((item, i) => 
                  React.createElement('div', { 
                    key: i,
                    style: { 
                      display: 'flex', 
                      justifyContent: 'space-between',
                      padding: '6px 0',
                      fontSize: '14px'
                    } 
                  },
                    React.createElement('span', { style: { color: 'var(--secondary-text)' } }, item.label),
                    React.createElement('span', { style: { color: 'var(--primary-text)' } }, item.value || '--')
                  )
                )
              )
            );

          default:
            return null;
        }
      };

      return React.createElement('div', { 
        style: { 
          position: 'fixed',
          inset: 0,
          background: 'var(--bg)',
          display: 'flex',
          flexDirection: 'column',
          zIndex: 200
        } 
      },
        // Header
        React.createElement('div', { 
          style: { 
            display: 'flex', 
            alignItems: 'center', 
            padding: '16px',
            borderBottom: '1px solid var(--border)'
          } 
        },
          React.createElement('button', {
            onClick: onCancel,
            style: { background: 'none', border: 'none', cursor: 'pointer', color: 'var(--secondary-text)' }
          }, Icons.close),
          React.createElement('div', { style: { flex: 1, marginLeft: '12px' } },
            React.createElement('h2', { 
              style: { 
                fontSize: '18px', 
                fontWeight: '600', 
                color: 'var(--primary-text)' 
              } 
            }, steps[step].title),
            React.createElement('div', { 
              style: { 
                fontSize: '12px', 
                color: 'var(--secondary-text)' 
              } 
            }, `Step ${step + 1} of ${steps.length}`)
          )
        ),

        // Progress bar
        React.createElement('div', { className: 'progress-bar' },
          React.createElement('div', { 
            className: 'progress-fill',
            style: { width: `${((step + 1) / steps.length) * 100}%` }
          })
        ),

        // Content
        React.createElement('div', { 
          style: { 
            flex: 1, 
            overflow: 'auto', 
            padding: '20px' 
          } 
        }, renderStep()),

        // Footer
        React.createElement('div', { className: 'wizard-footer theme-transition' },
          step > 0 && React.createElement('button', {
            onClick: () => setStep(step - 1),
            style: {
              padding: '12px 20px',
              background: 'var(--surface)',
              color: 'var(--primary-text)',
              border: '1px solid var(--border)',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '14px'
            }
          }, 'Back'),
          React.createElement('button', {
            onClick: handleNext,
            style: {
              flex: 1,
              padding: '12px 20px',
              background: 'var(--accent)',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '16px',
              fontWeight: '500'
            }
          }, step === steps.length - 1 ? 'Save Survey' : 'Next')
        )
      );
    };

    // ============================================================
    // SETTINGS VIEW
    // ============================================================
    const SettingsView = ({ onExport, onForceSync }) => {
      const { theme, setTheme } = useTheme();
      const { logo, setLogo, syncCode, setSyncCode: updateSyncCode } = useApp();
      const { toast } = useToast();
      const [showAdvanced, setShowAdvanced] = useState(false);
      const [newSyncCode, setNewSyncCode] = useState(syncCode);
      const fileInputRef = useRef(null);

      const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          if (!['image/png', 'image/jpeg', 'image/svg+xml'].includes(file.type)) {
            toast('Please upload PNG, JPG, or SVG', 'error');
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            setLogo(event.target.result);
            localStorage.setItem('vellora_logo', event.target.result);
            toast('Logo uploaded successfully', 'success');
          };
          reader.readAsDataURL(file);
        }
      };

      const handleSyncCodeChange = () => {
        if (newSyncCode.trim()) {
          updateSyncCode(newSyncCode.trim());
          setSyncCode(newSyncCode.trim());
          toast('Workspace code updated', 'success');
        }
      };

      return React.createElement('div', { 
        style: { 
          padding: '20px', 
          paddingBottom: '80px',
          minHeight: '100%',
          background: 'var(--bg)',
          overflow: 'auto'
        } 
      },
        React.createElement('h1', { 
          style: { 
            fontSize: '24px', 
            fontWeight: '700', 
            color: 'var(--primary-text)',
            marginBottom: '24px'
          } 
        }, 'Settings'),

        // Export Section
        React.createElement('div', { className: 'card', style: { marginBottom: '16px' } },
          React.createElement('h3', { 
            style: { 
              fontSize: '16px', 
              fontWeight: '600', 
              color: 'var(--primary-text)',
              marginBottom: '12px'
            } 
          }, 'Export Data'),
          React.createElement('button', {
            onClick: () => onExport(),
            style: {
              width: '100%',
              padding: '12px',
              background: 'var(--accent)',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px'
            }
          }, Icons.download, 'Export All Data')
        ),

        // Logo Upload
        React.createElement('div', { className: 'card', style: { marginBottom: '16px' } },
          React.createElement('h3', { 
            style: { 
              fontSize: '16px', 
              fontWeight: '600', 
              color: 'var(--primary-text)',
              marginBottom: '12px'
            } 
          }, 'Logo'),
          logo && React.createElement('div', { 
            style: { 
              marginBottom: '12px', 
              display: 'flex', 
              alignItems: 'center', 
              gap: '12px' 
            } 
          },
            React.createElement('img', { 
              src: logo, 
              alt: 'Current logo',
              style: { width: '48px', height: '48px', objectFit: 'contain', borderRadius: '8px' }
            }),
            React.createElement('button', {
              onClick: () => { setLogo(null); localStorage.removeItem('vellora_logo'); toast('Logo removed', 'info'); },
              style: {
                padding: '8px 16px',
                background: 'var(--error)',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '12px'
              }
            }, 'Remove')
          ),
          React.createElement('input', {
            type: 'file',
            ref: fileInputRef,
            onChange: handleLogoUpload,
            accept: 'image/png,image/jpeg,image/svg+xml',
            style: { display: 'none' }
          }),
          React.createElement('button', {
            onClick: () => fileInputRef.current?.click(),
            style: {
              width: '100%',
              padding: '12px',
              background: 'var(--surface)',
              color: 'var(--primary-text)',
              border: '1px solid var(--border)',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px'
            }
          }, Icons.upload, 'Upload Logo')
        ),

        // Theme Selector
        React.createElement('div', { className: 'card', style: { marginBottom: '16px' } },
          React.createElement('h3', { 
            style: { 
              fontSize: '16px', 
              fontWeight: '600', 
              color: 'var(--primary-text)',
              marginBottom: '12px'
            } 
          }, 'Theme'),
          React.createElement('div', { 
            style: { 
              display: 'grid', 
              gridTemplateColumns: 'repeat(2, 1fr)', 
              gap: '8px' 
            } 
          },
            Object.entries(THEMES).map(([key, t]) => 
              React.createElement('button', {
                key: key,
                onClick: () => setTheme(key),
                style: {
                  padding: '12px',
                  background: t.bg,
                  color: t.primaryText,
                  border: theme === key ? `2px solid ${t.accent}` : '1px solid ' + t.border,
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }
              },
                React.createElement('div', { 
                  style: { 
                    width: '16px', 
                    height: '16px', 
                    borderRadius: '50%', 
                    background: t.accent 
                  } 
                }),
                t.name
              )
            )
          ),
          // Contrast test for Obsidian
          theme === 'obsidian' && React.createElement('div', { 
            style: { 
              marginTop: '12px', 
              padding: '12px', 
              background: THEMES.obsidian.surface,
              borderRadius: '8px'
            } 
          },
            React.createElement('p', { style: { color: THEMES.obsidian.primaryText, marginBottom: '4px' } }, 'Primary Text Sample'),
            React.createElement('p', { style: { color: THEMES.obsidian.secondaryText, marginBottom: '4px' } }, 'Secondary Text Sample'),
            React.createElement('input', { 
              className: 'form-input',
              placeholder: 'Placeholder sample',
              readOnly: true,
              style: { 
                background: THEMES.obsidian.inputBg,
                color: THEMES.obsidian.primaryText,
                border: `1px solid ${THEMES.obsidian.border}`
              }
            })
          )
        ),

        // Advanced Settings
        React.createElement('div', { className: 'card', style: { marginBottom: '16px' } },
          React.createElement('button', {
            onClick: () => setShowAdvanced(!showAdvanced),
            style: {
              width: '100%',
              padding: '12px',
              background: 'transparent',
              color: 'var(--primary-text)',
              border: 'none',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }
          },
            React.createElement('span', { style: { fontWeight: '600' } }, 'Advanced'),
            React.createElement('span', { style: { transform: showAdvanced ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' } }, '▼')
          ),
          showAdvanced && React.createElement('div', { style: { marginTop: '16px' } },
            React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { 
                style: { 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '8px',
                  marginBottom: '8px', 
                  fontWeight: '500',
                  color: 'var(--primary-text)'
                } 
              }, 
                'Workspace Code',
                React.createElement('span', { 
                  style: { 
                    fontSize: '11px', 
                    color: 'var(--secondary-text)',
                    padding: '2px 6px',
                    background: 'var(--surface)',
                    borderRadius: '4px'
                  },
                  title: 'Devices with the same workspace code share data'
                }, '?')
              ),
              React.createElement('div', { style: { display: 'flex', gap: '8px' } },
                React.createElement('input', {
                  className: 'form-input',
                  value: newSyncCode,
                  onChange: (e) => setNewSyncCode(e.target.value.toUpperCase()),
                  style: { flex: 1 }
                }),
                React.createElement('button', {
                  onClick: handleSyncCodeChange,
                  style: {
                    padding: '12px 16px',
                    background: 'var(--accent)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer'
                  }
                }, 'Update')
              )
            ),
            React.createElement('button', {
              onClick: onForceSync,
              style: {
                width: '100%',
                padding: '12px',
                background: 'var(--surface)',
                color: 'var(--primary-text)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px'
              }
            }, Icons.sync, 'Force Sync')
          )
        )
      );
    };

    // ============================================================
    // ANALYTICS DRAWER
    // ============================================================
    const AnalyticsDrawer = ({ isOpen, onClose, surveys }) => {
      const todayCount = surveys.filter(s => {
        const today = new Date().toDateString();
        return new Date(s.timestamp).toDateString() === today;
      }).length;

      const wlLeads = surveys.filter(s => s.interestedInCustomLogo === 'Yes').length;

      // Calculate business type distribution
      const businessTypes = {};
      surveys.forEach(s => {
        if (s.businessType) {
          businessTypes[s.businessType] = (businessTypes[s.businessType] || 0) + 1;
        }
      });

      // Calculate brand distribution
      const brandCounts = {};
      surveys.forEach(s => {
        (s.brands || []).forEach(brand => {
          brandCounts[brand] = (brandCounts[brand] || 0) + 1;
        });
      });

      const topBrands = Object.entries(brandCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const topBusinessTypes = Object.entries(businessTypes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const maxBrandCount = Math.max(...topBrands.map(b => b[1]), 1);
      const maxTypeCount = Math.max(...topBusinessTypes.map(t => t[1]), 1);

      return React.createElement(React.Fragment, null,
        isOpen && React.createElement('div', {
          style: {
            position: 'fixed',
            inset: 0,
            background: 'rgba(0,0,0,0.3)',
            zIndex: 140
          },
          onClick: onClose
        }),
        React.createElement('div', { className: `analytics-drawer ${isOpen ? 'open' : ''}` },
          React.createElement('div', { 
            style: { 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between',
              padding: '16px',
              borderBottom: '1px solid var(--border)'
            } 
          },
            React.createElement('h2', { 
              style: { 
                fontSize: '18px', 
                fontWeight: '600', 
                color: 'var(--primary-text)' 
              } 
            }, 'Analytics'),
            React.createElement('button', {
              onClick: onClose,
              style: { background: 'none', border: 'none', cursor: 'pointer', color: 'var(--secondary-text)' }
            }, Icons.close)
          ),

          React.createElement('div', { style: { padding: '16px' } },
            // KPIs
            React.createElement('div', { 
              style: { 
                display: 'grid', 
                gridTemplateColumns: 'repeat(2, 1fr)', 
                gap: '12px',
                marginBottom: '24px'
              } 
            },
              [
                { label: 'Total', value: surveys.length, color: 'var(--accent)' },
                { label: 'Today', value: todayCount, color: 'var(--success)' },
                { label: 'WL Leads', value: wlLeads, color: 'var(--warning)' },
                { label: 'Avg Margin', value: '--', color: 'var(--secondary-text)' }
              ].map((stat, i) => 
                React.createElement('div', { 
                  key: i,
                  style: { 
                    padding: '16px',
                    background: 'var(--surface)',
                    borderRadius: '8px',
                    textAlign: 'center'
                  }
                },
                  React.createElement('div', { 
                    style: { fontSize: '24px', fontWeight: '700', color: stat.color } 
                  }, stat.value),
                  React.createElement('div', { 
                    style: { fontSize: '11px', color: 'var(--secondary-text)' } 
                  }, stat.label)
                )
              )
            ),

            // Business Types Bar Chart
            React.createElement('div', { style: { marginBottom: '24px' } },
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--primary-text)',
                  marginBottom: '12px'
                } 
              }, 'Business Types'),
              topBusinessTypes.length === 0 ? 
                React.createElement('p', { style: { color: 'var(--secondary-text)', fontSize: '12px' } }, 'No data yet')
              :
                React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                  topBusinessTypes.map(([type, count], i) => 
                    React.createElement('div', { key: i },
                      React.createElement('div', { 
                        style: { 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          fontSize: '12px',
                          marginBottom: '4px'
                        } 
                      },
                        React.createElement('span', { style: { color: 'var(--primary-text)' } }, type),
                        React.createElement('span', { style: { color: 'var(--secondary-text)' } }, count)
                      ),
                      React.createElement('div', { 
                        style: { 
                          height: '8px', 
                          background: 'var(--border)', 
                          borderRadius: '4px',
                          overflow: 'hidden'
                        } 
                      },
                        React.createElement('div', { 
                          style: { 
                            height: '100%', 
                            width: `${(count / maxTypeCount) * 100}%`,
                            background: 'var(--accent)',
                            borderRadius: '4px'
                          } 
                        })
                      )
                    )
                  )
                )
            ),

            // Top Brands Bar Chart
            React.createElement('div', null,
              React.createElement('h3', { 
                style: { 
                  fontSize: '14px', 
                  fontWeight: '600', 
                  color: 'var(--primary-text)',
                  marginBottom: '12px'
                } 
              }, 'Top Brands'),
              topBrands.length === 0 ? 
                React.createElement('p', { style: { color: 'var(--secondary-text)', fontSize: '12px' } }, 'No data yet')
              :
                React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                  topBrands.map(([brand, count], i) => 
                    React.createElement('div', { key: i },
                      React.createElement('div', { 
                        style: { 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          fontSize: '12px',
                          marginBottom: '4px'
                        } 
                      },
                        React.createElement('span', { style: { color: 'var(--primary-text)' } }, brand),
                        React.createElement('span', { style: { color: 'var(--secondary-text)' } }, count)
                      ),
                      React.createElement('div', { 
                        style: { 
                          height: '8px', 
                          background: 'var(--border)', 
                          borderRadius: '4px',
                          overflow: 'hidden'
                        } 
                      },
                        React.createElement('div', { 
                          style: { 
                            height: '100%', 
                            width: `${(count / maxBrandCount) * 100}%`,
                            background: 'var(--success)',
                            borderRadius: '4px'
                          } 
                        })
                      )
                    )
                  )
                )
            )
          )
        )
      );
    };

    // ============================================================
    // EXPORT MODAL
    // ============================================================
    const ExportModal = ({ isOpen, onClose, surveys, selectedSurvey }) => {
      const { toast } = useToast();
      const { logo } = useApp();
      const [format, setFormat] = useState('pdf');
      const [scope, setScope] = useState(selectedSurvey ? 'single' : 'all');
      const [exporting, setExporting] = useState(false);
      const [progress, setProgress] = useState(0);

      const handleExport = async () => {
        setExporting(true);
        setProgress(0);
        
        const surveysToExport = scope === 'single' && selectedSurvey 
          ? [selectedSurvey] 
          : surveys;

        try {
          if (format === 'json') {
            const data = JSON.stringify(surveysToExport, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            downloadBlob(blob, `vellora_export_${Date.now()}.json`);
          } else if (format === 'csv') {
            const csv = generateCSV(surveysToExport);
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadBlob(blob, `vellora_export_${Date.now()}.csv`);
          } else if (format === 'text') {
            const text = generateTextExport(surveysToExport);
            const blob = new Blob([text], { type: 'text/plain' });
            downloadBlob(blob, `vellora_export_${Date.now()}.txt`);
          } else if (format === 'pdf') {
            await generatePDF(surveysToExport, setProgress);
          }
          
          toast('Export completed successfully', 'success');
          onClose();
        } catch (error) {
          console.error('Export error:', error);
          toast('Export failed: ' + error.message, 'error');
        }
        
        setExporting(false);
      };

      const downloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };

      const generateCSV = (data) => {
        const headers = ['Business,Timestamp,Area,ContactName,ContactMobile,Brand,Size,Buying,Selling,Profit,SyncCode'];
        const rows = [];
        
        data.forEach(survey => {
          const brands = survey.brands || [];
          const sizes = survey.bottleSizes || [];
          
          if (brands.length === 0 || sizes.length === 0) {
            rows.push([
              survey.businessName || '',
              survey.timestamp || '',
              survey.locationArea || '',
              survey.contactName || '',
              survey.contactMobile || '',
              '',
              '',
              '',
              '',
              '',
              survey.syncCode || ''
            ].map(v => `"${v}"`).join(','));
          } else {
            brands.forEach(brand => {
              sizes.forEach(size => {
                const key = `${brand}|${size}`;
                rows.push([
                  survey.businessName || '',
                  survey.timestamp || '',
                  survey.locationArea || '',
                  survey.contactName || '',
                  survey.contactMobile || '',
                  brand,
                  size,
                  survey.buyingPrice?.[key] || '',
                  survey.sellingPrice?.[key] || '',
                  survey.profitPerBottle?.[key] || '',
                  survey.syncCode || ''
                ].map(v => `"${v}"`).join(','));
              });
            });
          }
        });
        
        return [headers, ...rows].join('\n');
      };

      const generateTextExport = (data) => {
        return data.map(survey => {
          return `
===========================================
SURVEY: ${survey.businessName || 'Unnamed'}
===========================================
Date: ${formatDate(survey.timestamp)}
Business Type: ${survey.businessType || '--'}
Location: ${survey.locationArea || '--'}
GPS: ${survey.gps?.lat ? `${survey.gps.lat.toFixed(4)}, ${survey.gps.lng.toFixed(4)}` : '--'}

CONTACT
-------
Name: ${survey.contactName || '--'}
Mobile: ${survey.contactMobile || '--'}

PRODUCTS
--------
Brands: ${(survey.brands || []).join(', ') || '--'}
Sizes: ${(survey.bottleSizes || []).join(', ') || '--'}
Monthly Qty: ${survey.qtyMonthly || 0} bottles

DISTRIBUTOR
-----------
Name: ${survey.distributorName || '--'}
Happy: ${survey.happyWithService || '--'}
Problems: ${(survey.mainProblems || []).join(', ') || 'None'}

WHITE LABEL
-----------
Interested: ${survey.interestedInCustomLogo || '--'}
Extra Pay: ${survey.extraWillingToPay || '--'}
Purpose: ${survey.customPurpose || '--'}
`;
        }).join('\n\n');
      };

      const generatePDF = async (data, onProgress) => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        
        for (let i = 0; i < data.length; i++) {
          const survey = data[i];
          if (i > 0) pdf.addPage();
          
          let y = margin;
          
          // Logo
          if (logo) {
            try {
              pdf.addImage(logo, 'PNG', margin, y, 20, 20);
            } catch (e) {
              console.warn('Could not add logo to PDF');
            }
          }
          
          // Title
          pdf.setFontSize(18);
          pdf.setFont(undefined, 'bold');
          pdf.text('Vellora Survey Report', logo ? margin + 25 : margin, y + 10);
          y += 30;
          
          // Business Info
          pdf.setFontSize(14);
          pdf.text(survey.businessName || 'Unnamed Business', margin, y);
          y += 8;
          
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Date: ${formatDate(survey.timestamp)}`, margin, y);
          y += 6;
          pdf.text(`Type: ${survey.businessType || '--'}`, margin, y);
          y += 6;
          pdf.text(`Location: ${survey.locationArea || '--'}`, margin, y);
          y += 6;
          pdf.text(`GPS: ${survey.gps?.lat ? `${survey.gps.lat.toFixed(4)}, ${survey.gps.lng.toFixed(4)}` : '--'}`, margin, y);
          y += 12;
          
          // Contact
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.text('Contact', margin, y);
          y += 6;
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Name: ${survey.contactName || '--'}`, margin, y);
          y += 5;
          pdf.text(`Mobile: ${survey.contactMobile || '--'}`, margin, y);
          y += 12;
          
          // Products
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.text('Products', margin, y);
          y += 6;
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Brands: ${(survey.brands || []).join(', ') || '--'}`, margin, y, { maxWidth: pageWidth - margin * 2 });
          y += 5;
          pdf.text(`Sizes: ${(survey.bottleSizes || []).join(', ') || '--'}`, margin, y);
          y += 5;
          pdf.text(`Monthly Qty: ${survey.qtyMonthly || 0} bottles`, margin, y);
          y += 12;
          
          // Distributor
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.text('Distributor', margin, y);
          y += 6;
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Name: ${survey.distributorName || '--'}`, margin, y);
          y += 5;
          pdf.text(`Satisfied: ${survey.happyWithService || '--'}`, margin, y);
          y += 5;
          if (survey.mainProblems?.length > 0) {
            pdf.text(`Problems: ${survey.mainProblems.join(', ')}`, margin, y, { maxWidth: pageWidth - margin * 2 });
            y += 5;
          }
          y += 7;
          
          // White Label
          if (survey.interestedInCustomLogo === 'Yes') {
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('White Label Interest', margin, y);
            y += 6;
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Extra Pay: ${survey.extraWillingToPay || '--'}`, margin, y);
            y += 5;
            pdf.text(`Purpose: ${survey.customPurpose || '--'}`, margin, y);
          }
          
          onProgress(((i + 1) / data.length) * 100);
        }
        
        pdf.save(`vellora_export_${Date.now()}.pdf`);
      };

      if (!isOpen) return null;

      return React.createElement('div', { 
        className: 'modal-backdrop',
        onClick: (e) => e.target === e.currentTarget && !exporting && onClose()
      },
        React.createElement('div', { 
          style: { 
            background: 'var(--bg)', 
            borderRadius: '16px', 
            width: '90%', 
            maxWidth: '400px',
            padding: '24px'
          } 
        },
          React.createElement('h2', { 
            style: { 
              fontSize: '20px', 
              fontWeight: '600', 
              color: 'var(--primary-text)',
              marginBottom: '20px'
            } 
          }, 'Export Data'),

          // Format Selection
          React.createElement('div', { style: { marginBottom: '16px' } },
            React.createElement('label', { 
              style: { 
                display: 'block', 
                marginBottom: '8px', 
                fontWeight: '500',
                color: 'var(--primary-text)'
              } 
            }, 'Format'),
            React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px' } },
              ['pdf', 'csv', 'json', 'text'].map(f => 
                React.createElement('button', {
                  key: f,
                  onClick: () => setFormat(f),
                  style: {
                    padding: '8px 16px',
                    background: format === f ? 'var(--accent)' : 'var(--surface)',
                    color: format === f ? 'white' : 'var(--primary-text)',
                    border: '1px solid var(--border)',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    textTransform: 'uppercase',
                    fontSize: '12px',
                    fontWeight: '500'
                  }
                }, f)
              )
            )
          ),

          // Scope Selection
          React.createElement('div', { style: { marginBottom: '20px' } },
            React.createElement('label', { 
              style: { 
                display: 'block', 
                marginBottom: '8px', 
                fontWeight: '500',
                color: 'var(--primary-text)'
              } 
            }, 'Scope'),
            React.createElement('div', { style: { display: 'flex', gap: '8px' } },
              [
                { id: 'single', label: 'Single', disabled: !selectedSurvey },
                { id: 'all', label: `All (${surveys.length})` }
              ].map(s => 
                React.createElement('button', {
                  key: s.id,
                  onClick: () => !s.disabled && setScope(s.id),
                  disabled: s.disabled,
                  style: {
                    flex: 1,
                    padding: '8px 16px',
                    background: scope === s.id ? 'var(--accent)' : 'var(--surface)',
                    color: scope === s.id ? 'white' : 'var(--primary-text)',
                    border: '1px solid var(--border)',
                    borderRadius: '6px',
                    cursor: s.disabled ? 'not-allowed' : 'pointer',
                    opacity: s.disabled ? 0.5 : 1
                  }
                }, s.label)
              )
            )
          ),

          // Progress
          exporting && React.createElement('div', { style: { marginBottom: '16px' } },
            React.createElement('div', { className: 'progress-bar', style: { marginBottom: '8px' } },
              React.createElement('div', { 
                className: 'progress-fill',
                style: { width: `${progress}%` }
              })
            ),
            React.createElement('div', { 
              style: { 
                textAlign: 'center', 
                fontSize: '12px', 
                color: 'var(--secondary-text)' 
              } 
            }, `${Math.round(progress)}%`)
          ),

          // Actions
          React.createElement('div', { style: { display: 'flex', gap: '12px' } },
            React.createElement('button', {
              onClick: onClose,
              disabled: exporting,
              style: {
                flex: 1,
                padding: '12px',
                background: 'var(--surface)',
                color: 'var(--primary-text)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                cursor: exporting ? 'not-allowed' : 'pointer'
              }
            }, 'Cancel'),
            React.createElement('button', {
              onClick: handleExport,
              disabled: exporting,
              style: {
                flex: 1,
                padding: '12px',
                background: 'var(--accent)',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: exporting ? 'wait' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px'
              }
            }, 
              exporting ? React.createElement('span', { className: 'spinner' }) : Icons.download,
              exporting ? 'Exporting...' : 'Export'
            )
          )
        )
      );
    };

    // ============================================================
    // RECYCLE BIN MODAL
    // ============================================================
    const RecycleBinModal = ({ isOpen, onClose, recycleBin, onRestore, onPermanentDelete }) => {
      const { toast } = useToast();
      const [pinInput, setPinInput] = useState('');
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [storedPinData, setStoredPinData] = useState(null);

      useEffect(() => {
        if (isOpen) {
          const stored = localStorage.getItem('vellora_recycleBin_pin');
          if (stored) {
            setStoredPinData(JSON.parse(stored));
          }
        }
      }, [isOpen]);

      const handleSetPin = async () => {
        if (pinInput.length < 4) {
          toast('PIN must be at least 4 digits', 'error');
          return;
        }
        const { hash, salt } = await hashPIN(pinInput);
        localStorage.setItem('vellora_recycleBin_pin', JSON.stringify({ hash, salt }));
        setStoredPinData({ hash, salt });
        setIsUnlocked(true);
        toast('PIN set successfully', 'success');
        setPinInput('');
      };

      const handleUnlock = async () => {
        if (!storedPinData) return;
        const isValid = await verifyPIN(pinInput, storedPinData.hash, storedPinData.salt);
        if (isValid) {
          setIsUnlocked(true);
          setPinInput('');
        } else {
          toast('Invalid PIN', 'error');
        }
      };

      const handleResetBin = async () => {
        if (!isUnlocked) return;
        const confirmed = window.confirm('This will permanently delete all items in the recycle bin. Continue?');
        if (confirmed) {
          onPermanentDelete('all');
          toast('Recycle bin cleared', 'info');
        }
      };

      if (!isOpen) return null;

      return React.createElement('div', { 
        className: 'modal-backdrop',
        onClick: (e) => e.target === e.currentTarget && onClose()
      },
        React.createElement('div', { 
          style: { 
            background: 'var(--bg)', 
            borderRadius: '16px', 
            width: '90%', 
            maxWidth: '400px',
            maxHeight: '80vh',
            display: 'flex',
            flexDirection: 'column'
          } 
        },
          // Header
          React.createElement('div', { 
            style: { 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between',
              padding: '16px',
              borderBottom: '1px solid var(--border)'
            } 
          },
            React.createElement('h2', { 
              style: { 
                fontSize: '18px', 
                fontWeight: '600', 
                color: 'var(--primary-text)' 
              } 
            }, 'Recycle Bin'),
            React.createElement('button', {
              onClick: onClose,
              style: { background: 'none', border: 'none', cursor: 'pointer', color: 'var(--secondary-text)' }
            }, Icons.close)
          ),

          // Content
          React.createElement('div', { 
            style: { 
              flex: 1, 
              overflow: 'auto', 
              padding: '16px' 
            } 
          },
            !isUnlocked ? (
              // PIN Entry
              React.createElement('div', { style: { textAlign: 'center' } },
                React.createElement('div', { 
                  style: { 
                    marginBottom: '20px',
                    color: 'var(--secondary-text)'
                  } 
                }, Icons.lock),
                React.createElement('p', { 
                  style: { 
                    marginBottom: '16px',
                    color: 'var(--secondary-text)',
                    fontSize: '14px'
                  } 
                }, storedPinData ? 'Enter PIN to access' : 'Set a PIN to protect the recycle bin'),
                React.createElement('input', {
                  type: 'password',
                  className: 'form-input',
                  placeholder: 'Enter PIN',
                  value: pinInput,
                  onChange: (e) => setPinInput(e.target.value.replace(/\D/g, '').slice(0, 6)),
                  style: { textAlign: 'center', marginBottom: '16px', letterSpacing: '0.5em' }
                }),
                React.createElement('button', {
                  onClick: storedPinData ? handleUnlock : handleSetPin,
                  style: {
                    width: '100%',
                    padding: '12px',
                    background: 'var(--accent)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer'
                  }
                }, storedPinData ? 'Unlock' : 'Set PIN')
              )
            ) : (
              // Bin Contents
              React.createElement(React.Fragment, null,
                recycleBin.length === 0 ? 
                  React.createElement('p', { 
                    style: { 
                      textAlign: 'center', 
                      color: 'var(--secondary-text)',
                      padding: '40px'
                    } 
                  }, 'Recycle bin is empty')
                :
                  React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
                    recycleBin.map(survey => 
                      React.createElement('div', { 
                        key: survey.id,
                        className: 'card',
                        style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
                      },
                        React.createElement('div', null,
                          React.createElement('div', { 
                            style: { 
                              fontWeight: '500', 
                              color: 'var(--primary-text)' 
                            } 
                          }, survey.businessName || 'Unnamed'),
                          React.createElement('div', { 
                            style: { 
                              fontSize: '12px', 
                              color: 'var(--secondary-text)' 
                            } 
                          }, formatDate(survey.timestamp))
                        ),
                        React.createElement('div', { style: { display: 'flex', gap: '8px' } },
                          React.createElement('button', {
                            onClick: () => onRestore(survey),
                            style: {
                              padding: '8px',
                              background: 'var(--success)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer'
                            },
                            title: 'Restore'
                          }, Icons.refresh),
                          React.createElement('button', {
                            onClick: () => {
                              if (window.confirm('Permanently delete this survey?')) {
                                onPermanentDelete(survey.id);
                              }
                            },
                            style: {
                              padding: '8px',
                              background: 'var(--error)',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer'
                            },
                            title: 'Delete permanently'
                          }, Icons.trash)
                        )
                      )
                    )
                  ),
                recycleBin.length > 0 && React.createElement('button', {
                  onClick: handleResetBin,
                  style: {
                    marginTop: '16px',
                    width: '100%',
                    padding: '12px',
                    background: 'var(--error)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer'
                  }
                }, 'Empty Recycle Bin')
              )
            )
          )
        )
      );
    };

    // ============================================================
    // MAIN APP COMPONENT
    // ============================================================
    const App = () => {
      // State
      const [activeTab, setActiveTab] = useState('home');
      const [surveys, setSurveys] = useState([]);
      const [masterData, setMasterData] = useState(DEFAULT_MASTER_DATA);
      const [recycleBin, setRecycleBin] = useState([]);
      const [outbox, setOutbox] = useState([]);
      const [theme, setTheme] = useState('corporate-light');
      const [logo, setLogo] = useState(null);
      const [syncCode, setSyncCode] = useState(getSyncCode());
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [toasts, setToasts] = useState([]);
      const [showWizard, setShowWizard] = useState(false);
      const [selectedSurvey, setSelectedSurvey] = useState(null);
      const [showAnalytics, setShowAnalytics] = useState(false);
      const [showExport, setShowExport] = useState(false);
      const [showRecycleBin, setShowRecycleBin] = useState(false);
      const [exportSurvey, setExportSurvey] = useState(null);
      const [user, setUser] = useState(null);

      // Toast functions
      const toast = useCallback((message, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, 4000);
      }, []);

      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);

      // Apply theme
      useEffect(() => {
        const t = THEMES[theme] || THEMES['corporate-light'];
        const root = document.documentElement;
        root.style.setProperty('--bg', t.bg);
        root.style.setProperty('--surface', t.surface);
        root.style.setProperty('--primary-text', t.primaryText);
        root.style.setProperty('--secondary-text', t.secondaryText);
        root.style.setProperty('--input-bg', t.inputBg);
        root.style.setProperty('--primary-btn-bg', t.primaryBtnBg);
        root.style.setProperty('--primary-btn-text', t.primaryBtnText);
        root.style.setProperty('--accent', t.accent);
        root.style.setProperty('--border', t.border);
        root.style.setProperty('--placeholder', t.placeholder);
        localStorage.setItem('vellora_theme', theme);
      }, [theme]);

      // Initialize
      useEffect(() => {
        // Load theme
        const savedTheme = localStorage.getItem('vellora_theme');
        if (savedTheme && THEMES[savedTheme]) {
          setTheme(savedTheme);
        }

        // Load logo
        const savedLogo = localStorage.getItem('vellora_logo');
        if (savedLogo) {
          setLogo(savedLogo);
        }

        // Load local data
        const localSurveys = loadFromLocalStorage('surveys') || [];
        const localMaster = loadFromLocalStorage('masterData');
        const localRecycleBin = loadFromLocalStorage('recycleBin') || [];
        const localOutbox = loadFromLocalStorage('outbox') || [];

        setSurveys(localSurveys);
        setRecycleBin(localRecycleBin);
        setOutbox(localOutbox);
        if (localMaster) {
          setMasterData({ ...DEFAULT_MASTER_DATA, ...localMaster });
        }

        // Anonymous auth
        auth.signInAnonymously()
          .then((result) => {
            setUser(result.user);
          })
          .catch((error) => {
            console.error('Auth error:', error);
          });

        // Online/offline listeners
        const handleOnline = () => {
          setIsOnline(true);
          toast('Back online', 'success');
          flushOutbox();
        };
        const handleOffline = () => {
          setIsOnline(false);
          toast('You are offline', 'warning');
        };

        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

      // Firestore listeners
      useEffect(() => {
        if (!isOnline || !user) return;

        const code = getSyncCode();

        // Listen to surveys
        const surveysRef = db.collection('artifacts').doc(code)
          .collection('data').doc('surveys').collection('items');
        
        const unsubSurveys = surveysRef.onSnapshot((snapshot) => {
          const firestoreSurveys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setSurveys(firestoreSurveys);
          saveToLocalStorage('surveys', firestoreSurveys);
        }, (error) => {
          console.error('Firestore surveys error:', error);
        });

        // Listen to masterData
        const masterRef = db.collection('artifacts').doc(code)
          .collection('settings').doc('masterData');
        
        const unsubMaster = masterRef.onSnapshot((snapshot) => {
          if (snapshot.exists) {
            const data = snapshot.data();
            setMasterData({ ...DEFAULT_MASTER_DATA, ...data });
            saveToLocalStorage('masterData', data);
          }
        }, (error) => {
          console.error('Firestore master error:', error);
        });

        return () => {
          unsubSurveys();
          unsubMaster();
        };
      }, [isOnline, user]);

      // Outbox flush
      const flushOutbox = useCallback(async () => {
        const currentOutbox = loadFromLocalStorage('outbox') || [];
        if (currentOutbox.length === 0) return;

        const code = getSyncCode();
        let successCount = 0;

        for (const op of currentOutbox) {
          try {
            if (op.type === 'create' || op.type === 'update') {
              await db.collection('artifacts').doc(code)
                .collection('data').doc('surveys').collection('items')
                .doc(op.id).set(op.payload, { merge: true });
            } else if (op.type === 'delete') {
              await db.collection('artifacts').doc(code)
                .collection('data').doc('surveys').collection('items')
                .doc(op.id).delete();
            } else if (op.type === 'masterUpdate') {
              await db.collection('artifacts').doc(code)
                .collection('settings').doc('masterData')
                .set(op.payload, { merge: true });
            }
            successCount++;
          } catch (error) {
            console.error('Outbox flush error:', error);
          }
        }

        if (successCount > 0) {
          saveToLocalStorage('outbox', []);
          setOutbox([]);
          toast(`Synced ${successCount} pending changes`, 'success');
        }
      }, [toast]);

      const forceSync = useCallback(async () => {
        if (!isOnline) {
          toast('Cannot sync while offline', 'warning');
          return;
        }
        await flushOutbox();
        toast('Sync complete', 'success');
      }, [isOnline, flushOutbox, toast]);

      // Survey operations
      const saveSurvey = useCallback((survey) => {
        const updatedSurveys = [...surveys, survey];
        setSurveys(updatedSurveys);
        saveToLocalStorage('surveys', updatedSurveys);

        if (isOnline) {
          const code = getSyncCode();
          db.collection('artifacts').doc(code)
            .collection('data').doc('surveys').collection('items')
            .doc(survey.id).set(survey)
            .catch(err => console.error('Save error:', err));
        } else {
          const op = { opId: generateUUID(), type: 'create', id: survey.id, payload: survey, timestamp: new Date().toISOString() };
          const newOutbox = [...outbox, op];
          setOutbox(newOutbox);
          saveToLocalStorage('outbox', newOutbox);
        }

        setShowWizard(false);
        toast('Survey saved successfully', 'success');
      }, [surveys, outbox, isOnline, toast]);

      const deleteSurvey = useCallback((survey) => {
        // Move to recycle bin
        const newRecycleBin = [...recycleBin, { ...survey, deletedAt: new Date().toISOString() }];
        setRecycleBin(newRecycleBin);
        saveToLocalStorage('recycleBin', newRecycleBin);

        // Remove from surveys
        const updatedSurveys = surveys.filter(s => s.id !== survey.id);
        setSurveys(updatedSurveys);
        saveToLocalStorage('surveys', updatedSurveys);

        if (isOnline) {
          const code = getSyncCode();
          db.collection('artifacts').doc(code)
            .collection('data').doc('surveys').collection('items')
            .doc(survey.id).delete()
            .catch(err => console.error('Delete error:', err));
        } else {
          const op = { opId: generateUUID(), type: 'delete', id: survey.id, timestamp: new Date().toISOString() };
          const newOutbox = [...outbox, op];
          setOutbox(newOutbox);
          saveToLocalStorage('outbox', newOutbox);
        }

        setSelectedSurvey(null);
        toast('Survey moved to recycle bin', 'info');
        
        // Dispatch event
        window.dispatchEvent(new CustomEvent('vellora:surveyDeleted', { detail: { surveyId: survey.id } }));
      }, [surveys, recycleBin, outbox, isOnline, toast]);

      const restoreSurvey = useCallback((survey) => {
        // Remove from recycle bin
        const newRecycleBin = recycleBin.filter(s => s.id !== survey.id);
        setRecycleBin(newRecycleBin);
        saveToLocalStorage('recycleBin', newRecycleBin);

        // Add back to surveys
        const { deletedAt, ...restoredSurvey } = survey;
        const updatedSurveys = [...surveys, restoredSurvey];
        setSurveys(updatedSurveys);
        saveToLocalStorage('surveys', updatedSurveys);

        if (isOnline) {
          const code = getSyncCode();
          db.collection('artifacts').doc(code)
            .collection('data').doc('surveys').collection('items')
            .doc(restoredSurvey.id).set(restoredSurvey)
            .catch(err => console.error('Restore error:', err));
        }

        toast('Survey restored', 'success');
      }, [surveys, recycleBin, isOnline, toast]);

      const permanentDelete = useCallback((idOrAll) => {
        if (idOrAll === 'all') {
          setRecycleBin([]);
          saveToLocalStorage('recycleBin', []);
        } else {
          const newRecycleBin = recycleBin.filter(s => s.id !== idOrAll);
          setRecycleBin(newRecycleBin);
          saveToLocalStorage('recycleBin', newRecycleBin);
        }
        toast('Permanently deleted', 'info');
      }, [recycleBin, toast]);

      // Master data update
      const updateMasterData = useCallback((key, values) => {
        const updated = { ...masterData, [key]: values };
        setMasterData(updated);
        saveToLocalStorage('masterData', updated);

        if (isOnline) {
          const code = getSyncCode();
          db.collection('artifacts').doc(code)
            .collection('settings').doc('masterData')
            .set(updated, { merge: true })
            .catch(err => console.error('Master update error:', err));
        } else {
          const op = { opId: generateUUID(), type: 'masterUpdate', payload: updated, timestamp: new Date().toISOString() };
          const newOutbox = [...outbox, op];
          setOutbox(newOutbox);
          saveToLocalStorage('outbox', newOutbox);
        }
      }, [masterData, outbox, isOnline]);

      // Export handler
      const handleExport = useCallback((survey, format) => {
        setExportSurvey(survey);
        setShowExport(true);
      }, []);

      // Public API
      useEffect(() => {
        window.openSurveyDetail = (surveyOrId) => {
          const survey = typeof surveyOrId === 'string' 
            ? surveys.find(s => s.id === surveyOrId)
            : surveyOrId;
          if (survey) {
            setSelectedSurvey(survey);
          }
        };

        window.velloraExport = {
          pdf: (ids) => { setShowExport(true); },
          csv: (ids) => { setShowExport(true); },
          json: (ids) => { setShowExport(true); },
          text: (ids) => { setShowExport(true); }
        };

        window.velloraAnalytics = {
          refresh: () => { setShowAnalytics(true); }
        };
      }, [surveys]);

      // Render
      const renderContent = () => {
        switch (activeTab) {
          case 'home':
            return React.createElement(HomeView, {
              surveys,
              onStartSurvey: () => setShowWizard(true)
            });
          case 'list':
            return React.createElement(SurveyListView, {
              surveys,
              onViewDetail: setSelectedSurvey
            });
          case 'analytics':
            return React.createElement('div', { 
              style: { 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                height: '100%',
                background: 'var(--bg)',
                flexDirection: 'column',
                gap: '16px'
              } 
            },
              React.createElement('button', {
                onClick: () => setShowAnalytics(true),
                style: {
                  padding: '16px 32px',
                  background: 'var(--accent)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '16px'
                }
              }, 'Open Analytics Panel')
            );
          case 'settings':
            return React.createElement(SettingsView, {
              onExport: () => setShowExport(true),
              onForceSync: forceSync
            });
          default:
            return null;
        }
      };

      return React.createElement(ThemeContext.Provider, { value: { theme, setTheme } },
        React.createElement(ToastContext.Provider, { value: { toast } },
          React.createElement(AppContext.Provider, { value: { isOnline, logo, setLogo, syncCode, setSyncCode } },
            React.createElement('div', { 
              style: { 
                height: '100%', 
                display: 'flex', 
                flexDirection: 'column',
                background: 'var(--bg)'
              },
              className: 'theme-transition'
            },
              // Main Content
              React.createElement('main', { 
                style: { 
                  flex: 1, 
                  overflow: 'auto',
                  paddingBottom: showWizard ? 0 : '60px'
                } 
              }, renderContent()),

              // Bottom Nav (hidden during wizard)
              !showWizard && React.createElement(BottomNav, {
                activeTab,
                onTabChange: setActiveTab
              }),

              // FAB (hidden during wizard)
              !showWizard && activeTab !== 'settings' && React.createElement('button', {
                className: 'fab',
                onClick: () => setShowWizard(true),
                style: { background: 'var(--accent)', color: 'white' },
                'aria-label': 'New survey'
              }, Icons.plus),

              // Survey Wizard
              showWizard && React.createElement(SurveyWizard, {
                masterData,
                onSave: saveSurvey,
                onCancel: () => setShowWizard(false),
                onUpdateMaster: updateMasterData
              }),

              // Survey Detail Modal
              selectedSurvey && React.createElement(SurveyDetailModal, {
                survey: selectedSurvey,
                onClose: () => setSelectedSurvey(null),
                onDelete: deleteSurvey,
                onExport: handleExport
              }),

              // Analytics Drawer
              React.createElement(AnalyticsDrawer, {
                isOpen: showAnalytics,
                onClose: () => setShowAnalytics(false),
                surveys
              }),

              // Export Modal
              React.createElement(ExportModal, {
                isOpen: showExport,
                onClose: () => { setShowExport(false); setExportSurvey(null); },
                surveys,
                selectedSurvey: exportSurvey
              }),

              // Recycle Bin Modal (access from settings - placeholder button)
              React.createElement(RecycleBinModal, {
                isOpen: showRecycleBin,
                onClose: () => setShowRecycleBin(false),
                recycleBin,
                onRestore: restoreSurvey,
                onPermanentDelete: permanentDelete
              }),

              // Toasts
              React.createElement(ToastContainer, { toasts, removeToast })
            )
          )
        )
      );
    };

    // ============================================================
    // RENDER APP WITH ERROR BOUNDARY
    // ============================================================
    ReactDOM.createRoot(document.getElementById('root')).render(
      React.createElement(ErrorBoundary, null,
        React.createElement(App)
      )
    );
  </script>
</body>
</html>
