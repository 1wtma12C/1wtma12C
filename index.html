<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vellora">
    <title>Vellora Survey</title>

    <!-- 1. STABLE LIBRARIES (No ESM, No Imports) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. FIREBASE V8 (Classic - 100% Browser Compatible) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .tap-active:active { transform: scale(0.98); opacity: 0.9; }
        input, select { font-size: 16px !important; } /* Stop iOS Zoom */
    </style>
</head>
<body>

    <!-- LOADING SCREEN (Visible by default) -->
    <div id="loader" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">Starting Vellora...</h2>
        <div id="error-msg" class="hidden mt-4 p-4 bg-red-100 text-red-800 text-xs font-mono max-w-xs rounded border border-red-200"></div>
    </div>

    <!-- APP ROOT -->
    <div id="root" class="h-screen w-screen overflow-hidden"></div>

    <!-- GLOBAL ERROR TRAP -->
    <script>
        window.onerror = function(msg, source, lineno, colno, error) {
            document.getElementById('error-msg').classList.remove('hidden');
            document.getElementById('error-msg').innerText = "CRITICAL ERROR:\n" + msg + "\nLine: " + lineno;
            // Do NOT hide loader if error occurs
        };
    </script>

    <!-- APPLICATION LOGIC -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        const GEMINI_API_KEY = "AIzaSyCTGO098tUeKlMo0zFJUDxmHZryQgzD76w"; // Your Key
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
            authDomain: "vellora-3828d.firebaseapp.com",
            projectId: "vellora-3828d",
            storageBucket: "vellora-3828d.firebasestorage.app",
            messagingSenderId: "1045366360458",
            appId: "1:1045366360458:web:c9de51b7942bd743d9a073"
        };

        // --- BACKEND SERVICE (Firebase v8) ---
        const api = {
            db: null,
            init: (cb) => {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                    api.db = firebase.firestore();
                    firebase.auth().onAuthStateChanged(async (u) => {
                        if (!u) await firebase.auth().signInAnonymously();
                        cb('Online');
                    });
                } catch (e) {
                    console.error(e);
                    cb('Offline');
                }
            },
            save: async (code, data) => {
                // Local
                const local = JSON.parse(localStorage.getItem('v_'+code) || '[]');
                localStorage.setItem('v_'+code, JSON.stringify([data, ...local]));
                // Cloud
                if (api.db) await api.db.collection('data').doc(code).collection('surveys').add(data);
            },
            del: async (code, id) => {
                // Local
                const local = JSON.parse(localStorage.getItem('v_'+code) || '[]');
                localStorage.setItem('v_'+code, JSON.stringify(local.filter(x => x.id !== id)));
                // Cloud (Simple implementation: Delete local only for speed, Cloud delete requires Doc ID)
                if (api.db) {
                    const snap = await api.db.collection('data').doc(code).collection('surveys').where('id', '==', id).get();
                    snap.forEach(doc => doc.ref.delete());
                }
            },
            sub: (code, cb) => {
                const local = JSON.parse(localStorage.getItem('v_'+code) || '[]');
                cb(local);
                if (api.db) {
                    return api.db.collection('data').doc(code).collection('surveys')
                        .orderBy('timestamp', 'desc')
                        .onSnapshot(snap => {
                            const d = snap.docs.map(doc => doc.data());
                            localStorage.setItem('v_'+code, JSON.stringify(d));
                            cb(d);
                        });
                }
                return () => {};
            }
        };

        // --- COMPONENTS ---
        const Icon = ({n}) => {
            const p = {
                plus: "M12 5v14M5 12h14",
                home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10",
                list: "M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",
                x: "M18 6L6 18M6 6l12 12",
                trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                map: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
                zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
                set: "M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6"
            };
            return <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d={p[n]}/></svg>;
        };

        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                {label && <label className="text-xs font-bold text-gray-400 uppercase mb-1 block">{label}</label>}
                <input className="w-full p-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-blue-500 outline-none" {...props} />
            </div>
        );

        const Btn = ({ active, onClick, children }) => (
            <button onClick={onClick} className={`flex-1 py-3 px-2 rounded-xl font-bold text-sm border transition-all ${active ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}>
                {children}
            </button>
        );

        // --- MAIN APP ---
        const App = () => {
            // STATE
            const [mounted, setMounted] = useState(false);
            const [view, setView] = useState('home');
            const [status, setStatus] = useState('..');
            const [code, setCode] = useState(() => localStorage.getItem('vc') || 'demo');
            const [data, setData] = useState([]);
            const [modal, setModal] = useState(false);
            const [step, setStep] = useState(0);
            const [loading, setLoading] = useState(false);
            
            // FORM
            const initF = {
                id: '', timestamp: 0,
                name: '', type: '', loc: '', foot: '',
                brands: [], sizes: [], qty: '',
                buy: {}, sell: {},
                dist: '', freq: '', sat: '', prob: [],
                pitch: '', contact: '', phone: '', white: 'No'
            };
            const [f, setF] = useState(initF);

            // LIFECYCLE
            useEffect(() => {
                setMounted(true);
                // Remove loader only when React mounts
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'none';
                
                api.init(setStatus);
            }, []);

            useEffect(() => {
                const unsub = api.sub(code, setData);
                return () => unsub();
            }, [code, status]);

            // ACTIONS
            const update = (k, v, sub) => setF(p => sub ? {...p, [k]:{...p[k], [sub]:v}} : {...p, [k]:v});
            const toggle = (k, v) => setF(p => { const a=p[k]||[]; return {...p, [k]: a.includes(v)?a.filter(x=>x!==v):[...a,v]} });
            
            const getGPS = () => {
                if(!navigator.geolocation) return alert("No GPS");
                setLoading(true);
                navigator.geolocation.getCurrentPosition(p => {
                    update('loc', `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`);
                    setLoading(false);
                }, () => { alert("GPS Failed"); setLoading(false); }, {enableHighAccuracy:true});
            };

            const getPitch = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Sales pitch for water to ${f.name} (${f.type}). Problem: ${f.prob.join(',')}. 2 sentences.` }] }] })
                    });
                    const d = await res.json();
                    update('pitch', d.candidates[0].content.parts[0].text);
                } catch(e) { alert("AI Error"); }
                setLoading(false);
            };

            const save = async () => {
                await api.save(code, { ...f, id: Date.now().toString(), timestamp: Date.now() });
                setModal(false);
            };

            // RENDER STEPS
            const Steps = [
                <div className="space-y-4">
                    <h3 className="text-xl font-bold">Profile</h3>
                    <Input label="Business Name" value={f.name} onChange={e=>update('name', e.target.value)} />
                    <div><label className="text-xs font-bold text-gray-400 mb-2 block">TYPE</label>
                    <div className="grid grid-cols-2 gap-2">{['Cafe','Hotel','Restaurant','Grocery','Corp','Other'].map(t=><Btn key={t} active={f.type===t} onClick={()=>update('type',t)}>{t}</Btn>)}</div></div>
                    <div className="flex gap-2 items-end"><div className="flex-1"><Input label="Location" value={f.loc} onChange={e=>update('loc',e.target.value)}/></div><button onClick={getGPS} className="bg-blue-100 text-blue-600 p-3 rounded-xl mb-4"><Icon n="map"/></button></div>
                    <div><label className="text-xs font-bold text-gray-400 mb-2 block">FOOTFALL</label>
                    <div className="flex gap-2">{['Low','Med','High'].map(x=><Btn key={x} active={f.foot===x} onClick={()=>update('foot',x)}>{x}</Btn>)}</div></div>
                </div>,
                <div className="space-y-4">
                    <h3 className="text-xl font-bold">Usage</h3>
                    <div><label className="text-xs font-bold text-gray-400 mb-2 block">BRANDS</label>
                    <div class="flex flex-wrap gap-2">{['Kinley','Bisleri','Aquafina','Local'].map(b=><Btn key={b} active={f.brands.includes(b)} onClick={()=>toggle('brands',b)}>{b}</Btn>)}</div></div>
                    <div><label className="text-xs font-bold text-gray-400 mb-2 block">SIZES</label>
                    <div className="flex gap-2">{['250ml','500ml','1L'].map(s=><Btn key={s} active={f.sizes.includes(s)} onClick={()=>toggle('sizes',s)}>{s}</Btn>)}</div></div>
                    <Input label="Monthly Qty" type="number" value={f.qty} onChange={e=>update('qty', e.target.value)} />
                </div>,
                <div className="space-y-4">
                    <h3 className="text-xl font-bold">Pricing</h3>
                    {f.sizes.map(s => (
                        <div key={s} className="bg-white p-3 rounded-xl border shadow-sm mb-2">
                            <div className="font-bold text-blue-600 mb-2">{s}</div>
                            <div className="grid grid-cols-3 gap-2">
                                <input placeholder="Buy" type="number" className="p-2 border rounded" value={f.buy[s]||''} onChange={e=>update('buy',e.target.value,s)} />
                                <input placeholder="Sell" type="number" className="p-2 border rounded" value={f.sell[s]||''} onChange={e=>update('sell',e.target.value,s)} />
                                <div className="p-2 bg-green-50 text-green-600 font-bold text-center rounded border border-green-100">{(f.sell[s]-f.buy[s]||0).toFixed(0)}</div>
                            </div>
                        </div>
                    ))}
                </div>,
                <div className="space-y-4">
                    <h3 className="text-xl font-bold">Closing</h3>
                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <div className="flex justify-between mb-2"><span className="font-bold text-indigo-800">AI Script</span><button onClick={getPitch} className="text-xs bg-indigo-600 text-white px-3 py-1 rounded">{loading?'...':'Gen'}</button></div>
                        {f.pitch && <p className="text-sm italic text-indigo-900 bg-white p-2 rounded border border-indigo-50">"{f.pitch}"</p>}
                    </div>
                    <div><label className="text-xs font-bold text-gray-400 mb-2 block">WHITE LABEL?</label><div className="flex gap-2">{['Yes','No'].map(v=><Btn key={v} active={f.white===v} onClick={()=>update('white',v)}>{v}</Btn>)}</div></div>
                    <Input label="Contact" value={f.contact} onChange={e=>update('contact',e.target.value)} />
                </div>
            ];

            if (!mounted) return null;

            return (
                <div className="h-full flex flex-col bg-gray-50 pb-safe">
                    <header className="bg-white border-b px-4 py-3 pt-safe flex justify-between items-center z-10 sticky top-0">
                        <div className="flex items-center text-blue-600 space-x-2"><Icon n="zap"/><h1 className="font-bold text-xl text-gray-900">VELLORA</h1></div>
                        <button onClick={()=>setView('set')}><Icon n="set" className="text-gray-400"/></button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 w-full max-w-2xl mx-auto">
                        {view === 'home' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border"><div className="text-xs text-gray-400 font-bold">TODAY</div><div className="text-3xl font-black text-blue-600">{data.length}</div></div>
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border"><div className="text-xs text-gray-400 font-bold">STATUS</div><div className="text-sm font-bold text-green-600 uppercase">{status}</div></div>
                                </div>
                                <button onClick={()=>{setF(initF); setStep(0); setModal(true)}} className="w-full bg-blue-600 text-white rounded-3xl p-6 shadow-xl flex flex-col items-center tap-active">
                                    <div className="bg-white/20 p-3 rounded-full mb-2"><Icon n="plus"/></div>
                                    <span className="text-lg font-bold">Start Survey</span>
                                </button>
                                <div className="space-y-3">
                                    <h3 className="font-bold text-gray-400 text-xs">RECENT</h3>
                                    {data.slice(0,5).map(s => (
                                        <div key={s.id} className="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                                            <div><div className="font-bold">{s.name||'Unknown'}</div><div className="text-xs text-gray-500">{s.type} â€¢ {new Date(s.timestamp).toLocaleDateString()}</div></div>
                                            <button onClick={()=>api.del(code, s.id)} className="text-red-400 p-2"><Icon n="trash"/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'set' && (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold">Settings</h2>
                                <Input label="Sync Code" value={code} onChange={e=>{setCode(e.target.value); localStorage.setItem('vc',e.target.value)}} />
                                <button onClick={()=>{localStorage.clear(); window.location.reload()}} className="w-full p-4 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100">Reset App</button>
                            </div>
                        )}
                    </main>

                    <nav className="bg-white border-t px-6 py-2 pb-safe flex justify-around shrink-0 z-20">
                        {['home','list'].map(v => <button key={v} onClick={()=>setView(v==='list'?'home':v)} className={`p-2 ${view===v?'text-blue-600':'text-gray-400'}`}><Icon n={v}/></button>)}
                    </nav>

                    {modal && (
                        <div className="fixed inset-0 z-50 bg-gray-50 flex flex-col animate-in">
                            <div className="px-4 py-3 bg-white border-b pt-safe flex justify-between items-center shrink-0">
                                <span className="font-bold text-gray-500 text-sm">Step {step+1}/4</span>
                                <button onClick={()=>setModal(false)} className="p-2 bg-gray-100 rounded-full"><Icon n="x"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-5 pb-32 max-w-2xl mx-auto w-full">{Steps[step]}</div>
                            <div className="bg-white border-t p-4 pb-safe flex justify-between shrink-0 max-w-2xl mx-auto w-full">
                                <button onClick={()=>step>0 && setStep(s=>s-1)} disabled={step===0} className="text-gray-500 font-bold px-4 disabled:opacity-30">Back</button>
                                <button onClick={()=>step<3 ? setStep(s=>s+1) : save()} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">{step===3?'Save':'Next'}</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>


