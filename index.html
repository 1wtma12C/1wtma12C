<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VELLORA | Market Survey Architect</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        obsidian: '#000000',
                        charcoal: '#0a0a0a',
                        vellora: {
                            500: '#3b82f6', // Primary Blue
                            600: '#2563eb',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        /* Map Styles */
        .glass-panel {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        /* Transition utility */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Obsidian Theme Specifics */
        .theme-obsidian {
            background-color: #000000;
            color: #ffffff;
        }
        .theme-obsidian .card {
            background-color: #0a0a0a;
            border: 1px solid #222;
        }
        .theme-obsidian input, .theme-obsidian select, .theme-obsidian textarea {
            background-color: #000000;
            border-color: #333;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. CONFIGURATION & UTILS
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
            authDomain: "vellora-3828d.firebaseapp.com",
            projectId: "vellora-3828d",
            storageBucket: "vellora-3828d.firebasestorage.app",
            messagingSenderId: "1045366360458",
            appId: "1:1045366360458:web:c9de51b7942bd743d9a073",
            measurementId: "G-WLKMJNBJTP"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();
        db.enablePersistence().catch(err => console.log("Persistence Error:", err));

        // Constants
        const THEMES = [
            { id: 'light', name: 'Clean White', bg: 'bg-gray-50', text: 'text-gray-900', nav: 'bg-white', card: 'bg-white' },
            { id: 'dark', name: 'Midnight', bg: 'bg-gray-900', text: 'text-white', nav: 'bg-gray-800', card: 'bg-gray-800' },
            { id: 'obsidian', name: 'Obsidian', bg: 'theme-obsidian', text: 'text-white', nav: 'bg-black border-t border-gray-800', card: 'bg-gray-900' },
            { id: 'forest', name: 'Forest', bg: 'bg-green-50', text: 'text-green-900', nav: 'bg-white', card: 'bg-white' },
            { id: 'ocean', name: 'Ocean', bg: 'bg-blue-50', text: 'text-blue-900', nav: 'bg-white', card: 'bg-white' },
        ];

        // ==========================================
        // 2. DATA LAYER (SYNC ENGINE)
        // ==========================================
        const useSyncEngine = () => {
            const [surveys, setSurveys] = React.useState([]);
            const [isOnline, setIsOnline] = React.useState(navigator.onLine);
            const [outbox, setOutbox] = React.useState([]);

            // Load Initial State
            React.useEffect(() => {
                const localData = JSON.parse(localStorage.getItem('vellora_surveys') || '[]');
                const localOutbox = JSON.parse(localStorage.getItem('vellora_outbox') || '[]');
                setSurveys(localData);
                setOutbox(localOutbox);

                // Firebase Listener
                const unsubscribe = db.collection('surveys').onSnapshot(snapshot => {
                    const fbData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Merge strategy: Firebase wins if newer, but for simplicity here we trust FB stream when online
                    if (navigator.onLine) {
                        setSurveys(fbData);
                        localStorage.setItem('vellora_surveys', JSON.stringify(fbData));
                    }
                }, err => console.log("Offline mode active"));

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', () => setIsOnline(false));

                return () => {
                    unsubscribe();
                    window.removeEventListener('online', handleOnline);
                };
            }, []);

            const handleOnline = async () => {
                setIsOnline(true);
                const currentOutbox = JSON.parse(localStorage.getItem('vellora_outbox') || '[]');
                if (currentOutbox.length > 0) {
                    console.log("Syncing Outbox...", currentOutbox.length);
                    for (const item of currentOutbox) {
                        try {
                            if (item.type === 'ADD') {
                                delete item.data.id; // Let FB generate ID or use preserved one if needed
                                await db.collection('surveys').add(item.data);
                            } else if (item.type === 'UPDATE') {
                                await db.collection('surveys').doc(item.id).update(item.data);
                            } else if (item.type === 'DELETE') { // Soft Delete
                                await db.collection('surveys').doc(item.id).update({ isDeleted: true });
                            }
                        } catch (e) { console.error("Sync failed for item", e); }
                    }
                    localStorage.setItem('vellora_outbox', '[]');
                    setOutbox([]);
                }
            };

            const addSurvey = async (data) => {
                const newSurvey = { ...data, createdAt: new Date().toISOString(), isDeleted: false };
                
                // Optimistic UI Update
                const tempId = 'temp_' + Date.now();
                const optimisticList = [...surveys, { ...newSurvey, id: tempId }];
                setSurveys(optimisticList);
                localStorage.setItem('vellora_surveys', JSON.stringify(optimisticList));

                if (navigator.onLine) {
                    try {
                        await db.collection('surveys').add(newSurvey);
                    } catch (e) { queueAction('ADD', newSurvey); }
                } else {
                    queueAction('ADD', newSurvey);
                }
            };

            const updateSurvey = async (id, data) => {
                const updatedList = surveys.map(s => s.id === id ? { ...s, ...data } : s);
                setSurveys(updatedList);
                localStorage.setItem('vellora_surveys', JSON.stringify(updatedList));

                if (navigator.onLine) {
                    try { await db.collection('surveys').doc(id).update(data); }
                    catch (e) { queueAction('UPDATE', data, id); }
                } else {
                    queueAction('UPDATE', data, id);
                }
            };

            const deleteSurvey = async (id, permanent = false) => {
                if (permanent) {
                     const filtered = surveys.filter(s => s.id !== id);
                     setSurveys(filtered);
                     localStorage.setItem('vellora_surveys', JSON.stringify(filtered));
                     if(navigator.onLine) await db.collection('surveys').doc(id).delete();
                } else {
                    // Soft Delete
                    updateSurvey(id, { isDeleted: true });
                }
            };

            const restoreSurvey = async (id) => {
                updateSurvey(id, { isDeleted: false });
            }

            const queueAction = (type, data, id = null) => {
                const newOutbox = [...outbox, { type, data, id, timestamp: Date.now() }];
                setOutbox(newOutbox);
                localStorage.setItem('vellora_outbox', JSON.stringify(newOutbox));
            };

            return { surveys, isOnline, addSurvey, updateSurvey, deleteSurvey, restoreSurvey };
        };

        // ==========================================
        // 3. UI COMPONENTS
        // ==========================================
        
        // --- Icons ---
        const Icons = {
            Home: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            Chart: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Plus: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
        };

        // --- Wizard Step Components ---
        const InputGroup = ({ label, children, theme }) => (
            <div className="mb-4">
                <label className="block text-xs font-bold uppercase tracking-wider mb-1 opacity-70">{label}</label>
                {children}
            </div>
        );

        const TextInput = ({ value, onChange, placeholder, type="text", theme }) => (
            <input 
                type={type} 
                value={value} 
                onChange={e => onChange(e.target.value)}
                placeholder={placeholder}
                className="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none bg-transparent smooth-transition"
            />
        );

        const ButtonGrid = ({ options, selected, onSelect, allowOther, otherValue, onOtherChange }) => (
            <div className="flex flex-wrap gap-2">
                {options.map(opt => (
                    <button 
                        key={opt}
                        onClick={() => onSelect(opt)}
                        className={`px-4 py-2 rounded-full text-sm font-medium border transition-all ${
                            selected.includes(opt) 
                            ? 'bg-blue-600 text-white border-blue-600' 
                            : 'bg-opacity-10 border-gray-300 hover:border-gray-400 opacity-80'
                        }`}
                    >
                        {opt}
                    </button>
                ))}
                {allowOther && (
                    <div className="flex items-center gap-2 flex-grow min-w-[120px]">
                        <button
                             onClick={() => onSelect('Other')}
                             className={`px-4 py-2 rounded-full text-sm font-medium border ${selected.includes('Other') ? 'bg-blue-600 text-white' : 'border-gray-300'}`}
                        >Other</button>
                        {selected.includes('Other') && (
                            <input 
                                type="text" 
                                value={otherValue || ''} 
                                onChange={e => onOtherChange(e.target.value)}
                                className="flex-grow p-1 px-2 text-sm border-b bg-transparent outline-none" 
                                placeholder="Specify..."
                            />
                        )}
                    </div>
                )}
            </div>
        );

        // --- Main App Component ---
        const App = () => {
            // State
            const [view, setView] = React.useState('home'); // home, analytics, settings, wizard, detail
            const [currentTheme, setCurrentTheme] = React.useState('obsidian');
            const [activeSurvey, setActiveSurvey] = React.useState(null);
            const { surveys, isOnline, addSurvey, updateSurvey, deleteSurvey, restoreSurvey } = useSyncEngine();
            const [logo, setLogo] = React.useState(localStorage.getItem('vellora_logo') || null);

            // Derived State
            const activeSurveys = surveys.filter(s => !s.isDeleted);
            const deletedSurveys = surveys.filter(s => s.isDeleted);

            // Helpers
            const themeObj = THEMES.find(t => t.id === currentTheme) || THEMES[0];
            const getClasses = () => currentTheme === 'obsidian' ? 'theme-obsidian text-white' : `${themeObj.bg} ${themeObj.text}`;
            
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onloadend = () => {
                    setLogo(reader.result);
                    localStorage.setItem('vellora_logo', reader.result);
                };
                if (file) reader.readAsDataURL(file);
            };

            const exportPDF = (survey) => {
                const doc = new jspdf.jsPDF();
                
                // Header
                if (logo) {
                    doc.addImage(logo, 'JPEG', 15, 10, 20, 20); // Logo
                }
                doc.setFontSize(22);
                doc.setTextColor(0, 0, 0); // Always black text for PDF
                doc.text("VELLORA REPORT", 195, 20, { align: "right" });
                
                doc.setFontSize(12);
                doc.text(`Business: ${survey.businessName}`, 15, 40);
                doc.text(`Location: ${survey.area || 'N/A'}`, 15, 46);
                doc.text(`Date: ${new Date(survey.createdAt).toLocaleDateString()}`, 15, 52);

                // Data Prep for AutoTable
                const tableData = [
                    ["Section", "Details"],
                    ["Profile", `Type: ${survey.businessType}, Footfall: ${survey.footfall}`],
                    ["Inventory", `Brands: ${survey.brands?.join(', ')}`],
                    ["Financials", `Profit Margin: ${survey.pricing?.[0]?.profit || 0}`],
                    ["Supplier", `Sources: ${survey.supplyChain?.length || 0} active`],
                    ["Pitch", `Interest: ${survey.pitch?.switchInterest}`],
                    ["Contact", `${survey.contact?.name} (${survey.contact?.mobile})`]
                ];

                doc.autoTable({
                    startY: 60,
                    head: [['Metric', 'Value']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fillColor: [255, 255, 255], textColor: 0 },
                    headStyles: { fillColor: [0, 0, 0], textColor: 255 }
                });

                doc.save(`Vellora_${survey.businessName}.pdf`);
            };

            // --- Sub-Components (Inline for single file) ---

            const Wizard = () => {
                const [step, setStep] = React.useState('A');
                const [formData, setFormData] = React.useState(activeSurvey || {
                    businessName: '', businessType: '', footfall: '',
                    area: '', coordinates: '',
                    brands: [], sizes: [], inventoryType: 'Monthly', inventoryQty: '',
                    pricing: [], supplyChain: [],
                    creditLine: 'NO', creditDetails: {},
                    pitch: {}, whiteLabel: 'NO', whiteLabelDetails: {},
                    contact: {}
                });

                const steps = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

                const nextStep = () => {
                    const idx = steps.indexOf(step);
                    if (idx < steps.length - 1) setStep(steps[idx + 1]);
                    else saveSurvey();
                };

                const saveSurvey = () => {
                    if (activeSurvey?.id) updateSurvey(activeSurvey.id, formData);
                    else addSurvey(formData);
                    setView('home');
                    setActiveSurvey(null);
                };

                // Wizard Steps Logic
                const renderStep = () => {
                    switch(step) {
                        case 'A': return (
                            <div className="space-y-4 animate-fade-in">
                                <h2 className="text-xl font-bold mb-4">Step A: Profile & Location</h2>
                                <InputGroup label="Business Name">
                                    <TextInput value={formData.businessName} onChange={v => setFormData({...formData, businessName: v})} placeholder="Enter name..." />
                                </InputGroup>
                                <InputGroup label="Business Type">
                                    <ButtonGrid 
                                        options={['Retail', 'Wholesale', 'Gym', 'Pharmacy']} 
                                        selected={[formData.businessType]} 
                                        onSelect={v => setFormData({...formData, businessType: v})}
                                        allowOther={true}
                                        otherValue={formData.businessTypeOther}
                                        onOtherChange={v => setFormData({...formData, businessTypeOther: v, businessType: 'Other'})}
                                    />
                                </InputGroup>
                                <InputGroup label="Footfall (Daily)">
                                    <ButtonGrid options={['<50', '50-100', '100-500', '500+']} selected={[formData.footfall]} onSelect={v => setFormData({...formData, footfall: v})} />
                                </InputGroup>
                                <InputGroup label="Location">
                                    <div className="flex gap-2">
                                        <TextInput value={formData.area} onChange={v => setFormData({...formData, area: v})} placeholder="Area Name" />
                                        <button onClick={() => {
                                            if(navigator.geolocation) {
                                                navigator.geolocation.getCurrentPosition(p => {
                                                    setFormData({...formData, coordinates: `${p.coords.latitude},${p.coords.longitude}`});
                                                });
                                            }
                                        }} className="bg-blue-600 text-white p-3 rounded-lg"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                    </div>
                                    <div className="mt-2 text-xs opacity-60 font-mono">{formData.coordinates}</div>
                                </InputGroup>
                            </div>
                        );
                        case 'B': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step B: Inventory</h2>
                                <InputGroup label="Brands Stocked">
                                    <ButtonGrid 
                                        options={['Nike', 'Adidas', 'Puma', 'Local', 'Imported']} 
                                        selected={formData.brands} 
                                        onSelect={v => {
                                            const newBrands = formData.brands.includes(v) ? formData.brands.filter(b=>b!==v) : [...formData.brands, v];
                                            setFormData({...formData, brands: newBrands});
                                        }}
                                        allowOther={true}
                                    />
                                </InputGroup>
                                <InputGroup label="Quantity Estimation">
                                    <div className="flex items-center gap-4 mb-2">
                                        <button onClick={() => setFormData({...formData, inventoryType: 'Daily'})} className={`px-3 py-1 rounded ${formData.inventoryType === 'Daily' ? 'bg-blue-600 text-white' : 'border'}`}>Daily</button>
                                        <button onClick={() => setFormData({...formData, inventoryType: 'Monthly'})} className={`px-3 py-1 rounded ${formData.inventoryType === 'Monthly' ? 'bg-blue-600 text-white' : 'border'}`}>Monthly</button>
                                    </div>
                                    <TextInput type="number" value={formData.inventoryQty} onChange={v => setFormData({...formData, inventoryQty: v})} placeholder="Enter Qty" />
                                    <div className="text-sm mt-2 text-blue-500 font-bold">
                                        Total Monthly: {formData.inventoryType === 'Daily' ? (parseInt(formData.inventoryQty || 0) * 30) : formData.inventoryQty} units
                                    </div>
                                </InputGroup>
                            </div>
                        );
                        case 'C': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step C: Pricing Matrix</h2>
                                <div className="space-y-4">
                                    {formData.brands.map((brand, idx) => (
                                        <div key={idx} className="p-3 border rounded-lg bg-white bg-opacity-5">
                                            <div className="font-bold mb-2">{brand}</div>
                                            <div className="flex gap-2">
                                                <TextInput type="number" placeholder="Buy Price" value={formData.pricing[idx]?.buy || ''} 
                                                    onChange={v => {
                                                        const newP = [...(formData.pricing || [])];
                                                        if(!newP[idx]) newP[idx] = {};
                                                        newP[idx].buy = v;
                                                        newP[idx].profit = (newP[idx].sell || 0) - v;
                                                        setFormData({...formData, pricing: newP});
                                                    }} 
                                                />
                                                <TextInput type="number" placeholder="Sell Price" value={formData.pricing[idx]?.sell || ''} 
                                                    onChange={v => {
                                                        const newP = [...(formData.pricing || [])];
                                                        if(!newP[idx]) newP[idx] = {};
                                                        newP[idx].sell = v;
                                                        newP[idx].profit = v - (newP[idx].buy || 0);
                                                        setFormData({...formData, pricing: newP});
                                                    }} 
                                                />
                                            </div>
                                            <div className="text-right text-xs mt-1 text-green-500 font-mono">
                                                Profit: {formData.pricing[idx]?.profit || 0}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                        case 'D': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step D: Supply Chain</h2>
                                {formData.brands.map((brand, idx) => (
                                    <div key={idx} className="mb-6 border-b pb-4 border-gray-700">
                                        <h3 className="font-bold text-blue-400 mb-2">{brand} Supplier</h3>
                                        <InputGroup label="Source Type">
                                            <select 
                                                className="w-full p-2 rounded bg-transparent border outline-none"
                                                value={formData.supplyChain[idx]?.type || ''}
                                                onChange={e => {
                                                    const newSC = [...(formData.supplyChain || [])];
                                                    if(!newSC[idx]) newSC[idx] = {};
                                                    newSC[idx].type = e.target.value;
                                                    setFormData({...formData, supplyChain: newSC});
                                                }}
                                            >
                                                <option value="">Select...</option>
                                                <option value="Distributor">Distributor</option>
                                                <option value="Wholesaler">Wholesaler</option>
                                                <option value="Manufacturer">Manufacturer</option>
                                            </select>
                                        </InputGroup>
                                        <TextInput placeholder="Supplier Name" value={formData.supplyChain[idx]?.name || ''} onChange={v => {
                                            const newSC = [...(formData.supplyChain || [])];
                                            if(!newSC[idx]) newSC[idx] = {};
                                            newSC[idx].name = v;
                                            setFormData({...formData, supplyChain: newSC});
                                        }} />
                                        <div className="h-2"></div>
                                        <TextInput placeholder="Mobile (Required)" type="tel" value={formData.supplyChain[idx]?.mobile || ''} onChange={v => {
                                            const newSC = [...(formData.supplyChain || [])];
                                            if(!newSC[idx]) newSC[idx] = {};
                                            newSC[idx].mobile = v;
                                            setFormData({...formData, supplyChain: newSC});
                                        }} />
                                        <div className="mt-2 flex items-center justify-between">
                                            <span className="text-sm">Satisfied?</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => {
                                                     const newSC = [...(formData.supplyChain || [])];
                                                     if(!newSC[idx]) newSC[idx] = {};
                                                     newSC[idx].satisfied = true;
                                                     setFormData({...formData, supplyChain: newSC});
                                                }} className={`px-3 py-1 rounded ${formData.supplyChain[idx]?.satisfied === true ? 'bg-green-600' : 'border'}`}>YES</button>
                                                <button onClick={() => {
                                                     const newSC = [...(formData.supplyChain || [])];
                                                     if(!newSC[idx]) newSC[idx] = {};
                                                     newSC[idx].satisfied = false;
                                                     setFormData({...formData, supplyChain: newSC});
                                                }} className={`px-3 py-1 rounded ${formData.supplyChain[idx]?.satisfied === false ? 'bg-red-600' : 'border'}`}>NO</button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        );
                        case 'E': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step E: Credit Line</h2>
                                <div className="flex justify-center gap-4 mb-6">
                                    <button onClick={() => setFormData({...formData, creditLine: 'YES'})} className={`px-6 py-3 rounded-lg font-bold ${formData.creditLine === 'YES' ? 'bg-blue-600 text-white' : 'border'}`}>YES</button>
                                    <button onClick={() => setFormData({...formData, creditLine: 'NO'})} className={`px-6 py-3 rounded-lg font-bold ${formData.creditLine === 'NO' ? 'bg-gray-600 text-white' : 'border'}`}>NO</button>
                                </div>
                                {formData.creditLine === 'YES' && (
                                    <div className="animate-fade-in space-y-3">
                                        <InputGroup label="Amount">
                                            <TextInput type="number" placeholder="Limit" value={formData.creditDetails?.amount || ''} onChange={v => setFormData({...formData, creditDetails: {...formData.creditDetails, amount: v}})} />
                                        </InputGroup>
                                        <InputGroup label="Period (Days)">
                                            <TextInput type="number" placeholder="Days" value={formData.creditDetails?.days || ''} onChange={v => setFormData({...formData, creditDetails: {...formData.creditDetails, days: v}})} />
                                        </InputGroup>
                                    </div>
                                )}
                            </div>
                        );
                        case 'F': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step F: Sales Pitch</h2>
                                <InputGroup label="Interested in Switching?">
                                    <ButtonGrid options={['Yes', 'No', 'Maybe']} selected={[formData.pitch.switchInterest]} onSelect={v => setFormData({...formData, pitch: {...formData.pitch, switchInterest: v}})} />
                                </InputGroup>
                                <InputGroup label="Target Price Offer?">
                                    <TextInput placeholder="Enter amount..." value={formData.pitch.targetPrice || ''} onChange={v => setFormData({...formData, pitch: {...formData.pitch, targetPrice: v}})} />
                                </InputGroup>
                                <InputGroup label="Interested in VELLORA?">
                                     <ButtonGrid options={['YES', 'NO']} selected={[formData.pitch.velloraInterest]} onSelect={v => setFormData({...formData, pitch: {...formData.pitch, velloraInterest: v}})} />
                                </InputGroup>
                            </div>
                        );
                        case 'G': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step G: White Label</h2>
                                <InputGroup label="Custom Branding?">
                                    <div className="flex gap-4">
                                        <button onClick={() => setFormData({...formData, whiteLabel: 'YES'})} className={`flex-1 py-2 rounded ${formData.whiteLabel === 'YES' ? 'bg-purple-600' : 'border'}`}>YES</button>
                                        <button onClick={() => setFormData({...formData, whiteLabel: 'NO'})} className={`flex-1 py-2 rounded ${formData.whiteLabel === 'NO' ? 'bg-gray-600' : 'border'}`}>NO</button>
                                    </div>
                                </InputGroup>
                                {formData.whiteLabel === 'YES' && (
                                    <div className="mt-4">
                                        <TextInput placeholder="Purpose (Event, Resale...)" value={formData.whiteLabelDetails?.purpose || ''} onChange={v => setFormData({...formData, whiteLabelDetails: {...formData.whiteLabelDetails, purpose: v}})} />
                                    </div>
                                )}
                            </div>
                        );
                        case 'H': return (
                            <div className="space-y-4">
                                <h2 className="text-xl font-bold mb-4">Step H: Finalize</h2>
                                <InputGroup label="Contact Person">
                                    <TextInput placeholder="Name" value={formData.contact.name || ''} onChange={v => setFormData({...formData, contact: {...formData.contact, name: v}})} />
                                </InputGroup>
                                <InputGroup label="Mobile Number">
                                    <TextInput type="tel" placeholder="Mobile" value={formData.contact.mobile || ''} onChange={v => setFormData({...formData, contact: {...formData.contact, mobile: v}})} />
                                </InputGroup>
                                
                                <div className="mt-8 p-4 rounded-lg border border-dashed border-gray-500 opacity-80">
                                    <h3 className="uppercase text-xs font-bold mb-2 text-center">Summary (Read Only)</h3>
                                    <div className="text-sm grid grid-cols-2 gap-2">
                                        <div><strong>Biz:</strong> {formData.businessName}</div>
                                        <div><strong>Area:</strong> {formData.area}</div>
                                        <div><strong>Brands:</strong> {formData.brands.length}</div>
                                        <div><strong>Interest:</strong> {formData.pitch.switchInterest}</div>
                                    </div>
                                </div>
                            </div>
                        );
                    }
                };

                return (
                    <div className="fixed inset-0 z-50 flex flex-col bg-inherit text-inherit">
                        <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                            <button onClick={() => setView('home')} className="text-sm opacity-70">Cancel</button>
                            <h1 className="font-bold">Survey Wizard</h1>
                            <div className="text-sm opacity-70">{step}/H</div>
                        </div>
                        <div className="flex-grow overflow-y-auto p-6">
                            {renderStep()}
                        </div>
                        <div className="p-4 border-t border-gray-800">
                            <button onClick={nextStep} className="w-full bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg">
                                {step === 'H' ? 'SAVE SURVEY' : 'NEXT STEP'}
                            </button>
                        </div>
                    </div>
                );
            };

            const Analytics = () => (
                <div className="p-4 pb-24">
                    <h2 className="text-2xl font-bold mb-6">Market Intel</h2>
                    
                    <div className="mb-8 card p-4 rounded-xl shadow-sm border border-opacity-10 border-white">
                        <h3 className="text-sm font-bold uppercase mb-4 opacity-70">Brand Penetration</h3>
                        <div className="h-40 flex items-end gap-2">
                            {['Nike', 'Adidas', 'Puma', 'Local'].map(brand => {
                                const count = activeSurveys.filter(s => s.brands?.includes(brand)).length;
                                const height = count * 20 + 10;
                                return (
                                    <div key={brand} className="flex-1 flex flex-col items-center group">
                                        <div style={{height: `${height}px`}} className="w-full bg-blue-500 bg-opacity-80 rounded-t transition-all duration-500 relative">
                                            <span className="absolute -top-6 w-full text-center text-xs">{count}</span>
                                        </div>
                                        <span className="text-xs mt-2 opacity-60 truncate w-full text-center">{brand}</span>
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                         <div className="card p-4 rounded-xl shadow-sm border border-opacity-10 border-white">
                            <h3 className="text-xs font-bold uppercase mb-2">Interest High</h3>
                            <div className="text-3xl font-bold text-green-500">
                                {activeSurveys.filter(s => s.pitch?.switchInterest === 'Yes').length}
                            </div>
                            <div className="text-xs opacity-50">Leads</div>
                         </div>
                         <div className="card p-4 rounded-xl shadow-sm border border-opacity-10 border-white">
                            <h3 className="text-xs font-bold uppercase mb-2">WL Potential</h3>
                            <div className="text-3xl font-bold text-purple-500">
                                {activeSurveys.filter(s => s.whiteLabel === 'YES').length}
                            </div>
                            <div className="text-xs opacity-50">Requests</div>
                         </div>
                    </div>
                </div>
            );

            const Settings = () => {
                const [pin, setPin] = React.useState('');
                const [showBin, setShowBin] = React.useState(false);

                const unlockBin = () => {
                    if (pin === '1234') setShowBin(true);
                    else alert('Incorrect PIN');
                };

                return (
                    <div className="p-4 pb-24 space-y-8">
                        <div>
                            <h2 className="text-xl font-bold mb-4">Appearance</h2>
                            <div className="grid grid-cols-3 gap-2">
                                {THEMES.map(t => (
                                    <button 
                                        key={t.id}
                                        onClick={() => setCurrentTheme(t.id)} 
                                        className={`p-2 text-xs rounded border ${currentTheme===t.id ? 'border-blue-500' : 'border-transparent'}`}
                                        style={{backgroundColor: t.id === 'obsidian' ? '#000' : '#fff', color: t.id ==='obsidian' ? '#fff' : '#000'}}
                                    >
                                        {t.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <h2 className="text-xl font-bold mb-4">Branding</h2>
                            <div className="flex items-center gap-4">
                                {logo && <img src={logo} className="w-16 h-16 object-contain bg-white rounded" />}
                                <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm" />
                            </div>
                        </div>

                        <div>
                            <h2 className="text-xl font-bold mb-4">Data Management</h2>
                            <button onClick={() => {
                                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(activeSurveys));
                                const downloadAnchorNode = document.createElement('a');
                                downloadAnchorNode.setAttribute("href",     dataStr);
                                downloadAnchorNode.setAttribute("download", "vellora_backup.json");
                                document.body.appendChild(downloadAnchorNode);
                                downloadAnchorNode.click();
                                downloadAnchorNode.remove();
                            }} className="w-full mb-2 p-3 border rounded border-gray-600">Export JSON Backup</button>
                        </div>

                        <div className="pt-8 border-t border-gray-800">
                            <h2 className="text-xl font-bold mb-4 text-red-500">Recycle Bin</h2>
                            {!showBin ? (
                                <div className="flex gap-2">
                                    <TextInput type="password" value={pin} onChange={setPin} placeholder="Enter PIN (1234)" />
                                    <button onClick={unlockBin} className="bg-red-900 px-4 rounded">Unlock</button>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {deletedSurveys.length === 0 && <div className="text-sm opacity-50">Bin is empty.</div>}
                                    {deletedSurveys.map(s => (
                                        <div key={s.id} className="flex justify-between items-center p-2 border border-gray-800 rounded">
                                            <span className="text-sm truncate w-1/2">{s.businessName}</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => restoreSurvey(s.id)} className="text-green-500 text-xs uppercase">Restore</button>
                                                <button onClick={() => deleteSurvey(s.id, true)} className="text-red-500 text-xs uppercase">Destroy</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const SurveyDetail = ({ survey, onClose }) => (
                <div className={`fixed inset-0 z-40 flex flex-col ${getClasses()}`}>
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-inherit">
                        <button onClick={onClose} className="p-2">Back</button>
                        <h2 className="font-bold truncate max-w-[200px]">{survey.businessName}</h2>
                        <button onClick={() => {
                            if(confirm("Move to Recycle Bin?")) {
                                deleteSurvey(survey.id);
                                onClose();
                            }
                        }} className="text-red-500"><Icons.Trash /></button>
                    </div>
                    
                    <div className="flex-grow overflow-y-auto p-4 space-y-6">
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div className="opacity-70">Type</div><div>{survey.businessType}</div>
                            <div className="opacity-70">Area</div><div>{survey.area}</div>
                            <div className="opacity-70">Contact</div><div>{survey.contact?.name}</div>
                            <div className="opacity-70">Mobile</div><div className="text-blue-400 underline" onClick={() => window.open(`tel:${survey.contact?.mobile}`)}>{survey.contact?.mobile}</div>
                        </div>

                        <div className="border-t border-gray-800 pt-4">
                            <h3 className="font-bold mb-2">Inventory</h3>
                            <div className="flex flex-wrap gap-2">
                                {survey.brands?.map(b => <span key={b} className="px-2 py-1 bg-gray-800 rounded text-xs">{b}</span>)}
                            </div>
                        </div>

                        <div className="border-t border-gray-800 pt-4">
                            <h3 className="font-bold mb-2">Pitch Result</h3>
                            <div className="p-3 bg-gray-800 bg-opacity-30 rounded">
                                <div className="text-xs opacity-50">Switch Interest</div>
                                <div className="text-lg">{survey.pitch?.switchInterest || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 border-t border-gray-800 grid grid-cols-4 gap-2 bg-inherit">
                        <button onClick={() => { setActiveSurvey(survey); setView('wizard'); }} className="flex flex-col items-center text-xs gap-1"><Icons.Edit /> Edit</button>
                        <button onClick={() => exportPDF(survey)} className="flex flex-col items-center text-xs gap-1"><span className="text-xl">üìÑ</span> PDF</button>
                        <button onClick={() => window.open(`https://maps.google.com/?q=${survey.coordinates}`)} className="flex flex-col items-center text-xs gap-1"><span className="text-xl">üìç</span> Map</button>
                        <button onClick={() => window.open(`tel:${survey.contact?.mobile}`)} className="flex flex-col items-center text-xs gap-1"><span className="text-xl">üìû</span> Call</button>
                    </div>
                </div>
            );

            // --- Main Render ---
            return (
                <div className={`min-h-screen flex flex-col ${getClasses()}`}>
                    {/* HEADER */}
                    <header className={`p-4 flex justify-between items-center sticky top-0 z-30 backdrop-blur-md bg-opacity-90 border-b border-gray-800`}>
                        <div className="font-black text-2xl tracking-tighter">VELLORA</div>
                        <div className="flex gap-2 items-center">
                            {!isOnline && <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>}
                        </div>
                    </header>

                    {/* CONTENT */}
                    <main className="flex-grow relative overflow-hidden">
                        {view === 'wizard' && <Wizard />}
                        {activeSurvey && view !== 'wizard' && <SurveyDetail survey={activeSurvey} onClose={() => setActiveSurvey(null)} />}
                        
                        {view === 'home' && !activeSurvey && (
                            <div className="p-4 pb-24 space-y-3">
                                {activeSurveys.length === 0 ? (
                                    <div className="text-center mt-20 opacity-50">
                                        <p>No surveys found.</p>
                                        <p className="text-sm">Start your first market visit.</p>
                                    </div>
                                ) : (
                                    activeSurveys.map(s => (
                                        <div onClick={() => setActiveSurvey(s)} key={s.id} className="card p-4 rounded-xl cursor-pointer relative overflow-hidden group hover:scale-[1.01] transition-transform">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="font-bold text-lg">{s.businessName}</h3>
                                                    <p className="text-sm opacity-60">{s.area} ‚Ä¢ {new Date(s.createdAt).toLocaleDateString()}</p>
                                                </div>
                                                {s.pitch?.switchInterest === 'Yes' && <span className="px-2 py-0.5 bg-red-600 text-white text-[10px] uppercase font-bold rounded">Hot</span>}
                                            </div>
                                            {s.whiteLabel === 'YES' && <div className="mt-2 text-[10px] text-purple-400 font-mono tracking-widest uppercase">White Label Prospect</div>}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                        
                        {view === 'analytics' && <Analytics />}
                        {view === 'settings' && <Settings />}
                    </main>

                    {/* FAB (Only on Home) */}
                    {view === 'home' && !activeSurvey && (
                        <button 
                            onClick={() => setView('wizard')}
                            className="fixed bottom-24 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transform hover:scale-110 transition-all z-20"
                        >
                            <Icons.Plus />
                        </button>
                    )}

                    {/* NAVIGATION */}
                    {!activeSurvey && view !== 'wizard' && (
                        <nav className={`fixed bottom-0 w-full p-2 pb-6 flex justify-around items-center border-t border-gray-800 z-30 ${themeObj.nav}`}>
                            <button onClick={() => setView('analytics')} className={`p-3 rounded-xl transition-all ${view==='analytics' ? 'bg-blue-600 text-white' : 'opacity-50'}`}>
                                <Icons.Chart />
                            </button>
                            <button onClick={() => setView('home')} className={`p-3 rounded-xl transition-all ${view==='home' ? 'bg-blue-600 text-white scale-110 shadow-lg' : 'opacity-50'}`}>
                                <Icons.Home />
                            </button>
                            <button onClick={() => setView('settings')} className={`p-3 rounded-xl transition-all ${view==='settings' ? 'bg-blue-600 text-white' : 'opacity-50'}`}>
                                <Icons.Settings />
                            </button>
                        </nav>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
