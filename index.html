<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vellora">
    
    <title>Vellora Survey AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.2.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* iOS Safe Area handling */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="text-gray-900 h-screen w-screen overflow-hidden bg-gray-50">
    <div id="root" class="h-full w-full">
        <!-- Loading State -->
        <div class="h-full flex items-center justify-center flex-col">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <h2 class="text-lg font-semibold text-gray-600">Loading Vellora...</h2>
        </div>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Loader, Check, Zap, Plus, X, List, AlertTriangle, 
            TrendingUp, PieChart as PieIcon, Home, Eye, 
            Settings, DollarSign, Package, User, MapPin, 
            Trash2, Wifi, WifiOff, LocateFixed, Navigation, AlertCircle, 
            ChevronRight, Cloud, Lock, Sparkles, Map as MapIcon,
            ArrowUpDown, ArrowUp, ArrowDown, LogOut
        } from 'lucide-react';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, deleteDoc } from 'firebase/firestore';
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
            authDomain: "vellora-3828d.firebaseapp.com",
            projectId: "vellora-3828d",
            storageBucket: "vellora-3828d.firebasestorage.app",
            messagingSenderId: "1045366360458",
            appId: "1:1045366360458:web:c9de51b7942bd743d9a073",
            measurementId: "G-WLKMJNBJTP"
        };

        const GEMINI_API_KEY = "AIzaSyCTGO098tUeKlMo0zFJUDxmHZryQgzD76w"; 

        // ==========================================
        // SERVICES
        // ==========================================

        const generateSalesPitch = async (prompt) => {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("PASTE")) return "Error: API Key missing.";
            try {
                const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                const result = await model.generateContent(`You are a water sales expert. Keep it punchy, direct, and short (max 2 sentences). ${prompt}`);
                const response = await result.response;
                return response.text() || "Could not generate pitch.";
            } catch (e) {
                console.error("Gemini Error:", e);
                return "AI Service Unavailable.";
            }
        };

        class BackendService {
            constructor() {
                this.db = null;
                this.status = 'Offline';
                this.initialized = false;
            }

            init(onStatusChange) {
                if (this.initialized) return;
                this.initialized = true;
                try {
                    const app = initializeApp(FIREBASE_CONFIG);
                    const auth = getAuth(app);
                    this.db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) await signInAnonymously(auth);
                        onStatusChange('Cloud');
                        this.status = 'Cloud';
                    });
                } catch (e) {
                    onStatusChange('Offline');
                }
            }

            subscribeSurveys(syncCode, callback) {
                const localData = JSON.parse(localStorage.getItem(`vellora_surveys_${syncCode}`) || '[]');
                callback(localData);

                if (this.status === 'Cloud' && this.db) {
                    const surveyRef = collection(this.db, `vellora_data/${syncCode}/surveys`);
                    return onSnapshot(surveyRef, (snap) => {
                        const s = [];
                        snap.forEach(d => s.push({ id: d.id, ...d.data() }));
                        const sorted = s.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        localStorage.setItem(`vellora_surveys_${syncCode}`, JSON.stringify(sorted));
                        callback(sorted);
                    });
                }
                return () => {};
            }

            async addSurvey(syncCode, survey) {
                const localSurveys = JSON.parse(localStorage.getItem(`vellora_surveys_${syncCode}`) || '[]');
                localStorage.setItem(`vellora_surveys_${syncCode}`, JSON.stringify([survey, ...localSurveys]));
                if (this.status === 'Cloud' && this.db) {
                    await addDoc(collection(this.db, `vellora_data/${syncCode}/surveys`), survey);
                }
            }

            async deleteSurvey(syncCode, id) {
                const localSurveys = JSON.parse(localStorage.getItem(`vellora_surveys_${syncCode}`) || '[]');
                localStorage.setItem(`vellora_surveys_${syncCode}`, JSON.stringify(localSurveys.filter(s => s.id !== id)));
                if (this.status === 'Cloud' && this.db) {
                    await deleteDoc(doc(this.db, `vellora_data/${syncCode}/surveys`, id));
                }
            }
        }

        const backend = new BackendService();

        // ==========================================
        // UI COMPONENTS
        // ==========================================

        const THEME = {
            bg: '#F3F4F6', surface: '#FFFFFF', text: '#111827', textSec: '#6B7280', 
            border: '#E5E7EB', primary: '#2563EB', primaryFg: '#FFFFFF', 
            inputBg: '#FFFFFF', success: '#10B981', error: '#EF4444', ai: '#8B5CF6' 
        };

        const ThemeInput = ({ label, ...props }) => (
            <div className="w-full mb-3">
                {label && <label className="text-xs font-bold uppercase tracking-wider mb-1.5 block text-gray-500">{label}</label>}
                <input {...props} className="w-full p-3 rounded-lg border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white" />
            </div>
        );

        const ThemeButton = ({ children, onClick, active, className = "" }) => (
            <button onClick={onClick} className={`px-4 py-3 rounded-lg text-sm font-medium border transition-all flex items-center justify-center ${className} ${active ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-[1.02]' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>
                {children}
            </button>
        );

        const LocationPicker = ({ area, gps, onAreaChange, onLocationFound }) => {
            const [status, setStatus] = useState('idle');
            const handleGetLocation = () => {
                if (!navigator.geolocation) return;
                setStatus('locating');
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    onLocationFound(area || "Current Location", { lat: latitude, lng: longitude });
                    setStatus('done');
                }, () => setStatus('error'));
            };

            return (
                <div className="flex flex-col gap-3">
                    <div className="flex gap-2">
                        <div className="flex-1"><ThemeInput value={area} onChange={(e) => onAreaChange(e.target.value)} placeholder="Enter Area Name" /></div>
                        <button onClick={handleGetLocation} className="px-4 py-3 rounded-lg text-sm font-bold flex items-center text-white bg-blue-600 shadow-sm whitespace-nowrap">
                            {status === 'locating' ? <Loader size={16} className="animate-spin"/> : <LocateFixed size={16} className="mr-2"/>}
                            {status === 'locating' ? '...' : 'Get GPS'}
                        </button>
                    </div>
                    {gps && <div className="text-xs font-mono text-gray-400 px-1 bg-gray-50 p-2 rounded border border-gray-100 flex items-center"><MapPin size={10} className="mr-1"/> {gps.lat.toFixed(6)}, {gps.lng.toFixed(6)}</div>}
                </div>
            );
        };

        const ConfirmationModal = ({ title, message, onConfirm, onCancel, confirmText = "Confirm", confirmColor = "bg-blue-600" }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all scale-100">
                    <h3 className="text-lg font-bold mb-2 text-gray-900">{title}</h3>
                    <p className="text-sm text-gray-500 mb-6">{message}</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 rounded-xl font-bold border border-gray-200 text-gray-600">Cancel</button>
                        <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg ${confirmColor}`}>{confirmText}</button>
                    </div>
                </div>
            </div>
        );

        // ==========================================
        // SURVEY WIZARD STEPS
        // ==========================================

        const Step1_Profile = ({ formData, updateForm }) => (
            <div className="space-y-6">
                <div className="flex items-center space-x-2 mb-4 pb-2 border-b"><User size={20} className="text-blue-600"/><h3 className="text-lg font-bold text-gray-800">Business Profile</h3></div>
                <ThemeInput label="Business Name" value={formData.businessName} onChange={(e) => updateForm('businessName', e.target.value)} placeholder="e.g. Blue Lagoon Cafe" />
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Business Type</label>
                    <div className="grid grid-cols-2 gap-2">{['Restaurant', 'Cafe', 'Hotel', 'Grocery', 'Corporate', 'Event', 'Other'].map(t => <ThemeButton key={t} onClick={() => updateForm('businessType', t)} active={formData.businessType === t}>{t}</ThemeButton>)}</div>
                </div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Location</label>
                    <LocationPicker area={formData.locationArea} gps={formData.gps} onAreaChange={(val) => updateForm('locationArea', val)} onLocationFound={(addr, gps) => { updateForm('locationArea', addr); updateForm('gps', gps); }} />
                </div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Daily Footfall</label>
                    <div className="flex gap-2">{['<50', '50-150', '150-300', '300+'].map(f => <ThemeButton key={f} onClick={() => updateForm('footfall', f)} active={formData.footfall === f}>{f}</ThemeButton>)}</div>
                </div>
            </div>
        );

        const Step2_Usage = ({ formData, updateForm, toggleMulti }) => (
            <div className="space-y-6">
                <div className="flex items-center space-x-2 mb-4 pb-2 border-b"><Package size={20} className="text-blue-600"/><h3 className="text-lg font-bold text-gray-800">Current Usage</h3></div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Current Brands</label>
                    <div className="flex flex-wrap gap-2">{['Kinley', 'Bisleri', 'Aquafina', 'Bailley', 'Local'].map(b => <ThemeButton key={b} onClick={() => toggleMulti('brands', b)} active={formData.brands.includes(b)}>{b}</ThemeButton>)}</div>
                </div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Bottle Sizes Used</label>
                    <div className="flex gap-2">{['250ml', '500ml', '1L'].map(s => <ThemeButton key={s} onClick={() => toggleMulti('bottleSizes', s)} active={formData.bottleSizes.includes(s)}>{s}</ThemeButton>)}</div>
                </div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Monthly Quantity</label>
                    <div className="grid grid-cols-2 gap-2">{['0-500', '500-1500', '1500-3000', '3000+'].map(r => <ThemeButton key={r} onClick={() => updateForm('monthlyRequirement', r)} active={formData.monthlyRequirement === r}>{r}</ThemeButton>)}</div>
                </div>
            </div>
        );

        const Step3_Pricing = ({ formData, updateForm }) => (
            <div className="space-y-6">
                <div className="flex items-center space-x-2 mb-4 pb-2 border-b"><DollarSign size={20} className="text-blue-600"/><h3 className="text-lg font-bold text-gray-800">Pricing & Margins</h3></div>
                {['250ml', '500ml', '1L'].map(size => (
                    <div key={size} className={`p-4 rounded-xl border ${formData.bottleSizes.includes(size) ? 'bg-white border-blue-200 shadow-sm' : 'bg-gray-100 border-gray-200 opacity-60'}`}>
                        <div className="flex justify-between mb-3"><h4 className="font-bold text-gray-700">{size} Bottle</h4>{!formData.bottleSizes.includes(size) && <span className="text-xs text-gray-400">Not selected</span>}</div>
                        <div className="grid grid-cols-3 gap-3">
                            <ThemeInput placeholder="Buy" type="number" value={formData.buyingPrice[size] || ''} onChange={(e) => updateForm('buyingPrice', e.target.value, size)} disabled={!formData.bottleSizes.includes(size)} />
                            <ThemeInput placeholder="Sell" type="number" value={formData.sellingPrice[size] || ''} onChange={(e) => updateForm('sellingPrice', e.target.value, size)} disabled={!formData.bottleSizes.includes(size)} />
                            <div className="w-full p-3 rounded-lg text-center font-bold bg-gray-50 border border-gray-200 text-gray-600">
                                {((parseFloat(formData.sellingPrice[size]||0) - parseFloat(formData.buyingPrice[size]||0)) || 0).toFixed(2)}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );

        const Step4_Service = ({ formData, updateForm, toggleMulti }) => (
            <div className="space-y-6">
                <div className="flex items-center space-x-2 mb-4 pb-2 border-b"><TruckIcon size={20} className="text-blue-600"/><h3 className="text-lg font-bold text-gray-800">Service & Distributor</h3></div>
                <ThemeInput label="Distributor Name" value={formData.distributorName} onChange={(e) => updateForm('distributorName', e.target.value)} />
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Delivery Frequency</label>
                    <div className="flex gap-2">{['Daily', 'Alternate', 'Weekly'].map(f => <ThemeButton key={f} onClick={() => updateForm('deliveryFrequency', f)} active={formData.deliveryFrequency === f}>{f}</ThemeButton>)}</div>
                </div>
                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Problems Faced</label>
                    <div className="grid grid-cols-2 gap-2">{['Late delivery', 'Stock shortage', 'High price', 'Poor quality'].map(p => <ThemeButton key={p} onClick={() => toggleMulti('mainProblems', p)} active={formData.mainProblems.includes(p)}>{p}</ThemeButton>)}</div>
                </div>
            </div>
        );

        const Step5_Final = ({ formData, updateForm, generatePitch, pitch, loadingPitch }) => (
            <div className="space-y-6">
                <div className="flex items-center space-x-2 mb-4 pb-2 border-b"><Sparkles size={20} className="text-blue-600"/><h3 className="text-lg font-bold text-gray-800">Closing & AI</h3></div>
                
                <div className="p-4 rounded-xl border border-purple-100 bg-purple-50">
                    <div className="flex justify-between items-center mb-3">
                        <span className="text-sm font-bold text-purple-700">AI Pitch Generator</span>
                        <button onClick={generatePitch} disabled={loadingPitch} className="bg-purple-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-md hover:bg-purple-700 transition-colors">
                            {loadingPitch ? 'Thinking...' : 'Generate Script'}
                        </button>
                    </div>
                    {pitch ? <div className="text-sm italic text-gray-700 bg-white p-3 rounded-lg border border-purple-100 shadow-sm">"{pitch}"</div> : <div className="text-xs text-purple-400 italic">Tap generate to get a custom sales script based on their data.</div>}
                </div>

                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Interested in White Label?</label>
                    <div className="flex gap-2 mb-3">{['Yes', 'No'].map(v => <ThemeButton key={v} onClick={() => updateForm('interestedInCustomLogo', v)} active={formData.interestedInCustomLogo === v}>{v}</ThemeButton>)}</div>
                    {formData.interestedInCustomLogo === 'Yes' && (
                        <ThemeInput label="Extra Willing to Pay (â‚¹)" type="number" value={formData.extraWillingToPay} onChange={(e) => updateForm('extraWillingToPay', e.target.value)} />
                    )}
                </div>

                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Preferred Bottle Type</label>
                    <div className="flex gap-2">{['Normal PET', 'Premium PET', 'Glass'].map(v => <ThemeButton key={v} onClick={() => updateForm('preferableMaterial', v)} active={formData.preferableMaterial === v}>{v}</ThemeButton>)}</div>
                </div>

                <div>
                    <label className="text-xs font-bold uppercase tracking-wider mb-2 block text-gray-500">Willing to Switch?</label>
                    <div className="flex gap-2">{['Yes', 'No', 'Maybe'].map(v => <ThemeButton key={v} onClick={() => updateForm('willingToSwitch', v)} active={formData.willingToSwitch === v}>{v}</ThemeButton>)}</div>
                </div>

                <div className="pt-4 border-t border-gray-200">
                    <ThemeInput label="Contact Name" value={formData.contactName} onChange={(e) => updateForm('contactName', e.target.value)} />
                    <ThemeInput label="Contact Number" type="tel" value={formData.contactMobile} onChange={(e) => updateForm('contactMobile', e.target.value)} />
                </div>
            </div>
        );

        // Truck Icon component since it was used but not imported in previous examples
        const TruckIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="13" x="2" y="5" rx="2"/><path d="m22 7-3-3"/><path d="M5 22h14"/><path d="M22 22h-2"/><path d="M17 22v-4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v4"/><path d="M5 22v-4a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4"/></svg>;

        // ==========================================
        // MAIN APP
        // ==========================================

        const App = () => {
            const [status, setStatus] = useState('Offline');
            const [syncCode, setSyncCode] = useState(() => localStorage.getItem('vellora_sync_code') || 'default');
            const [view, setView] = useState('home');
            const [modalOpen, setModalOpen] = useState(false);
            const [currentStep, setCurrentStep] = useState(0);
            const [surveys, setSurveys] = useState([]);
            
            // UI States
            const [deleteId, setDeleteId] = useState(null);
            const [showSaveConfirm, setShowSaveConfirm] = useState(false);
            const [pitch, setPitch] = useState('');
            const [loadingPitch, setLoadingPitch] = useState(false);

            // Form Data
            const initialForm = {
                id: '', timestamp: '', businessType: '', businessName: '', locationArea: '', footfall: '', gps: null,
                brands: [], bottleSizes: [], monthlyRequirement: '',
                buyingPrice: {}, sellingPrice: {},
                distributorName: '', deliveryFrequency: '', mainProblems: [],
                interestedInCustomLogo: 'No', extraWillingToPay: '', preferableMaterial: '',
                willingToSwitch: '', contactName: '', contactMobile: ''
            };
            const [formData, setFormData] = useState(initialForm);

            useEffect(() => { backend.init(setStatus); }, []);
            useEffect(() => {
                const unsub = backend.subscribeSurveys(syncCode, setSurveys);
                return () => unsub();
            }, [syncCode, status]);

            const updateForm = useCallback((field, val, sub) => {
                setFormData(p => {
                    if (sub) return { ...p, [field]: { ...p[field], [sub]: val } };
                    return { ...p, [field]: val };
                });
            }, []);

            const toggleMulti = useCallback((field, val) => { 
                setFormData(p => {
                    const arr = p[field] || [];
                    return { ...p, [field]: arr.includes(val) ? arr.filter(x => x !== val) : [...arr, val] };
                }); 
            }, []);

            const handleSave = async () => {
                const newSurvey = { ...formData, id: crypto.randomUUID(), timestamp: new Date() }; 
                await backend.addSurvey(syncCode, newSurvey);
                setShowSaveConfirm(false);
                setModalOpen(false);
                setView('home');
            };

            const handleDelete = async () => {
                if (deleteId) await backend.deleteSurvey(syncCode, deleteId);
                setDeleteId(null);
            };

            const generatePitch = async () => {
                setLoadingPitch(true);
                const p = await generateSalesPitch(`Client: ${formData.businessName} (${formData.businessType}). Problems: ${formData.mainProblems.join(', ')}. Competitors: ${formData.brands.join(', ')}.`);
                setPitch(p);
                setLoadingPitch(false);
            };

            const steps = [
                { component: Step1_Profile, title: "Profile" },
                { component: Step2_Usage, title: "Usage" },
                { component: Step3_Pricing, title: "Pricing" },
                { component: Step4_Service, title: "Service" },
                { component: Step5_Final, title: "Final" }
            ];

            const CurrentStepComponent = steps[currentStep].component;

            return (
                <div className="h-full w-full flex flex-col bg-gray-50 pb-safe">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 px-4 py-3 pt-safe sticky top-0 z-10 shadow-sm flex justify-between items-center">
                        <div className="flex items-center space-x-2">
                            <div className="bg-blue-600 text-white p-1.5 rounded-lg"><Zap size={18}/></div>
                            <div>
                                <h1 className="font-bold text-gray-900 leading-none">VELLORA</h1>
                                <span className={`text-[10px] font-bold uppercase ${status === 'Cloud' ? 'text-green-500' : 'text-orange-500'}`}>{status}</span>
                            </div>
                        </div>
                        <button onClick={() => setView('settings')} className="p-2 text-gray-400 hover:text-gray-600"><Settings size={20}/></button>
                    </div>

                    {/* Main Content Area - Responsive Container */}
                    <main className="flex-1 overflow-y-auto p-4 w-full max-w-3xl mx-auto">
                        {view === 'home' && (
                            <div className="space-y-6">
                                {/* Stats Cards */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="text-xs font-bold text-gray-400 uppercase">Today</div>
                                        <div className="text-3xl font-black text-gray-900">{surveys.filter(s => new Date(s.timestamp?.seconds ? s.timestamp.seconds*1000 : s.timestamp).toDateString() === new Date().toDateString()).length}</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="text-xs font-bold text-gray-400 uppercase">Total</div>
                                        <div className="text-3xl font-black text-gray-900">{surveys.length}</div>
                                    </div>
                                </div>

                                {/* Big CTA Button */}
                                <button onClick={() => { setFormData(initialForm); setCurrentStep(0); setModalOpen(true); }} className="w-full py-8 bg-blue-600 text-white rounded-3xl shadow-lg shadow-blue-200 flex flex-col items-center justify-center transform active:scale-95 transition-all">
                                    <div className="bg-white/20 p-3 rounded-full mb-3"><Plus size={32}/></div>
                                    <span className="text-xl font-bold">New Survey</span>
                                </button>

                                {/* Quick Links */}
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setView('analytics')} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center h-24 active:bg-gray-50">
                                        <TrendingUp size={24} className="text-blue-500 mb-2"/>
                                        <span className="text-sm font-bold text-gray-700">Analytics</span>
                                    </button>
                                    <button onClick={() => setView('list')} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center h-24 active:bg-gray-50">
                                        <List size={24} className="text-blue-500 mb-2"/>
                                        <span className="text-sm font-bold text-gray-700">Data List</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'list' && (
                            <div className="space-y-3 pb-20">
                                <h2 className="font-bold text-gray-400 text-xs uppercase mb-2">Recent Entries</h2>
                                {surveys.map(s => (
                                    <div key={s.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center">
                                        <div>
                                            <div className="font-bold text-gray-900">{s.businessName || 'Unknown'}</div>
                                            <div className="text-xs text-gray-500 flex items-center mt-1">
                                                <span className="bg-gray-100 px-1.5 py-0.5 rounded mr-2">{s.businessType}</span>
                                                <MapPin size={10} className="mr-1"/> {s.locationArea}
                                            </div>
                                        </div>
                                        <button onClick={() => setDeleteId(s.id)} className="p-2 text-red-400 hover:bg-red-50 rounded-full transition-colors"><Trash2 size={18}/></button>
                                    </div>
                                ))}
                                {surveys.length === 0 && <div className="text-center py-10 text-gray-400 italic">No data yet. Start a survey!</div>}
                            </div>
                        )}

                        {view === 'analytics' && (
                            <div className="space-y-6">
                                <SimplePieChart title="Business Types" data={Object.entries(surveys.reduce((c, s) => { c[s.businessType]=(c[s.businessType]||0)+1; return c; }, {})).map(([k,v]) => ({name:k, value:v}))} theme={THEME} />
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                        <div className="text-2xl font-black text-blue-600">{surveys.filter(s => s.interestedInCustomLogo === 'Yes').length}</div>
                                        <div className="text-xs text-gray-500 font-bold uppercase">Want White Label</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                        <div className="text-2xl font-black text-green-600">{surveys.filter(s => s.willingToSwitch === 'Yes').length}</div>
                                        <div className="text-xs text-gray-500 font-bold uppercase">Ready to Switch</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-lg mb-4 flex items-center"><Cloud size={20} className="mr-2 text-blue-500"/> Data Sync</h3>
                                <p className="text-sm text-gray-500 mb-4">Enter a secret code to sync data between devices.</p>
                                <div className="relative">
                                    <Lock size={16} className="absolute left-3 top-3.5 text-gray-400"/>
                                    <input className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={syncCode} onChange={(e) => { setSyncCode(e.target.value); localStorage.setItem('vellora_sync_code', e.target.value); }} />
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <div className="bg-white border-t border-gray-200 px-6 py-2 pb-safe flex justify-around items-center shrink-0 z-20">
                        {['home', 'list', 'analytics'].map(v => (
                            <button key={v} onClick={() => setView(v)} className={`p-2 rounded-xl flex flex-col items-center transition-all ${view === v ? 'text-blue-600' : 'text-gray-400'}`}>
                                {v === 'home' && <Home size={24}/>} {v === 'list' && <List size={24}/>} {v === 'analytics' && <PieIcon size={24}/>}
                                <span className="text-[10px] font-bold uppercase mt-1">{v}</span>
                            </button>
                        ))}
                    </div>

                    {/* Modals */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-50 bg-gray-50 flex flex-col animate-in slide-in-from-bottom-full duration-300">
                            <div className="px-4 py-3 bg-white border-b border-gray-200 flex justify-between items-center pt-safe shadow-sm shrink-0">
                                <div className="flex items-center space-x-2">
                                    <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">Step {currentStep + 1}/{steps.length}</span>
                                    <span className="font-bold text-gray-700">{steps[currentStep].title}</span>
                                </div>
                                <button onClick={() => setModalOpen(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={20} className="text-gray-600"/></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-5 w-full max-w-2xl mx-auto">
                                <CurrentStepComponent formData={formData} updateForm={updateForm} toggleMulti={toggleMulti} generatePitch={generatePitch} pitch={pitch} loadingPitch={loadingPitch} />
                            </div>

                            <div className="bg-white border-t border-gray-200 p-4 pb-safe flex justify-between items-center shrink-0 max-w-2xl mx-auto w-full">
                                <button onClick={() => currentStep > 0 ? setCurrentStep(c => c-1) : null} disabled={currentStep === 0} className="text-gray-500 font-bold px-4 py-2 disabled:opacity-30">Back</button>
                                <button onClick={() => currentStep < steps.length - 1 ? setCurrentStep(c => c+1) : setShowSaveConfirm(true)} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-colors">
                                    {currentStep === steps.length - 1 ? 'Finish' : 'Next'}
                                </button>
                            </div>
                        </div>
                    )}

                    {deleteId && <ConfirmationModal title="Delete Survey?" message="This action cannot be undone." confirmText="Delete" confirmColor="bg-red-500" onConfirm={handleDelete} onCancel={() => setDeleteId(null)} />}
                    
                    {showSaveConfirm && (
                        <ConfirmationModal 
                            title="Save Survey?" 
                            message={`Saving entry for ${formData.businessName}. Ensure all data is correct.`} 
                            confirmText="Save Data" 
                            onConfirm={handleSave} 
                            onCancel={() => setShowSaveConfirm(false)} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


