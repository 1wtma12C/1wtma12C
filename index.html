<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VELLORA v4.0 ‚Äî Single File PWA</title>

  <!-- Tailwind via CDN (play CDN for standalone) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel standalone to transpile JSX in-browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v9 compat (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Basic reset for Tailwind with Obsidian-ready variables */
    :root {
      --bg: #0a0a0a;
      --card: #0a0a0a;
      --text: #ffffff;
      --accent: #ffffff;
      --muted: #9ca3af;
    }
    [data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --accent: #0f172a;
      --muted: #6b7280;
    }
    body {
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .card {
      background: var(--card);
      color: var(--text);
      border-radius: .5rem;
      box-shadow: 0 6px 18px rgba(2,6,23,0.5);
      padding: 1rem;
    }
    .muted { color: var(--muted); }
    /* Header theme-sensitive text */
    .brand-text-light { color: black; }
    .brand-text-dark { color: white; }
    /* small helpers */
    .input {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      padding: .5rem;
      border-radius: .375rem;
      color: var(--text);
    }
    .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      padding: .5rem .75rem;
      border-radius: .375rem;
      color: var(--text);
      cursor: pointer;
    }
    .fab {
      position: fixed;
      right: 1.25rem;
      bottom: 4.5rem;
      z-index: 60;
      width: 64px;
      height: 64px;
      border-radius: 9999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }
    /* small modal */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:80;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

/** FIREBASE_CONFIG (exactly as provided) **/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCX48WOgrvJkxf_mzENh0-GhOPkbwdaCjw",
  authDomain: "vellora-3828d.firebaseapp.com",
  projectId: "vellora-3828d",
  storageBucket: "vellora-3828d.firebasestorage.app",
  messagingSenderId: "1045366360458",
  appId: "1:1045366360458:web:c9de51b7942bd743d9a073",
  measurementId: "G-WLKMJNBJTP"
};

/** Initialize Firebase (compat) **/
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();

/** Utilities **/
const uid = () => 's_'+Math.random().toString(36).slice(2,9);
const nowISO = ()=> new Date().toISOString();
const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const loadLocal = (k, fallback=null) => {
  const raw=localStorage.getItem(k); if(!raw) return fallback; try { return JSON.parse(raw); } catch(e){return fallback;}
};
const removeLocal = k => localStorage.removeItem(k);

/** App constants **/
const LOCAL_KEY = 'vellora_surveys_v4';
const OUTBOX_KEY = 'vellora_outbox_v4';
const SETTINGS_KEY = 'vellora_settings_v4';
const MASTERDATA_KEY = 'vellora_masterdata_v4';

/** Basic MasterData management for "Other" options */
const defaultMasterData = {
  types: ['Grocery','Restaurant','Pharmacy'],
  brands: ['Brand A','Brand B','Brand C'],
  sizes: ['Small','Medium','Large']
};
if (!loadLocal(MASTERDATA_KEY)) saveLocal(MASTERDATA_KEY, defaultMasterData);

/** Sync Engine: Online-First with Outbox queue **/
class SyncEngine {
  constructor() {
    this.online = navigator.onLine;
    this.outbox = loadLocal(OUTBOX_KEY, []);
    window.addEventListener('online', ()=>{ this.online = true; this.flush(); });
    window.addEventListener('offline', ()=>{ this.online = false; });
  }

  enqueue(op) {
    this.outbox.push(op);
    saveLocal(OUTBOX_KEY, this.outbox);
  }

  async flush() {
    if (!navigator.onLine) return;
    if (!this.outbox.length) return;
    // attempt to push each op to firebase
    const queue = [...this.outbox];
    for (const op of queue) {
      try {
        if (op.type === 'create' || op.type === 'update') {
          await db.collection('surveys').doc(op.id).set(op.payload, {merge:true});
        } else if (op.type === 'delete') {
          // soft-delete mark persisted
          await db.collection('surveys').doc(op.id).set({isDeleted: true, deletedAt: nowISO()}, {merge:true});
        } else if (op.type === 'restore') {
          await db.collection('surveys').doc(op.id).set({isDeleted:false, deletedAt: firebase.firestore.FieldValue.delete()}, {merge:true});
        } else if (op.type === 'permanent_delete') {
          await db.collection('surveys').doc(op.id).delete();
        }
        // remove op from local outbox on success
        const idx = this.outbox.findIndex(o => o._opId === op._opId);
        if (idx>=0) this.outbox.splice(idx,1);
        saveLocal(OUTBOX_KEY, this.outbox);
      } catch (e) {
        console.error('Flush op failed, will retry later', e);
        // stop flush to avoid repeated errors
        return;
      }
    }
  }
}
const syncEngine = new SyncEngine();

/** Data Layer that prefers live Firebase when online, else localStorage. */
const DataLayer = {
  async initSync(onChangeCallback) {
    // subscribe to firebase collection if online
    if (navigator.onLine) {
      try {
        this.unsubscribe = db.collection('surveys').onSnapshot(snapshot => {
          const arr = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;
            arr.push(d);
          });
          // save local copy
          saveLocal(LOCAL_KEY, arr);
          onChangeCallback(arr);
        });
        syncEngine.flush();
        return;
      } catch (e) {
        console.warn('Firebase subscribe failed, falling back to local', e);
      }
    }
    // fallback: load local
    const local = loadLocal(LOCAL_KEY, []);
    onChangeCallback(local);
  },
  async createSurvey(payload) {
    // create locally first
    const id = payload.id || uid();
    payload.id = id;
    payload.createdAt = payload.createdAt || nowISO();
    // update local storage
    const local = loadLocal(LOCAL_KEY, []);
    local.unshift(payload);
    saveLocal(LOCAL_KEY, local);
    // enqueue to outbox + attempt to flush
    syncEngine.enqueue({...payload, type:'create', id, _opId: uid(), payload});
    if (navigator.onLine) syncEngine.flush();
    return id;
  },
  async updateSurvey(id, payload) {
    payload.updatedAt = nowISO();
    const local = loadLocal(LOCAL_KEY, []).map(s => s.id===id ? {...s,...payload} : s);
    saveLocal(LOCAL_KEY, local);
    syncEngine.enqueue({_opId: uid(), type:'update', id, payload});
    if (navigator.onLine) syncEngine.flush();
  },
  async softDelete(id) {
    const local = loadLocal(LOCAL_KEY, []).map(s => s.id===id ? {...s, isDeleted:true, deletedAt: nowISO()} : s);
    saveLocal(LOCAL_KEY, local);
    syncEngine.enqueue({_opId: uid(), type:'delete', id, payload:{isDeleted:true}});
    if (navigator.onLine) syncEngine.flush();
  },
  async restore(id) {
    const local = loadLocal(LOCAL_KEY, []).map(s => s.id===id ? {...s, isDeleted:false, deletedAt: null} : s);
    saveLocal(LOCAL_KEY, local);
    syncEngine.enqueue({_opId: uid(), type:'restore', id, payload:{isDeleted:false}});
    if (navigator.onLine) syncEngine.flush();
  },
  async permanentDelete(id) {
    const local = loadLocal(LOCAL_KEY, []).filter(s => s.id!==id);
    saveLocal(LOCAL_KEY, local);
    syncEngine.enqueue({_opId: uid(), type:'permanent_delete', id});
    if (navigator.onLine) syncEngine.flush();
  },
  getLocalAll() { return loadLocal(LOCAL_KEY, []); }
};

/** Basic PDF Export using jsPDF */
async function exportSurveyToPDF(survey, logoBase64=null) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  // Always white background
  doc.setFillColor(255,255,255);
  doc.rect(0,0,595.28,841.89,'F');

  // Header
  if (logoBase64) {
    doc.addImage(logoBase64, 'PNG', 40, 30, 80, 40);
  }
  doc.setFontSize(18);
  doc.text('VELLORA REPORT', 500, 50, {align:'right'});

  doc.setFontSize(12);
  doc.text(`Business: ${survey.businessName || ''}`, 40, 100);
  doc.text(`Type: ${survey.businessType || ''}`, 40, 118);
  doc.text(`Area: ${survey.location?.areaName || ''}`, 40, 136);
  doc.text(`Date: ${new Date(survey.createdAt||'').toLocaleString()}`, 40, 154);

  // Pricing Matrix table
  const tableRows = [];
  if (survey.pricingMatrix) {
    survey.pricingMatrix.forEach(r=>{
      tableRows.push([r.brand || '', r.size || '', r.buyingPrice||'', r.sellingPrice||'', ( (r.sellingPrice||0)-(r.buyingPrice||0) ) ]);
    });
  }
  doc.autoTable({
    head: [['Brand','Size','Buy','Sell','Profit']],
    body: tableRows,
    startY: 180
  });

  doc.text('Supply Chain:', 40, doc.lastAutoTable.finalY + 24 || 260);
  let y = doc.lastAutoTable.finalY + 40 || 290;
  if (survey.supplyChain) {
    survey.supplyChain.forEach(s => {
      doc.text(`${s.brand} ‚Äî ${s.sourceType} ‚Äî ${s.sourceName} ‚Äî ${s.sourcePhone} ‚Äî Sat: ${s.satisfaction}`, 40, y);
      y += 14;
    });
  }

  doc.text('Sales Pitch:', 40, y+10);
  y += 28;
  doc.text(`Interested in Switching Supplier: ${survey.pitch?.switchSupplier || ''}`, 40, y); y+=14;
  doc.text(`Target Price: ${survey.pitch?.targetPrice || ''}`, 40, y); y+=14;
  doc.text(`Key Factors: ${(survey.pitch?.keyFactors || []).join(', ')}`, 40, y); y+=14;
  doc.text(`Interested in Buying Vellora: ${survey.pitch?.interestedBuyVellora || ''}`, 40, y); y+=14;

  // Footer contact
  doc.text('Contact', 40, y+20);
  doc.text(`${survey.contact?.name || ''} ‚Äî ${survey.contact?.mobile || ''}`, 40, y+40);

  doc.save(`Vellora_Survey_${survey.businessName||survey.id||'report'}.pdf`);
}

/** Small helper: generate empty survey structure */
function emptySurvey() {
  return {
    id: uid(),
    businessName: '',
    businessType: '',
    footfall: '',
    location: { areaName:'', coords:'' },
    brands: [],
    sizes: [],
    qtyToggle: 'Monthly',
    quantity: 0,
    qtyMonthly: 0,
    pricingMatrix: [],
    supplyChain: [],
    credit: {received:false, amount:null, periodDays:null, interestRate:null},
    pitch: {},
    whiteLabel: {interested:false, purpose:'', willingToPay:0},
    contact: {name:'', mobile:''},
    createdAt: nowISO(),
    isDeleted: false
  };
}

/** Main App (React) */
const { useState, useEffect, useRef } = React;

function App(){
  const [theme, setTheme] = useState(loadLocal(SETTINGS_KEY, {theme:'dark', logo:null}).theme || 'dark');
  const [settings, setSettings] = useState(loadLocal(SETTINGS_KEY, {theme:'dark', logo:null}));
  const [surveys, setSurveys] = useState([]);
  const [page, setPage] = useState('list'); // list, analytics, settings, bin
  const [wizardOpen, setWizardOpen] = useState(false);
  const [editingSurvey, setEditingSurvey] = useState(null);
  const [detailView, setDetailView] = useState(null);
  const [recyclePin, setRecyclePin] = useState('');
  const [showRecycle, setShowRecycle] = useState(false);
  const [masterData, setMasterData] = useState(loadLocal(MASTERDATA_KEY, defaultMasterData));
  const [filter, setFilter] = useState({}); // simple chart filtering

  useEffect(()=>{
    document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');
    setSettings(prev => { const s={...prev, theme}; saveLocal(SETTINGS_KEY, s); return s;});
  }, [theme]);

  useEffect(()=>{
    // initialize DataLayer subscription
    DataLayer.initSync(arr => {
      setSurveys(arr);
    });
    // ensure outbox flush if online
    if (navigator.onLine) syncEngine.flush();
    // load masterdata
    const md = loadLocal(MASTERDATA_KEY, defaultMasterData);
    setMasterData(md);
  }, []);

  // Derived lists
  const visibleSurveys = surveys.filter(s => !s.isDeleted);

  // Start new survey
  function startSurvey() {
    const s = emptySurvey();
    setEditingSurvey(s);
    setWizardOpen(true);
  }

  function openDetail(s) { setDetailView(s); }

  async function saveSurvey(s) {
    // compute qtyMonthly
    const toSave = {...s};
    toSave.qtyMonthly = (s.qtyToggle === 'Daily') ? (Number(s.quantity || 0) * 30) : Number(s.quantity || 0);
    // compress pricingMatrix and supplyChain (basic validation)
    if (!toSave.id) toSave.id = uid();
    if (surveys.find(x=>x.id === toSave.id)) {
      await DataLayer.updateSurvey(toSave.id, toSave);
    } else {
      await DataLayer.createSurvey(toSave);
    }
    setWizardOpen(false);
    setEditingSurvey(null);
  }

  // Soft delete
  async function deleteSurvey(id) {
    if (!confirm('Soft delete this survey? It will be moved to Recycle Bin.')) return;
    await DataLayer.softDelete(id);
    setDetailView(null);
  }

  // Export visible surveys CSV/JSON/PDF bulk
  function exportJSON() {
    const data = visibleSurveys;
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='vellora_surveys.json'; a.click(); URL.revokeObjectURL(url);
  }
  function exportCSV() {
    const keys = ['id','businessName','businessType','location','qtyMonthly','createdAt'];
    const rows = visibleSurveys.map(s => keys.map(k => {
      if (k==='location') return `"${(s.location?.areaName||'')}"`;
      return `"${(s[k]||'').toString().replace(/"/g,'""')}"`;
    }).join(','));
    const csv = keys.join(',') + '\n' + rows.join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='vellora_surveys.csv'; a.click(); URL.revokeObjectURL(url);
  }
  async function exportBulkPDF() {
    // merge via single PDF with multiple pages. We'll export one-by-one to keep simple.
    for (const s of visibleSurveys) {
      await exportSurveyToPDF(s, settings.logo);
    }
  }

  // Settings: logo upload
  function onLogoUpload(file) {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result;
      const newSettings = {...settings, logo: base64};
      setSettings(newSettings); saveLocal(SETTINGS_KEY, newSettings);
    };
    reader.readAsDataURL(file);
  }

  // Recycle Bin PIN protect default "1234"
  function openBin() {
    const pin = prompt('Enter Recycle PIN (default 1234):');
    if (pin === null) return;
    if (pin === '' ) { alert('PIN required'); return; }
    if (pin === '1234') {
      setPage('bin');
    } else {
      alert('Incorrect PIN');
    }
  }

  // basic analytics (brands counts, business types)
  const brandCounts = {};
  visibleSurveys.forEach(s=>{
    (s.brands||[]).forEach(b=>{ brandCounts[b] = (brandCounts[b]||0)+1; });
  });
  const typeCounts = {};
  visibleSurveys.forEach(s=>{ typeCounts[s.businessType] = (typeCounts[s.businessType]||0)+1; });

  return (
    <div className="min-h-screen p-4" style={{background: 'var(--bg)'}}>
      {/* Header */}
      <header className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div style={{width:48,height:48,overflow:'hidden',borderRadius:8,background:'#fff'}} className="flex items-center justify-center">
            {settings.logo ? <img src={settings.logo} style={{width:48,height:48,objectFit:'cover'}} /> : <div className="text-sm font-bold" style={{color: theme==='dark' ? '#fff' : '#000'}}>VL</div>}
          </div>
          <div>
            <div style={{fontSize:18,fontWeight:800}} className={theme==='dark' ? 'brand-text-dark' : 'brand-text-light'}>VELLORA</div>
            <div className="muted text-xs">Market Survey ‚Äî v4.0</div>
          </div>
        </div>

        <div className="flex items-center gap-4">
          <div className="muted text-sm">Theme</div>
          <select value={theme} onChange={e=>setTheme(e.target.value)} className="input">
            <option value="dark">Obsidian</option>
            <option value="light">Light</option>
          </select>
          <button className="btn" onClick={()=>{ setPage('settings'); }}>Settings</button>
        </div>
      </header>

      {/* Main layout */}
      <main className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* Left: Navigation */}
        <nav className="col-span-1 card">
          <div className="flex flex-col gap-3">
            <button onClick={()=>setPage('analytics')} className={`btn ${page==='analytics'?'ring-2 ring-offset-2':''}`}>üìä Analytics</button>
            <button onClick={()=>setPage('list')} className={`btn ${page==='list'?'ring-2 ring-offset-2':''}`}>üè† Survey List</button>
            <button onClick={openBin} className="btn">‚öôÔ∏è Recycle Bin</button>
            <div className="mt-4">
              <div className="muted text-xs">Quick Actions</div>
              <div className="flex gap-2 mt-2">
                <button className="btn" onClick={startSurvey}>Start Survey</button>
                <button className="btn" onClick={exportCSV}>Export CSV</button>
                <button className="btn" onClick={exportJSON}>Export JSON</button>
              </div>
            </div>
            <div className="mt-4 muted text-xs">Status: {navigator.onLine ? 'Online' : 'Offline'}</div>
            <div className="mt-2 muted text-xs">Outbox: { (loadLocal(OUTBOX_KEY, [])||[]).length }</div>
          </div>
        </nav>

        {/* Middle: content */}
        <section className="col-span-2">
          {page==='list' && (
            <div className="card">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold">Survey List</h2>
                <div className="muted text-sm">{visibleSurveys.length} surveys</div>
              </div>
              <div className="grid grid-cols-1 gap-3">
                {visibleSurveys.map(s => (
                  <div key={s.id} className="card flex items-start justify-between">
                    <div>
                      <div className="font-bold">{s.businessName || 'Untitled'}</div>
                      <div className="muted text-sm">{s.location?.areaName || 'Area unknown'} ‚Äî {new Date(s.createdAt).toLocaleString()}</div>
                      <div className="mt-2 flex gap-2">
                        {s.pitch?.interestedBuyVellora === 'Yes' && <span className="px-2 py-1 text-xs bg-red-600 rounded">Hot Lead</span>}
                        {s.whiteLabel?.interested && <span className="px-2 py-1 text-xs bg-gray-600 rounded">White Label</span>}
                      </div>
                    </div>
                    <div className="flex flex-col gap-2">
                      <button className="btn" onClick={()=>openDetail(s)}>Open</button>
                      <button className="btn" onClick={()=>{ setEditingSurvey(s); setWizardOpen(true); }}>Edit</button>
                    </div>
                  </div>
                ))}
                {visibleSurveys.length===0 && <div className="muted">No surveys yet. Click Start Survey.</div>}
              </div>
            </div>
          )}

          {page==='analytics' && (
            <div className="card">
              <h2 className="text-lg font-bold mb-4">Analytics</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="card">
                  <h3 className="font-semibold">Brands (Bar)</h3>
                  <svg width="100%" height="180">
                    {Object.keys(brandCounts).length===0 && <text x="10" y="30" fill="var(--muted)">No data</text>}
                    {Object.entries(brandCounts).map(([k,v],i)=>{
                      const max = Math.max(...Object.values(brandCounts),1);
                      const height = (v/max)*120;
                      const x = 40 + i*70;
                      const y = 160 - height;
                      return <g key={k}>
                        <rect x={x} y={y} width={40} height={height} fill="rgba(255,255,255,0.12)" stroke="rgba(255,255,255,0.06)"></rect>
                        <text x={x+20} y={170} fontSize="10" textAnchor="middle">{k}</text>
                      </g>;
                    })}
                  </svg>
                </div>
                <div className="card">
                  <h3 className="font-semibold">Business Types (Pie)</h3>
                  <svg width="100%" height="200" viewBox="0 0 200 200">
                    {(() => {
                      const entries = Object.entries(typeCounts);
                      const total = entries.reduce((s,[k,v])=> s+v, 0) || 1;
                      let angle=0;
                      return entries.map(([k,v],i)=>{
                        const portion = v/total;
                        const next = angle + portion*360;
                        const large = portion>0.5?1:0;
                        // simple pie using arcs would be heavy‚Äîapprox with circles
                        const start = angle*Math.PI/180; const end = next*Math.PI/180;
                        const x1 = 100 + 80*Math.cos(start);
                        const y1 = 100 + 80*Math.sin(start);
                        const x2 = 100 + 80*Math.cos(end);
                        const y2 = 100 + 80*Math.sin(end);
                        const path = `M100,100 L${x1},${y1} A80,80 0 ${large} 1 ${x2},${y2} z`;
                        angle = next;
                        return <g key={k}>
                          <path d={path} fill={`rgba(${(i*70)%255},${(i*130)%255},${(i*200)%255},0.12)`} stroke="rgba(255,255,255,0.06)"></path>
                          <text x={140} y={40+i*16} fontSize="10">{k} ({v})</text>
                        </g>;
                      });
                    })()}
                  </svg>
                </div>
              </div>
            </div>
          )}

          {page==='settings' && (
            <div className="card">
              <h2 className="text-lg font-bold">Settings</h2>
              <div className="mt-4 grid grid-cols-1 gap-3">
                <div>
                  <label className="muted text-xs">Upload Logo (saved to local storage, used in header & PDF)</label>
                  <input type="file" accept="image/*" onChange={e=>onLogoUpload(e.target.files[0])} className="input mt-1" />
                </div>
                <div className="flex gap-2">
                  <button className="btn" onClick={exportCSV}>Export CSV</button>
                  <button className="btn" onClick={exportJSON}>Export JSON</button>
                  <button className="btn" onClick={exportBulkPDF}>Export PDF</button>
                </div>
                <div>
                  <button className="btn" onClick={() => { saveLocal(MASTERDATA_KEY, masterData); alert('Saved master data.'); }}>Save Master Data</button>
                </div>
              </div>
            </div>
          )}

          {page==='bin' && (
            <div className="card">
              <h2 className="text-lg font-bold">Recycle Bin</h2>
              <div className="muted text-sm mb-2">Deleted surveys (protected)</div>
              <div className="grid gap-3">
                {surveys.filter(s=>s.isDeleted).map(s=>(
                  <div className="card flex items-center justify-between" key={s.id}>
                    <div>
                      <div className="font-bold">{s.businessName}</div>
                      <div className="muted text-sm">{s.location?.areaName || ''}</div>
                    </div>
                    <div className="flex gap-2">
                      <button className="btn" onClick={()=>{ if(confirm('Restore?')) DataLayer.restore(s.id); }}>Restore</button>
                      <button className="btn" onClick={()=>{ if(confirm('Permanently delete?')) DataLayer.permanentDelete(s.id); }}>Delete Permanently</button>
                    </div>
                  </div>
                ))}
                {surveys.filter(s=>s.isDeleted).length===0 && <div className="muted">No deleted surveys.</div>}
              </div>
            </div>
          )}
        </section>
      </main>

      {/* FAB visible only on survey list page */}
      {page==='list' && (
        <button className="fab bg-blue-600 text-white" onClick={startSurvey} title="Start Survey">Ôºã</button>
      )}

      {/* Detail Modal */}
      {detailView && (
        <div className="modal-bg" onClick={()=>setDetailView(null)}>
          <div className="card w-full md:w-2/3" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-start">
              <div>
                <h3 className="font-bold">{detailView.businessName}</h3>
                <div className="muted text-sm">{detailView.location?.areaName}</div>
              </div>
              <div className="flex gap-2">
                <button className="btn" onClick={()=>{ setEditingSurvey(detailView); setWizardOpen(true); setDetailView(null); }}>Edit</button>
                <button className="btn" onClick={() => exportSurveyToPDF(detailView, settings.logo)}>PDF</button>
                <button className="btn" onClick={()=>{ window.location.href = `tel:${detailView.contact?.mobile || ''}` }}>Call</button>
                <button className="btn" onClick={()=>{ window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(detailView.location?.areaName||'')}`); }}>Map</button>
                <button className="btn" onClick={()=>deleteSurvey(detailView.id)}>Delete</button>
              </div>
            </div>

            {/* Read-only layout of all data */}
            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="card">
                <h4 className="font-semibold">Inventory & Pricing</h4>
                <div className="muted text-sm">Brands: {(detailView.brands||[]).join(', ')}</div>
                <div className="mt-2">
                  {(detailView.pricingMatrix||[]).map((r,i)=>(
                    <div key={i} className="flex justify-between">
                      <div>{r.brand} ‚Äî {r.size}</div>
                      <div>{r.buyingPrice} / {r.sellingPrice} (Profit: {(r.sellingPrice||0)-(r.buyingPrice||0)})</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="card">
                <h4 className="font-semibold">Supply Chain</h4>
                {(detailView.supplyChain||[]).map((sc,i)=>(
                  <div key={i}>
                    <div className="font-semibold">{sc.brand} ‚Äî {sc.sourceType}</div>
                    <div className="muted text-sm">{sc.sourceName} ‚Äî {sc.sourcePhone}</div>
                    <div className="muted text-sm">Satisfied: {sc.satisfaction}</div>
                    {sc.satisfaction === 'NO' && <div className="muted text-xs">Problems: {(sc.problems||[]).join(', ')}</div>}
                    <hr className="my-2" />
                  </div>
                ))}
              </div>
            </div>

            <div className="mt-4 flex justify-end">
              <button className="btn" onClick={()=>setDetailView(null)}>Close</button>
            </div>
          </div>
        </div>
      )}

      {/* Wizard Modal */}
      {wizardOpen && (
        <Wizard
          initial={editingSurvey || emptySurvey()}
          onCancel={()=>{ setWizardOpen(false); setEditingSurvey(null); }}
          onSave={async (s) => { await saveSurvey(s); }}
          masterData={masterData}
          onSaveMaster={(md)=>{ setMasterData(md); saveLocal(MASTERDATA_KEY, md); }}
        />
      )}

    </div>
  );
}

/** Wizard Component implementing Steps A-H exactly */
function Wizard({initial, onCancel, onSave, masterData, onSaveMaster}) {
  const [step, setStep] = useState(0);
  const [s, setS] = useState({...initial});
  const [brandOptions, setBrandOptions] = useState(masterData.brands || []);
  const [sizeOptions, setSizeOptions] = useState(masterData.sizes || []);
  const [typeOptions, setTypeOptions] = useState(masterData.types || []);
  const [errors, setErrors] = useState({});

  useEffect(()=>{ setS({...initial}); }, [initial]);

  function update(changes) { setS(prev => ({...prev,...changes})); }

  function next() {
    // minimal validation per step
    const e = {};
    if (step === 0) {
      if (!s.businessName) e.businessName='Required';
      if (!s.location?.areaName) e.areaName='Required';
      if (!s.contact?.mobile && step===7) {}
    }
    setErrors(e);
    if (Object.keys(e).length>0) return;
    setStep(step+1);
  }
  function prev() { setStep(Math.max(0, step-1)); }

  // helper: add other to master data
  function addMaster(type, val) {
    if (!val) return;
    const md = loadLocal(MASTERDATA_KEY, defaultMasterData);
    if (type === 'brand' && !md.brands.includes(val)) md.brands.push(val);
    if (type === 'size' && !md.sizes.includes(val)) md.sizes.push(val);
    if (type === 'type' && !md.types.includes(val)) md.types.push(val);
    saveLocal(MASTERDATA_KEY, md);
    onSaveMaster(md);
    setBrandOptions(md.brands); setSizeOptions(md.sizes); setTypeOptions(md.types);
  }

  // Pricing matrix generation when brands/sizes chosen
  useEffect(()=>{
    const brands = s.brands || [];
    const sizes = s.sizes || [];
    const matrix = [];
    brands.forEach(b=>{
      sizes.forEach(sz=>{
        const existing = (s.pricingMatrix||[]).find(r=>r.brand===b && r.size===sz) || {brand:b,size:sz,buyingPrice:0,sellingPrice:0};
        matrix.push(existing);
      });
    });
    setS(prev => ({...prev, pricingMatrix: matrix}));
  }, [s.brands?.join('|'), s.sizes?.join('|')]);

  // Supply chain loop per brand
  useEffect(()=>{
    const supply = s.supplyChain || [];
    const brands = s.brands || [];
    // ensure an entry for each brand
    const newSupply = brands.map(b=>{
      return supply.find(x=>x.brand===b) || {brand:b, sourceType:'Distributor', sourceName:'', sourcePhone:'', notes:'', satisfaction:'YES', problems:[]};
    });
    setS(prev=>({...prev, supplyChain: newSupply}));
  }, [s.brands?.join('|')]);

  function toggleArrayField(field, val) {
    const arr = new Set(s[field] || []);
    if (arr.has(val)) arr.delete(val); else arr.add(val);
    setS(prev => ({...prev, [field]: Array.from(arr)}));
  }

  function onQuantityChange(v) {
    const q = Number(v||0);
    const qtyMonthly = (s.qtyToggle === 'Daily') ? q*30 : q;
    setS(prev=>({...prev, quantity: q, qtyMonthly}));
  }

  function finalSave() {
    // minimal final validation: contact mobile
    if (!s.contact?.mobile) { alert('Contact mobile is required'); return; }
    onSave(s);
  }

  const stepTitles = ['Profile & Location','Inventory','Pricing Matrix','Supply Chain','Credit Line','Sales Pitch','White Label','Finalize Review'];
  return (
    <div className="modal-bg" style={{alignItems:'flex-start', paddingTop: '3rem'}}>
      <div className="card w-full max-w-4xl" onClick={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-bold">Survey Wizard ‚Äî Step {step+1}: {stepTitles[step]}</h3>
          <div className="flex gap-2">
            <button className="btn" onClick={onCancel}>Cancel</button>
            {step>0 && <button className="btn" onClick={prev}>Back</button>}
            {step < 7 && <button className="btn" onClick={next}>Next</button>}
            {step === 7 && <button className="btn" onClick={finalSave}>Save</button>}
          </div>
        </div>

        <div>
          {step===0 && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="muted text-xs">Business Name</label>
                <input className="input w-full mt-1" value={s.businessName} onChange={e=>update({businessName: e.target.value})} />
                {errors.businessName && <div className="text-xs text-red-400">{errors.businessName}</div>}

                <label className="muted text-xs mt-2">Type</label>
                <div className="flex flex-wrap gap-2 mt-1">
                  {typeOptions.map(t => <button key={t} className={`btn ${s.businessType===t ? 'ring-2' : ''}`} onClick={()=>update({businessType:t})}>{t}</button>)}
                  <input placeholder="Other type" className="input" onKeyDown={e=>{ if(e.key==='Enter'){ addMaster('type', e.target.value); update({businessType: e.target.value}); e.target.value=''; }}} />
                </div>

                <label className="muted text-xs mt-2">Footfall</label>
                <div className="flex gap-2 mt-1">
                  {['Low','Medium','High'].map(f=> <button key={f} className={`btn ${s.footfall===f ? 'ring-2' : ''}`} onClick={()=>update({footfall:f})}>{f}</button>)}
                </div>
              </div>

              <div>
                <label className="muted text-xs">Location ‚Äî Area</label>
                <div className="flex gap-2 mt-1">
                  <input className="input flex-1" value={s.location?.areaName||''} onChange={e=>update({location:{...s.location, areaName: e.target.value}})} />
                  <button className="btn" onClick={()=>{
                    // Try geolocation auto-fill
                    if (navigator.geolocation) {
                      navigator.geolocation.getCurrentPosition(pos=>{
                        update({location:{areaName:`Lat:${pos.coords.latitude.toFixed(4)}, Lon:${pos.coords.longitude.toFixed(4)}`, coords:`${pos.coords.latitude},${pos.coords.longitude}`}})
                      }, ()=>alert('Geolocation failed'));
                    } else alert('Geolocation not supported');
                  }}>Detect</button>
                </div>
                <label className="muted text-xs mt-2">Coordinates</label>
                <input className="input w-full mt-1" value={s.location?.coords||''} onChange={e=>update({location:{...s.location, coords: e.target.value}})} />
              </div>
            </div>
          )}

          {step===1 && (
            <div>
              <label className="muted text-xs">Brands</label>
              <div className="flex gap-2 flex-wrap mt-1">
                {brandOptions.map(b=> <button key={b} className={`btn ${ (s.brands||[]).includes(b) ? 'ring-2' : '' }`} onClick={()=>toggleArrayField('brands', b)}>{b}</button>)}
                <input placeholder="Add brand" className="input" onKeyDown={e=>{ if(e.key==='Enter'){ addMaster('brand', e.target.value); toggleArrayField('brands', e.target.value); e.target.value=''; }}} />
              </div>

              <label className="muted text-xs mt-2">Sizes</label>
              <div className="flex gap-2 flex-wrap mt-1">
                {sizeOptions.map(z=> <button key={z} className={`btn ${ (s.sizes||[]).includes(z) ? 'ring-2' : '' }`} onClick={()=>toggleArrayField('sizes', z)}>{z}</button>)}
                <input placeholder="Add size" className="input" onKeyDown={e=>{ if(e.key==='Enter'){ addMaster('size', e.target.value); toggleArrayField('sizes', e.target.value); e.target.value=''; }}} />
              </div>

              <div className="mt-4">
                <label className="muted text-xs">Quantity</label>
                <div className="flex gap-2 mt-1 items-center">
                  <div className="muted text-sm">Toggle</div>
                  <select value={s.qtyToggle} onChange={e=>setS(prev=>({...prev, qtyToggle: e.target.value}))} className="input">
                    <option>Daily</option>
                    <option>Monthly</option>
                  </select>
                  <input type="number" value={s.quantity||0} onChange={e=>onQuantityChange(e.target.value)} className="input" />
                  <div className="muted">Monthly qty: {s.qtyToggle==='Daily' ? (Number(s.quantity||0)*30) : (Number(s.quantity||0))}</div>
                </div>
              </div>
            </div>
          )}

          {step===2 && (
            <div>
              <h4 className="font-semibold">Pricing Matrix</h4>
              <div className="grid gap-2 mt-2">
                {(s.pricingMatrix||[]).map((r, i) => (
                  <div key={i} className="grid grid-cols-4 gap-2">
                    <div className="muted text-sm">{r.brand} ‚Äî {r.size}</div>
                    <input className="input" placeholder="Buying Price" value={r.buyingPrice||''} onChange={e=>{
                      const nm = [...(s.pricingMatrix||[])]; nm[i] = {...nm[i], buyingPrice: Number(e.target.value)}; setS(prev=>({...prev, pricingMatrix: nm}));
                    }} />
                    <input className="input" placeholder="Selling Price" value={r.sellingPrice||''} onChange={e=>{
                      const nm = [...(s.pricingMatrix||[])]; nm[i] = {...nm[i], sellingPrice: Number(e.target.value)}; setS(prev=>({...prev, pricingMatrix: nm}));
                    }} />
                    <div className="muted">Profit: {( (r.sellingPrice||0) - (r.buyingPrice||0) )}</div>
                  </div>
                ))}
                {(s.pricingMatrix||[]).length===0 && <div className="muted">No brands/sizes selected.</div>}
              </div>
            </div>
          )}

          {step===3 && (
            <div>
              <h4 className="font-semibold">Supply Chain ‚Äî Loop per Brand</h4>
              <div className="grid gap-3 mt-2">
                {(s.supplyChain||[]).map((sc,i)=>(
                  <div key={i} className="card">
                    <div className="font-semibold">{sc.brand}</div>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                      <select value={sc.sourceType} onChange={e=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], sourceType: e.target.value}; setS(prev=>({...prev, supplyChain:nm})); }} className="input">
                        {['Distributor','Wholesaler','Manufacturer','Direct Company','Other'].map(o=> <option key={o}>{o}</option>)}
                      </select>
                      <input className="input" placeholder="Source Name" value={sc.sourceName||''} onChange={e=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], sourceName:e.target.value}; setS(prev=>({...prev, supplyChain:nm})); }} />
                      <input className="input" placeholder="Mobile (required)" value={sc.sourcePhone||''} onChange={e=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], sourcePhone:e.target.value}; setS(prev=>({...prev, supplyChain:nm})); }} />
                      <input className="input" placeholder="Notes" value={sc.notes||''} onChange={e=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], notes:e.target.value}; setS(prev=>({...prev, supplyChain:nm})); }} />
                    </div>
                    <div className="mt-2">
                      <div className="muted text-xs">Satisfied?</div>
                      <div className="flex gap-2 mt-1">
                        <button className={`btn ${sc.satisfaction==='YES' ? 'ring-2' : ''}`} onClick={()=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], satisfaction:'YES', problems:[]}; setS(prev=>({...prev, supplyChain:nm})); }}>YES</button>
                        <button className={`btn ${sc.satisfaction==='NO' ? 'ring-2' : ''}`} onClick={()=>{ const nm=[...s.supplyChain]; nm[i] = {...nm[i], satisfaction:'NO'}; setS(prev=>({...prev, supplyChain:nm})); }}>NO</button>
                      </div>
                      {sc.satisfaction==='NO' && (
                        <div className="mt-2">
                          <div className="muted text-xs">Problems (multi-select)</div>
                          <div className="flex gap-2 mt-1">
                            {['Late','Rude','Price','Stock','Other'].map(p=> <button key={p} className={`btn ${ (sc.problems||[]).includes(p) ? 'ring-2' : '' }`} onClick={()=>{
                              const nm=[...s.supplyChain];
                              const row = {...nm[i]};
                              const set = new Set(row.problems || []);
                              if (set.has(p)) set.delete(p); else set.add(p);
                              row.problems = Array.from(set);
                              nm[i] = row;
                              setS(prev=>({...prev, supplyChain:nm}));
                            }}>{p}</button>)}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {step===4 && (
            <div>
              <h4 className="font-semibold">Credit Line</h4>
              <div className="flex gap-2 mt-2 items-center">
                <button className={`btn ${s.credit?.received ? 'ring-2':''}`} onClick={()=>setS(prev=>({...prev, credit:{...prev.credit, received:true}}))}>YES</button>
                <button className={`btn ${!s.credit?.received ? 'ring-2':''}`} onClick={()=>setS(prev=>({...prev, credit:{...prev.credit, received:false}}))}>NO</button>
              </div>
              {s.credit?.received && (
                <div className="grid grid-cols-3 gap-2 mt-2">
                  <input className="input" placeholder="Amount" value={s.credit?.amount||''} onChange={e=>setS(prev=>({...prev, credit:{...prev.credit, amount: Number(e.target.value)}}))} />
                  <input className="input" placeholder="Period (Days)" value={s.credit?.periodDays||''} onChange={e=>setS(prev=>({...prev, credit:{...prev.credit, periodDays: Number(e.target.value)}}))} />
                  <input className="input" placeholder="Interest Rate (%)" value={s.credit?.interestRate||''} onChange={e=>setS(prev=>({...prev, credit:{...prev.credit, interestRate: Number(e.target.value)}}))} />
                </div>
              )}
            </div>
          )}

          {step===5 && (
            <div>
              <h4 className="font-semibold">Sales Pitch</h4>
              <div className="grid gap-2 mt-2">
                <div>
                  <div className="muted text-xs">Interested in Switching Supplier?</div>
                  <div className="flex gap-2 mt-1">
                    {['Yes','No','Maybe'].map(o=> <button key={o} className={`btn ${s.pitch?.switchSupplier===o ? 'ring-2' : ''}`} onClick={()=>setS(prev=>({...prev, pitch:{...prev.pitch, switchSupplier:o}}))}>{o}</button>)}
                  </div>
                </div>
                <div>
                  <div className="muted text-xs">Target Price / Offer needed?</div>
                  <input className="input mt-1" value={s.pitch?.targetPrice||''} onChange={e=>setS(prev=>({...prev, pitch:{...prev.pitch, targetPrice:e.target.value}}))} />
                </div>
                <div>
                  <div className="muted text-xs">Key Factors</div>
                  <div className="flex gap-2 mt-1">
                    {['Price','Service','Credit','Stock'].map(k=><button key={k} className={`btn ${ (s.pitch?.keyFactors||[]).includes(k) ? 'ring-2':''}`} onClick={()=>{
                      const prev = new Set(s.pitch?.keyFactors || []);
                      if (prev.has(k)) prev.delete(k); else prev.add(k);
                      setS(x=>({...x, pitch:{...x.pitch, keyFactors:Array.from(prev)}}));
                    }}>{k}</button>)}
                  </div>
                </div>
                <div>
                  <div className="muted text-xs">Interested in Buying Vellora?</div>
                  <div className="flex gap-2 mt-1">
                    <button className={`btn ${s.pitch?.interestedBuyVellora==='Yes' ? 'ring-2':''}`} onClick={()=>setS(prev=>({...prev, pitch:{...prev.pitch, interestedBuyVellora:'Yes'}}))}>Yes</button>
                    <button className={`btn ${s.pitch?.interestedBuyVellora==='No' ? 'ring-2':''}`} onClick={()=>setS(prev=>({...prev, pitch:{...prev.pitch, interestedBuyVellora:'No'}}))}>No</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {step===6 && (
            <div>
              <h4 className="font-semibold">White Label</h4>
              <div className="flex gap-2 mt-1">
                <button className={`btn ${s.whiteLabel?.interested ? 'ring-2' : ''}`} onClick={()=>setS(prev=>({...prev, whiteLabel:{...prev.whiteLabel, interested:true}}))}>YES</button>
                <button className={`btn ${!s.whiteLabel?.interested ? 'ring-2' : ''}`} onClick={()=>setS(prev=>({...prev, whiteLabel:{...prev.whiteLabel, interested:false}}))}>NO</button>
              </div>
              {s.whiteLabel?.interested && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                  <select className="input" value={s.whiteLabel?.purpose||''} onChange={e=>setS(prev=>({...prev, whiteLabel:{...prev.whiteLabel, purpose: e.target.value}}))}>
                    <option value="">Purpose</option><option>Brand</option><option>Event</option><option>Resale</option>
                  </select>
                  <input className="input" placeholder="Willing to pay extra (‚Çπ)" value={s.whiteLabel?.willingToPay||0} onChange={e=>setS(prev=>({...prev, whiteLabel:{...prev.whiteLabel, willingToPay: Number(e.target.value)}}))} />
                </div>
              )}
            </div>
          )}

          {step===7 && (
            <div>
              <h4 className="font-semibold">Finalize ‚Äî Review</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                <div>
                  <label className="muted text-xs">Contact Name</label>
                  <input className="input mt-1" value={s.contact?.name||''} onChange={e=>setS(prev=>({...prev, contact:{...prev.contact, name: e.target.value}}))} />
                  <label className="muted text-xs mt-2">Contact Mobile</label>
                  <input className="input mt-1" value={s.contact?.mobile||''} onChange={e=>setS(prev=>({...prev, contact:{...prev.contact, mobile: e.target.value}}))} />
                </div>
                <div>
                  <div className="card">
                    <h5 className="font-semibold">Summary</h5>
                    <div className="muted text-xs">Business: {s.businessName}</div>
                    <div className="muted text-xs">Type: {s.businessType}</div>
                    <div className="muted text-xs">Area: {s.location?.areaName}</div>
                    <div className="muted text-xs">Brands: {(s.brands||[]).join(', ')}</div>
                    <div className="muted text-xs">Qty Monthly: {s.qtyToggle === 'Daily' ? (Number(s.quantity||0)*30) : s.quantity}</div>
                    <div className="muted text-xs">White Label: {s.whiteLabel?.interested ? 'Yes' : 'No'}</div>
                    <div className="muted text-xs">Pitch Interested: {s.pitch?.interestedBuyVellora}</div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}

/** Render */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
